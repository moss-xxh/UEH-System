<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>授权书</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

    <!-- Tailwind 配置 - 苹果风格 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0071e3',
                        secondary: '#1d1d1f',
                        tertiary: '#86868b',
                        light: '#f5f5f7',
                        success: '#34c759',
                        warning: '#ff9500',
                        danger: '#ff3b30',
                        border: '#d2d2d7',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    boxShadow: {
                        'apple': '0 2px 10px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.03)',
                        'apple-hover': '0 5px 15px rgba(0, 0, 0, 0.08), 0 2px 5px rgba(0, 0, 0, 0.05)',
                    }
                },
            }
        }
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .input-focus {
                @apply focus:ring-1 focus:ring-primary focus:border-primary focus:outline-none transition-all duration-200;
            }
            .btn-apple {
                @apply bg-primary text-white font-medium py-2.5 px-4 rounded-full shadow-sm transition-all duration-200 hover:bg-primary/90 active:bg-primary/80;
            }
            .btn-outline {
                @apply border border-primary text-primary font-medium py-2.5 px-4 rounded-full shadow-sm transition-all duration-200 hover:bg-primary/5 active:bg-primary/10;
            }
            .btn-outline-black {
                @apply border border-black text-black font-medium py-2.5 px-4 rounded-full shadow-sm transition-all duration-200 hover:bg-black/5 active:bg-black/10;
            }
            .btn-black {
                @apply bg-black text-white font-medium py-2.5 px-4 rounded-full shadow-sm transition-all duration-200 hover:bg-black/90 active:bg-black/80;
            }
            .input-apple {
                @apply w-full px-4 py-3 bg-light border border-border rounded-lg transition-all duration-200;
                &:focus {
                    @apply ring-1 ring-black border-black text-black outline-none;
                }
            }
            .input-with-icon {
                @apply pl-12;
            }
            .label-apple {
                @apply block text-sm font-medium text-secondary mb-2;
            }
            .card-apple {
                @apply bg-white/90 backdrop-blur-sm rounded-xl shadow-apple overflow-hidden transition-all duration-300 hover:shadow-apple-hover;
            }
        }
    </style>

    <style>
        /* 全局样式 */
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #f5f5f7 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
        }
        
        /* 背景装饰 */
        body::before,
        body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            z-index: -1;
            filter: blur(50px);
            opacity: 0.15;
        }
        
        body::before {
            width: 500px;
            height: 500px;
            background: #0071e3;
            top: -250px;
            right: -250px;
        }
        
        body::after {
            width: 600px;
            height: 600px;
            background: #34c759;
            bottom: -300px;
            left: -300px;
        }
        
        /* 签名板样式 */
        .signature-pad {
            border: 1px solid #d2d2d7;
            border-radius: 0.75rem;
            background-color: white;
            transition: all 0.2s ease;
        }
        .signature-pad:focus {
            outline: none;
            border-color: #0071e3;
        }
        
        /* 模态框动画 */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
        
        /* 按钮按下效果 */
        button:active {
            transform: scale(0.98);
        }
        
        /* 语言选择器样式 */
        .lang-selector {
            position: relative;
        }
        .lang-dropdown {
            display: none;
            position: absolute;
            right: 0;
            z-index: 10;
            margin-top: 0.5rem;
            min-width: 8rem;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .lang-dropdown.show {
            display: block;
        }
        
        /* 状态消息动画 */
        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .status-message {
            animation: fadeSlideIn 0.3s ease-out;
        }
        
        /* 滚动条样式 - 苹果风格 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="min-h-screen font-sans text-secondary flex flex-col">
    <!-- 头部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <img src="logo_副本.png" alt="Logo" class="h-8 max-w-[150px] object-contain">
            </div>
            <div class="flex items-center gap-3">
                <!-- 查询按钮 -->
                <button id="query-btn" class="flex items-center px-4 py-2 rounded-full bg-black text-white hover:bg-black/90 transition-colors">
                    <i class="fa fa-search mr-2"></i>
                    <span data-i18n="query_btn">查询</span>
                </button>
                <!-- 语言选择器 -->
                <div class="lang-selector">
                    <button id="lang-toggle-btn" class="flex items-center px-3 py-2 rounded-full bg-light hover:bg-gray-200 transition-colors">
                        <span id="current-lang" class="mr-1">中文</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </button>
                    <div id="lang-dropdown" class="lang-dropdown">
                        <button class="lang-option w-full text-left px-4 py-3 hover:bg-light transition-colors" data-lang="zh">
                            中文
                        </button>
                        <button class="lang-option w-full text-left px-4 py-3 hover:bg-light transition-colors" data-lang="en">
                            English
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-10 max-w-2xl flex-1" id="main-content">
        <!-- 状态消息 -->
        <div id="status-message" class="hidden mb-6 p-4 rounded-lg status-message"></div>

        <!-- 表单区域（默认显示） -->
        <div id="form-container" class="card-apple p-6 md:p-8">
            <h2 class="text-2xl font-semibold mb-8" data-i18n="form_title">授权书</h2>

            <form id="device-form" class="space-y-7">
                <!-- 逆变器品牌选择 -->
                <div class="space-y-2">
                    <label for="brand" class="label-apple" data-i18n="brand_label">品牌</label>
                    <div class="relative">
                        <select id="brand" name="brand" class="input-apple input-with-icon appearance-none pr-10">
                            <option value=""></option>
                            <option value="ipotisedge">ipotisedge</option>
                            <option value="foxess">FOX ESS</option>
                            <option value="weiheng">weiheng</option>
                        </select>
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-tertiary pointer-events-none">
                            <i class="fa fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- 账号 -->
                <div class="space-y-2">
                    <label for="user-account" class="label-apple" data-i18n="account_label">账号</label>
                    <div class="relative">
                        <input type="text" id="user-account" name="user-account" placeholder="请输入您的账号" class="input-apple input-with-icon">
                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary">
                            <i class="fa fa-user"></i>
                        </div>
                    </div>
                </div>

                <!-- 设备SN -->
                <div class="space-y-2">
                    <label for="device-sn" class="label-apple" data-i18n="sn_label">设备SN</label>
                    <div class="relative">
                        <input type="text" id="device-sn" name="device-sn" placeholder="请输入设备SN码" class="input-apple input-with-icon">
                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary">
                            <i class="fa fa-barcode"></i>
                        </div>
                        <button type="button" id="scan-sn-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-primary hover:text-primary/80 transition-colors">
                            <i class="fa fa-qrcode"></i>
                        </button>
                    </div>
                </div>

                <!-- 设备地址 -->
                <div class="space-y-2">
                    <label for="device-address" class="label-apple" data-i18n="address_label">设备地址</label>
                    <div class="relative">
                        <input type="text" id="device-address" name="device-address" 
                               placeholder="点击选择地址" 
                               class="input-apple input-with-icon pr-10 cursor-pointer" 
                               readonly>
                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary">
                            <i class="fa fa-map-marker"></i>
                        </div>
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-tertiary">
                            <i class="fa fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- 电表号 -->
                <div class="space-y-2">
                    <label for="meter-number" class="label-apple" data-i18n="meter_label">电表号</label>
                    <div class="relative">
                        <input type="text" id="meter-number" name="meter-number" placeholder="请输入电表号" class="input-apple input-with-icon">
                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary">
                            <i class="fa fa-tachometer"></i>
                        </div>
                    </div>
                </div>

                <!-- 签名区域 -->
                <div class="space-y-2">
                    <label class="label-apple" data-i18n="signature_label">签名确认</label>
                    <div class="flex flex-col gap-4">
                        <div class="w-full">
                            <canvas id="signature-pad" class="signature-pad w-full h-44"></canvas>
                            <div class="flex justify-between mt-3">
                                <button type="button" id="clear-signature-btn" class="text-sm text-tertiary hover:text-danger transition-colors" data-i18n="clear_signature">清除签名</button>
                                <span class="text-xs text-tertiary" data-i18n="signature_hint">请在上方区域签名</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 隐私协议 -->
                <div class="flex items-start space-x-3 mt-4">
                    <input type="checkbox" id="privacy-agreement" name="privacy-agreement" class="mt-1 h-5 w-5 text-black border-black rounded focus:ring-black" disabled>
                    <label for="privacy-agreement" class="text-sm text-tertiary">
                        <span data-i18n="privacy_text">我已阅读并同意</span>
                        <a href="#" class="text-primary hover:underline privacy-link" data-i18n="privacy_policy">《隐私政策》</a>
                        <span id="privacy-hint" class="text-xs text-warning block mt-1" data-i18n="privacy_hint">（请先阅读协议内容）</span>
                    </label>
                </div>

                <!-- 提交按钮 -->
                <div class="pt-6">
                    <button type="submit" id="submit-btn" class="btn-black w-full flex justify-center items-center gap-3">
                            <i class="fa fa-paper-plane"></i>
                            <span data-i18n="submit_form">提交表单</span>
                        </button>
                </div>
            </form>
        </div>

        <!-- 查询页面（初始隐藏） -->
        <div id="query-page" class="hidden">
            <div class="card-apple p-6 md:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold" data-i18n="query_title">查询授权书</h2>
                    <button id="back-btn" class="btn-outline-black px-4 py-2 flex items-center gap-2">
                        <i class="fa fa-arrow-left"></i>
                        <span data-i18n="back_btn">返回</span>
                    </button>
                </div>
                
                <div class="space-y-4 mb-6">
                    <!-- 逆变器品牌选择 -->
                    <div class="space-y-2">
                        <label for="query-brand" class="label-apple" data-i18n="brand_label">品牌</label>
                        <div class="relative">
                            <select id="query-brand" name="query-brand" class="input-apple input-with-icon appearance-none pr-10">
                                <option value=""></option>
                                <option value="ipotisedge">ipotisedge</option>
                                <option value="foxess">FOX ESS</option>
                                <option value="weiheng">weiheng</option>
                            </select>
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-tertiary pointer-events-none">
                                <i class="fa fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 账号输入 -->
                    <div class="space-y-2">
                        <label for="query-account-input" class="label-apple" data-i18n="account_label">账号</label>
                        <div class="relative">
                            <input type="text" id="query-account-input" placeholder="请输入账号" class="input-apple input-with-icon">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary">
                                <i class="fa fa-user"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 查询按钮（底部居中） -->
                <div class="pt-6">
                    <button id="do-query-btn" class="btn-black w-full flex justify-center items-center gap-3">
                        <i class="fa fa-search"></i>
                        <span data-i18n="do_query">查询</span>
                    </button>
                </div>
                
                <!-- 查询成功提示 -->
                <div id="query-success-message" class="hidden mt-6 p-4 bg-success/10 border border-success/30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-success/20 rounded-full flex items-center justify-center">
                            <i class="fa fa-check text-success text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-success" data-i18n="query_success">查询成功</p>
                            <p class="text-sm text-tertiary mt-1" data-i18n="query_success_hint">已找到相关授权信息</p>
                        </div>
                    </div>
                </div>
                
                <!-- 查询结果区域 -->
                <div id="query-result" class="hidden mt-4 p-4 bg-light rounded-lg">
                    <div id="query-result-content"></div>
                    <button id="edit-query-btn" class="btn-outline-black w-full mt-4 flex justify-center items-center gap-2">
                        <i class="fa fa-pencil"></i>
                        <span data-i18n="edit_query">编辑</span>
                    </button>
                </div>
                
                <!-- 无数据提示 -->
                <div id="no-data-message" class="hidden mt-6 p-4 bg-danger/10 border border-danger/30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-danger/20 rounded-full flex items-center justify-center">
                            <i class="fa fa-times text-danger text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-danger" data-i18n="query_failed">查询失败</p>
                            <p class="text-sm text-tertiary mt-1" data-i18n="no_data">暂未查询到该账号信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提交后信息展示区域（初始隐藏） -->
        <div id="submission-info" class="hidden card-apple mt-8 p-6 md:p-8">
            <h3 class="text-xl font-semibold mb-6" data-i18n="submission_title">提交信息</h3>
            <div class="space-y-5">
                <div class="flex justify-between items-center pb-3 border-b border-border">
                    <span class="text-tertiary" data-i18n="brand_label">品牌类型：</span>
                    <span id="display-brand" class="font-medium text-lg"></span>
                </div>
                <div class="flex justify-between items-center pb-3 border-b border-border">
                    <span class="text-tertiary" data-i18n="display_account">账号：</span>
                    <span id="display-account" class="font-medium text-lg"></span>
                </div>
                <div class="flex justify-between items-center pb-3 border-b border-border">
                    <span class="text-tertiary" data-i18n="sn_label">设备SN：</span>
                    <span id="display-sn" class="font-medium text-lg"></span>
                </div>
                <div class="flex justify-between items-start pb-3 border-b border-border">
                    <span class="text-tertiary" data-i18n="address_label">设备地址：</span>
                    <span id="display-address" class="font-medium text-lg text-right max-w-[60%]" style="word-break: break-all;"></span>
                </div>
                <div class="flex justify-between items-center pb-3 border-b border-border">
                    <span class="text-tertiary" data-i18n="meter_label">电表号：</span>
                    <span id="display-meter" class="font-medium text-lg"></span>
                </div>
                <div class="flex justify-between items-center pb-3 border-b border-border">
                    <span class="text-tertiary" data-i18n="submit_time">提交时间：</span>
                    <span id="display-submit-time" class="font-medium text-lg"></span>
                </div>
                <div class="flex justify-between items-center pb-3 border-b border-border">
                    <span class="text-tertiary" data-i18n="auth_status">授权状态：</span>
                    <span id="display-auth-status" class="font-medium text-lg"></span>
                </div>
                <div>
                    <span class="block text-tertiary mb-3" data-i18n="signature_label">签名确认：</span>
                    <div id="display-signature-container">
                        <!-- 签名将显示在这里 -->
                    </div>
                </div>
            </div>

            <!-- 修改按钮 -->
            <div class="mt-8">
                <button id="edit-btn" class="btn-outline-black w-full flex justify-center items-center gap-3">
                            <i class="fa fa-pencil"></i>
                            <span data-i18n="edit_info">修改信息</span>
                        </button>
            </div>
        </div>
    </main>

    <!-- 地址选择模态框 -->
    <div id="address-modal" class="fixed inset-0 bg-black/70 z-50 flex items-end md:items-center justify-center hidden">
        <div class="bg-white rounded-t-2xl md:rounded-2xl w-full md:max-w-lg max-h-[80vh] overflow-hidden transform transition-transform duration-300" id="address-modal-content">
            <!-- 模态框头部 -->
            <div class="sticky top-0 bg-white border-b border-border z-10">
                <div class="p-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold" data-i18n="select_address_title">选择地址</h3>
                    <button id="close-address-btn" class="text-tertiary hover:text-secondary transition-colors p-1">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <!-- 当前定位按钮 -->
                <div class="px-4 pb-3">
                    <button id="modal-location-btn" class="w-full flex items-center justify-between p-3 bg-primary/5 hover:bg-primary/10 rounded-lg transition-colors group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center group-hover:bg-primary/20 transition-colors">
                                <i class="fa fa-location-arrow text-primary"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-medium text-secondary" data-i18n="current_location">当前位置</p>
                                <p id="current-location-text" class="text-xs text-tertiary" data-i18n="click_to_locate">点击获取当前位置</p>
                            </div>
                        </div>
                        <i class="fa fa-chevron-right text-tertiary"></i>
                    </button>
                </div>
            </div>
            
            <!-- 地址列表 -->
            <div class="overflow-y-auto" style="max-height: calc(80vh - 180px);">
                <!-- 搜索框 -->
                <div class="p-4 border-b border-border">
                    <div class="relative">
                        <input type="text" id="address-search" 
                               placeholder="搜索地址" 
                               class="w-full px-10 py-2.5 bg-light rounded-lg">
                        <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary"></i>
                    </div>
                </div>
                
                <!-- 常用地址 -->
                <div class="p-4">
                    <p class="text-sm font-medium text-tertiary mb-3" data-i18n="popular_addresses">热门地址</p>
                    <div class="space-y-2" id="address-list-container">
                        <button class="address-item w-full text-left p-3 hover:bg-light rounded-lg transition-colors group" 
                                data-address="悉尼, 新南威尔士州, 澳大利亚">
                            <div class="flex items-start gap-3">
                                <i class="fa fa-map-marker text-tertiary mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary">悉尼</p>
                                    <p class="text-sm text-tertiary">新南威尔士州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item w-full text-left p-3 hover:bg-light rounded-lg transition-colors group" 
                                data-address="墨尔本, 维多利亚州, 澳大利亚">
                            <div class="flex items-start gap-3">
                                <i class="fa fa-map-marker text-tertiary mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary">墨尔本</p>
                                    <p class="text-sm text-tertiary">维多利亚州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item w-full text-left p-3 hover:bg-light rounded-lg transition-colors group" 
                                data-address="布里斯班, 昆士兰州, 澳大利亚">
                            <div class="flex items-start gap-3">
                                <i class="fa fa-map-marker text-tertiary mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary">布里斯班</p>
                                    <p class="text-sm text-tertiary">昆士兰州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item w-full text-left p-3 hover:bg-light rounded-lg transition-colors group" 
                                data-address="珀斯, 西澳大利亚州, 澳大利亚">
                            <div class="flex items-start gap-3">
                                <i class="fa fa-map-marker text-tertiary mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary">珀斯</p>
                                    <p class="text-sm text-tertiary">西澳大利亚州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item w-full text-left p-3 hover:bg-light rounded-lg transition-colors group" 
                                data-address="阿德莱德, 南澳大利亚州, 澳大利亚">
                            <div class="flex items-start gap-3">
                                <i class="fa fa-map-marker text-tertiary mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary">阿德莱德</p>
                                    <p class="text-sm text-tertiary">南澳大利亚州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item w-full text-left p-3 hover:bg-light rounded-lg transition-colors group" 
                                data-address="堪培拉, 首都领地, 澳大利亚">
                            <div class="flex items-start gap-3">
                                <i class="fa fa-map-marker text-tertiary mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary">堪培拉</p>
                                    <p class="text-sm text-tertiary">首都领地, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item w-full text-left p-3 hover:bg-light rounded-lg transition-colors group" 
                                data-address="黄金海岸, 昆士兰州, 澳大利亚">
                            <div class="flex items-start gap-3">
                                <i class="fa fa-map-marker text-tertiary mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary">黄金海岸</p>
                                    <p class="text-sm text-tertiary">昆士兰州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item w-full text-left p-3 hover:bg-light rounded-lg transition-colors group" 
                                data-address="达尔文, 北领地, 澳大利亚">
                            <div class="flex items-start gap-3">
                                <i class="fa fa-map-marker text-tertiary mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary">达尔文</p>
                                    <p class="text-sm text-tertiary">北领地, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- 手动输入 -->
                <div class="p-4 border-t border-border">
                    <p class="text-sm font-medium text-tertiary mb-3" data-i18n="manual_input">手动输入地址</p>
                    <div class="flex gap-2">
                        <input type="text" id="manual-address-input" 
                               placeholder="输入详细地址" 
                               class="flex-1 px-4 py-2.5 bg-light rounded-lg">
                        <button id="confirm-manual-address" class="btn-apple px-6">
                            <span data-i18n="confirm">确认</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 扫码模态框（初始隐藏） -->
    <div id="scan-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
            <div class="p-5 border-b border-border flex justify-between items-center">
                <h3 class="text-lg font-semibold" data-i18n="scan_title">扫描设备SN码</h3>
                <button id="close-scan-btn" class="text-tertiary hover:text-secondary transition-colors p-1">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div id="qr-reader" class="w-full h-64 md:h-96 mx-auto border border-border rounded-lg overflow-hidden"></div>
                <p class="text-center text-tertiary mt-4 text-sm" data-i18n="scan_hint">请将设备SN码二维码对准扫描框</p>
            </div>
        </div>
    </div>

    <!-- 隐私政策模态框（初始隐藏） -->
    <div id="privacy-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl w-full max-w-xl max-h-[90vh] overflow-hidden">
            <div class="p-5 border-b border-border flex justify-between items-center">
                <h3 class="text-lg font-semibold" data-i18n="privacy_title">隐私政策</h3>
                <button id="close-privacy-btn" class="text-tertiary hover:text-secondary transition-colors p-1">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5 overflow-y-auto max-h-[70vh]" id="privacy-content">
                <!-- 隐私政策内容 -->
                <p class="text-tertiary mb-4">本隐私政策描述了我们如何收集、使用、存储和保护您提供的信息。</p>
                <p class="text-tertiary mb-4">我们收集的信息仅用于设备管理和服务提供的目的，不会分享给第三方。</p>
                <p class="text-tertiary mb-4">您有权访问、更正或删除您的个人信息。如有疑问，请联系我们的客服团队。</p>
                <p class="text-tertiary mb-6">通过提交此表单，您确认您已阅读并同意我们的隐私政策。</p>
            </div>
            <div class="p-5 border-t border-border flex justify-center">
                <button id="privacy-read-btn" class="btn-black px-8 py-3">
                    <span data-i18n="privacy_read_btn">我已阅读</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 服务条款模态框（初始隐藏） -->
    <div id="terms-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl w-full max-w-xl max-h-[90vh] overflow-hidden">
            <div class="p-5 border-b border-border flex justify-between items-center">
                <h3 class="text-lg font-semibold" data-i18n="terms_title">服务条款</h3>
                <button id="close-terms-btn" class="text-tertiary hover:text-secondary transition-colors p-1">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5 overflow-y-auto max-h-[70vh]" id="terms-content">
                <!-- 服务条款内容 -->
                <p class="text-tertiary mb-4">感谢您使用我们的设备管理服务。请仔细阅读以下条款和条件。</p>
                <p class="text-tertiary mb-4">您同意提供准确、完整的设备信息，并在信息变更时及时更新。</p>
                <p class="text-tertiary mb-4">您授权我们收集和处理您的设备数据，以提供更好的服务和支持。</p>
                <p class="text-tertiary">如有违反服务条款，我们保留暂停或终止服务的权利。</p>
            </div>
        </div>
    </div>


    </main>
    
    <!-- 页脚 -->
    <footer class="bg-white py-6 mt-auto border-t border-border">
        <div class="container mx-auto px-4 text-center text-tertiary text-sm">
            <p>&copy; 2023 授权管理系统 版权所有</p>
        </div>
    </footer>

    <!-- 扫码功能替代实现 -->
    <script>
        // 由于CDN限制，我们提供一个简化的扫码功能提示
        function Html5Qrcode(elementId) {
            this.elementId = elementId;
            this.isScanning = false;
        }
        
        Html5Qrcode.prototype.start = function(facingMode, config, onScanSuccess) {
            this.isScanning = true;
            const element = document.getElementById(this.elementId);
            element.innerHTML = `
                <div class="w-full h-full flex flex-col items-center justify-center bg-light">
                    <i class="fa fa-camera text-6xl text-tertiary mb-5"></i>
                    <p class="text-tertiary text-center">扫码功能需要摄像头权限</p>
                    <p class="text-tertiary text-center mt-2">请手动输入设备SN码</p>
                    <button id="manual-input-btn" class="mt-5 px-4 py-2.5 bg-primary text-white rounded-full shadow-sm hover:bg-primary/90 transition-colors">
                        手动输入
                    </button>
                </div>
            `;
            
            document.getElementById('manual-input-btn').addEventListener('click', function() {
                const scanModal = document.getElementById('scan-modal');
                scanModal.classList.add('hidden');
            });
        };
        
        Html5Qrcode.prototype.stop = function() {
            this.isScanning = false;
            return Promise.resolve();
        };
    </script>

    <script>
        // 语言翻译数据
        const translations = {
            en: {
                form_title: 'Authorization Letter',
                brand_label: 'Brand',
                select_option: 'Select Inverter Brand',
                other_option: 'Other',
                sn_label: 'Device SN',
                meter_label: 'NMI',
                signature_label: 'Signature Confirmation',
                clear_signature: 'Clear Signature',
                signature_hint: 'Please sign in the area above',
                privacy_text: 'I have read and agree to',
                privacy_policy: 'Privacy Policy',
                terms_of_service: 'Terms of Service',
                and: 'and',
                privacy_hint: '(Please read the agreement first)',
                privacy_scroll_hint: 'Please scroll to bottom to enable checkbox',
                submit_form: 'Submit Form',
                submission_title: 'Submitted Information',
                edit_info: 'Edit Information',
                scan_title: 'Scan Device SN',
                scan_hint: 'Please align the device SN QR code with the scanning frame',
                privacy_title: 'Privacy Policy',
                privacy_read_btn: 'I Have Read',
                terms_title: 'Terms of Service',
                status_success: 'Form submitted successfully!',
                status_error: 'Please fill in all required fields and sign',
                status_required: 'This field is required',
                current_lang: 'English',
                success_message: 'Successfully submitted device information!',
                edit_message: 'You can edit the information now.',
                address_label: 'Device Address',
                select_address: 'Click to select address',
                select_address_title: 'Select Address',
                current_location: 'Current Location',
                click_to_locate: 'Click to get current location',
                popular_addresses: 'Popular Addresses',
                manual_input: 'Enter address manually',
                confirm: 'Confirm',
                search_placeholder: 'Search address',
                getting_location: 'Getting location...',
                location_success: 'Location obtained successfully',
                location_error: 'Unable to get location',
                location_permission_denied: 'Location permission denied',
                location_unavailable: 'Location information unavailable',
                location_timeout: 'Location request timeout',
                account_label: 'Account',
                account_placeholder: 'Please enter your account',
                account_required: 'Please enter account',
                brand_required: 'Please select inverter brand',
                display_account: 'Account:',
                query_btn: 'Query',
                auth_status_label: 'Authorization Status',
                all_status: 'All',
                authorized: 'Authorized',
                unauthorized: 'Unauthorized',
                query_title: 'Query Authorization',
                back_btn: 'Back',
                query_account_label: 'Enter Account',
                do_query: 'Search',
                edit_query: 'Edit',
                no_data: 'No account information found',
                query_success: 'Query Successful',
                query_success_hint: 'Authorization information found',
                query_failed: 'Query Failed',
                new_auth: 'New',
                query_placeholder: 'Enter account to query',
                submit_time: 'Submit Time',
                auth_status: 'Authorization Status',
                authorized: 'Authorized',
                unauthorized: 'Unauthorized',
                authorizing: 'Authorizing',
            },
            zh: {
                form_title: '授权书',
                brand_label: '品牌',
                select_option: '请选择',
                other_option: '其他',
                sn_label: '设备SN',
                meter_label: '电表号',
                signature_label: '签名确认',
                clear_signature: '清除签名',
                signature_hint: '请在上方区域签名',
                privacy_text: '我已阅读并同意',
                privacy_policy: '《隐私政策》',
                terms_of_service: '《服务条款》',
                and: '和',
                privacy_hint: '（请先阅读协议内容）',
                privacy_scroll_hint: '请滚动到底部以启用复选框',
                submit_form: '提交表单',
                submission_title: '提交信息',
                edit_info: '修改信息',
                scan_title: '扫描设备SN码',
                scan_hint: '请将设备SN码二维码对准扫描框',
                privacy_title: '隐私政策',
                privacy_read_btn: '我已阅读',
                terms_title: '服务条款',
                status_success: '表单提交成功！',
                status_error: '请填写所有必填字段并签名',
                address_label: '设备地址',
                select_address: '点击选择地址',
                select_address_title: '选择地址',
                current_location: '当前位置',
                click_to_locate: '点击获取当前位置',
                popular_addresses: '热门地址',
                manual_input: '手动输入地址',
                confirm: '确认',
                search_placeholder: '搜索地址',
                getting_location: '正在获取位置...',
                location_success: '位置获取成功',
                location_error: '无法获取位置',
                location_permission_denied: '位置权限被拒绝',
                location_unavailable: '位置信息不可用',
                location_timeout: '获取位置超时',
                status_required: '此字段为必填项',
                current_lang: '中文',
                success_message: '设备信息提交成功！',
                edit_message: '您现在可以修改信息。',
                account_label: '账号',
                account_placeholder: '请输入您的账号',
                account_required: '请输入账号',
                brand_required: '请选择品牌',
                display_account: '账号：',
                query_btn: '查询',
                auth_status_label: '授权状态',
                all_status: '全部',
                authorized: '已授权',
                unauthorized: '未授权',
                authorizing: '授权中',
                query_title: '查询授权书',
                back_btn: '返回',
                query_account_label: '请输入账号',
                do_query: '查询',
                edit_query: '编辑',
                no_data: '暂未查询到该账号信息',
                query_success: '查询成功',
                query_success_hint: '已找到相关授权信息',
                query_failed: '查询失败',
                new_auth: '新建',
                query_placeholder: '输入账号进行查询',
                submit_time: '提交时间',
                auth_status: '授权状态',
                authorized: '已授权',
                unauthorized: '未授权',
                authorizing: '授权中',
            }
        };

        // 当前语言设置
        let currentLang = 'zh';
        
        // 先定义更新地址选项显示语言的函数
        function updateAddressOptions(lang) {
            // 更新地址列表中的地址项
            const addressItems = document.querySelectorAll('.address-item');
            
            if (lang === 'en') {
                // 英文地址
                const enAddresses = [
                    { value: 'Sydney, NSW, Australia', display: 'Sydney', subtitle: 'New South Wales, Australia' },
                    { value: 'Melbourne, VIC, Australia', display: 'Melbourne', subtitle: 'Victoria, Australia' },
                    { value: 'Brisbane, QLD, Australia', display: 'Brisbane', subtitle: 'Queensland, Australia' },
                    { value: 'Perth, WA, Australia', display: 'Perth', subtitle: 'Western Australia, Australia' },
                    { value: 'Adelaide, SA, Australia', display: 'Adelaide', subtitle: 'South Australia, Australia' },
                    { value: 'Canberra, ACT, Australia', display: 'Canberra', subtitle: 'Australian Capital Territory, Australia' },
                    { value: 'Gold Coast, QLD, Australia', display: 'Gold Coast', subtitle: 'Queensland, Australia' },
                    { value: 'Darwin, NT, Australia', display: 'Darwin', subtitle: 'Northern Territory, Australia' }
                ];
                
                // 更新地址项
                addressItems.forEach((item, index) => {
                    if (index < enAddresses.length) {
                        item.dataset.address = enAddresses[index].value;
                        const titleEl = item.querySelector('.font-medium');
                        const subtitleEl = item.querySelector('.text-sm.text-tertiary');
                        if (titleEl) titleEl.textContent = enAddresses[index].display;
                        if (subtitleEl) subtitleEl.textContent = enAddresses[index].subtitle;
                    }
                });
            } else {
                // 中文地址
                const zhAddresses = [
                    { value: '悉尼, 新南威尔士州, 澳大利亚', display: '悉尼', subtitle: '新南威尔士州, 澳大利亚' },
                    { value: '墨尔本, 维多利亚州, 澳大利亚', display: '墨尔本', subtitle: '维多利亚州, 澳大利亚' },
                    { value: '布里斯班, 昆士兰州, 澳大利亚', display: '布里斯班', subtitle: '昆士兰州, 澳大利亚' },
                    { value: '珀斯, 西澳大利亚州, 澳大利亚', display: '珀斯', subtitle: '西澳大利亚州, 澳大利亚' },
                    { value: '阿德莱德, 南澳大利亚州, 澳大利亚', display: '阿德莱德', subtitle: '南澳大利亚州, 澳大利亚' },
                    { value: '堪培拉, 首都领地, 澳大利亚', display: '堪培拉', subtitle: '首都领地, 澳大利亚' },
                    { value: '黄金海岸, 昆士兰州, 澳大利亚', display: '黄金海岸', subtitle: '昆士兰州, 澳大利亚' },
                    { value: '达尔文, 北领地, 澳大利亚', display: '达尔文', subtitle: '北领地, 澳大利亚' }
                ];
                
                // 更新地址项
                addressItems.forEach((item, index) => {
                    if (index < zhAddresses.length) {
                        item.dataset.address = zhAddresses[index].value;
                        const titleEl = item.querySelector('.font-medium');
                        const subtitleEl = item.querySelector('.text-sm.text-tertiary');
                        if (titleEl) titleEl.textContent = zhAddresses[index].display;
                        if (subtitleEl) subtitleEl.textContent = zhAddresses[index].subtitle;
                    }
                });
            }
        }

        // 语言切换函数
        function changeLanguage(lang) {
            if (translations[lang]) {
                currentLang = lang;
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                
                // 更新placeholder
                const placeholders = {
                    'user-account': lang === 'zh' ? '请输入您的账号' : 'Please enter your account',
                    'device-sn': lang === 'zh' ? '请输入设备SN码' : 'Please enter device SN',
                    'meter-number': lang === 'zh' ? '请输入电表号' : 'Please enter NMI',
                    'device-address': lang === 'zh' ? '点击选择地址' : 'Click to select address',
                    'address-search': lang === 'zh' ? '搜索地址' : 'Search address',
                    'manual-address-input': lang === 'zh' ? '输入详细地址' : 'Enter detailed address',
                    'query-account-input': lang === 'zh' ? '请输入账号' : 'Please enter account'
                };
                
                // 更新地址选项的显示
                updateAddressOptions(lang);
                
                Object.keys(placeholders).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.placeholder = placeholders[id];
                    }
                });
                
                document.getElementById('current-lang').textContent = translations[lang].current_lang;
                
                // 重新附加隐私政策链接事件
                setTimeout(() => {
                    if (typeof attachPrivacyLinks === 'function') {
                        attachPrivacyLinks();
                    }
                }, 10);
            }
        }
        
        // 全局声明attachPrivacyLinks函数
        let attachPrivacyLinks;

        // 初始化签名板
        let signaturePad;
        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            
            // 设置Canvas尺寸以适应显示
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext('2d').scale(ratio, ratio);
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // 初始化签名板 - 苹果风格配置
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 0, 0)',
                velocityFilterWeight: 0.7,
                minWidth: 1,
                maxWidth: 2.5
            });

            // 清除签名
            document.getElementById('clear-signature-btn').addEventListener('click', function() {
                signaturePad.clear();
            });
        }

        // 初始化扫码功能
        let html5Qrcode;
        function initScanner() {
            const scanModal = document.getElementById('scan-modal');
            const qrReader = document.getElementById('qr-reader');
            const closeScanBtn = document.getElementById('close-scan-btn');
            const scanSnBtn = document.getElementById('scan-sn-btn');
            const deviceSnInput = document.getElementById('device-sn');

            // 配置扫码成功回调
            const onScanSuccess = (decodedText, decodedResult) => {
                deviceSnInput.value = decodedText;
                scanModal.classList.add('hidden');
                if (html5Qrcode) {
                    html5Qrcode.stop().catch(err => {
                        console.log('Unable to stop scanning', err);
                    });
                }
                showStatusMessage(translations[currentLang].status_success, 'success');
            };

            // 打开扫码模态框
            scanSnBtn.addEventListener('click', function() {
                // 添加动画类
                scanModal.classList.remove('hidden');
                const modalContent = scanModal.querySelector('div');
                modalContent.classList.add('modal-enter');
                setTimeout(() => {
                    modalContent.classList.remove('modal-enter');
                    modalContent.classList.add('modal-enter-active');
                }, 10);
                
                // 尝试获取摄像头权限
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    // 清空之前的内容
                    qrReader.innerHTML = '<div class="w-full h-full flex items-center justify-center"><i class="fa fa-camera text-5xl text-border animate-pulse"></i></div>';
                    
                    // 检查是否支持扫码
                    try {
                        // 使用 Html5Qrcode
                        html5Qrcode = new Html5Qrcode("qr-reader");
                        
                        // 配置扫描选项
                        const config = {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        };
                        
                        // 开始扫描
                        html5Qrcode.start(
                            { facingMode: "environment" },
                            config,
                            onScanSuccess
                        ).catch(err => {
                            console.error('Error starting scanner:', err);
                            showStatusMessage('无法启动摄像头扫描功能', 'error');
                            scanModal.classList.add('hidden');
                        });
                    } catch (error) {
                        console.error('Scanner initialization error:', error);
                        showStatusMessage('您的设备不支持扫码功能', 'error');
                        scanModal.classList.add('hidden');
                    }
                } else {
                    showStatusMessage('您的浏览器不支持摄像头访问', 'error');
                    scanModal.classList.add('hidden');
                }
            });

            // 关闭扫码模态框
            closeScanBtn.addEventListener('click', function() {
                scanModal.classList.add('hidden');
                if (html5Qrcode) {
                    html5Qrcode.stop().catch(err => {
                        console.log('Unable to stop scanning', err);
                    });
                }
            });

            // 点击模态框外部关闭
            scanModal.addEventListener('click', function(e) {
                if (e.target === scanModal) {
                    scanModal.classList.add('hidden');
                    if (html5Qrcode) {
                        html5Qrcode.stop().catch(err => {
                            console.log('Unable to stop scanning', err);
                        });
                    }
                }
            });
        }

        // 初始化模态框
        function initModals() {
            // 隐私政策模态框
            const privacyModal = document.getElementById('privacy-modal');
            const closePrivacyBtn = document.getElementById('close-privacy-btn');
            
            // 服务条款模态框
            const termsModal = document.getElementById('terms-modal');
            const closeTermsBtn = document.getElementById('close-terms-btn');

            // 为隐私政策链接添加事件监听的函数
            attachPrivacyLinks = function() {
                // 隐私政策链接
                document.querySelectorAll('.privacy-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        privacyModal.classList.remove('hidden');
                        const modalContent = privacyModal.querySelector('div');
                        modalContent.classList.add('modal-enter');
                        setTimeout(() => {
                            modalContent.classList.remove('modal-enter');
                            modalContent.classList.add('modal-enter-active');
                        }, 10);
                        
                        // 重置滚动位置
                        setTimeout(() => {
                            const privacyContent = document.getElementById('privacy-content');
                            if (privacyContent) {
                                privacyContent.scrollTop = 0;
                            }
                        }, 100);
                    });
                });
            }
            
            // 初始附加链接
            attachPrivacyLinks();
            
            // 简化方案：打开隐私政策3秒后自动启用复选框
            let privacyViewed = false;
            
            // 监听隐私政策模态框打开
            document.querySelectorAll('.privacy-link').forEach(link => {
                link.addEventListener('click', function() {
                    if (!privacyViewed) {
                        // 3秒后自动启用复选框
                        setTimeout(() => {
                            privacyViewed = true;
                            const checkbox = document.getElementById('privacy-agreement');
                            const hint = document.getElementById('privacy-hint');
                            if (checkbox) {
                                checkbox.disabled = false;
                                checkbox.classList.remove('opacity-50');
                            }
                            if (hint) {
                                hint.classList.add('hidden');
                            }
                        }, 3000);
                    }
                });
            });
            

            // 关闭隐私政策模态框
            closePrivacyBtn.addEventListener('click', function() {
                privacyModal.classList.add('hidden');
                // 如果已经查看过，确保复选框启用
                if (privacyViewed) {
                    const checkbox = document.getElementById('privacy-agreement');
                    const hint = document.getElementById('privacy-hint');
                    if (checkbox) {
                        checkbox.disabled = false;
                        checkbox.classList.remove('opacity-50');
                    }
                    if (hint) {
                        hint.classList.add('hidden');
                    }
                }
            });
            
            // 我已阅读按钮
            const privacyReadBtn = document.getElementById('privacy-read-btn');
            privacyReadBtn.addEventListener('click', function() {
                // 标记为已查看
                privacyViewed = true;
                
                // 关闭模态框
                privacyModal.classList.add('hidden');
                
                // 启用复选框
                const checkbox = document.getElementById('privacy-agreement');
                const hint = document.getElementById('privacy-hint');
                if (checkbox) {
                    checkbox.disabled = false;
                    checkbox.classList.remove('opacity-50');
                    // 自动勾选复选框
                    checkbox.checked = true;
                }
                if (hint) {
                    hint.classList.add('hidden');
                }
            });

            // 关闭服务条款模态框
            closeTermsBtn.addEventListener('click', function() {
                termsModal.classList.add('hidden');
            });

            // 点击模态框外部关闭
            privacyModal.addEventListener('click', function(e) {
                if (e.target === privacyModal) {
                    privacyModal.classList.add('hidden');
                }
            });

            termsModal.addEventListener('click', function(e) {
                if (e.target === termsModal) {
                    termsModal.classList.add('hidden');
                }
            });
        }

        // 显示状态消息
        function showStatusMessage(message, type = 'info') {
            const statusMessage = document.getElementById('status-message');
            
            // 设置消息类型样式
            statusMessage.className = 'mb-6 p-4 rounded-lg status-message';
            if (type === 'success') {
                statusMessage.classList.add('bg-success/10', 'text-success', 'border', 'border-success/30');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-danger/10', 'text-danger', 'border', 'border-danger/30');
            } else {
                statusMessage.classList.add('bg-primary/10', 'text-primary', 'border', 'border-primary/30');
            }

            // 设置消息内容
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');

            // 3秒后自动隐藏
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        // 密码显示/隐藏功能（已移除）
        function initPasswordToggle() {
            // 功能已移除
        }

        // 表单提交处理
        function handleFormSubmit() {
            const form = document.getElementById('device-form');
            const formContainer = document.getElementById('form-container');
            const submissionInfo = document.getElementById('submission-info');
            const editBtn = document.getElementById('edit-btn');

            // 表单提交
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取表单数据（不做验证，直接提交）
                const userAccount = document.getElementById('user-account').value.trim();
                const brand = document.getElementById('brand').value;
                const deviceSn = document.getElementById('device-sn').value;
                const deviceAddress = document.getElementById('device-address').value;
                const meterNumber = document.getElementById('meter-number').value;
                const privacyAgreement = document.getElementById('privacy-agreement').checked;
                const hasSignature = !signaturePad.isEmpty();

                // 显示提交信息（空值显示--）
                document.getElementById('display-account').textContent = userAccount || '--';
                const brandSelect = document.getElementById('brand');
                const brandText = brand && brandSelect.selectedIndex > 0 ? brandSelect.options[brandSelect.selectedIndex].text : '--';
                document.getElementById('display-brand').textContent = brandText;
                document.getElementById('display-sn').textContent = deviceSn || '--';
                document.getElementById('display-address').textContent = deviceAddress || '--';
                document.getElementById('display-meter').textContent = meterNumber || '--';
                document.getElementById('display-submit-time').textContent = new Date().toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US');
                
                // 显示授权状态（随机生成用于演示）
                const isAuthorized = Math.random() > 0.3; // 70%概率显示已授权
                const authStatusElement = document.getElementById('display-auth-status');
                authStatusElement.textContent = isAuthorized ? 
                    (translations[currentLang].authorized || '已授权') : 
                    (translations[currentLang].unauthorized || '未授权');
                authStatusElement.className = isAuthorized ? 
                    'font-medium text-lg text-success' : 
                    'font-medium text-lg text-error';

                // 显示签名
                const displaySignatureContainer = document.getElementById('display-signature-container');
                displaySignatureContainer.innerHTML = ''; // 清空内容
                
                if (hasSignature) {
                    // 有签名：显示大容器和签名图片
                    const signatureDiv = document.createElement('div');
                    signatureDiv.className = 'border border-border rounded-lg p-3 bg-light';
                    
                    const signatureImage = document.createElement('img');
                    signatureImage.src = signaturePad.toDataURL('image/png');
                    signatureImage.className = 'w-full h-auto max-h-44 object-contain rounded-lg';
                    
                    signatureDiv.appendChild(signatureImage);
                    displaySignatureContainer.appendChild(signatureDiv);
                } else {
                    // 没有签名：显示小容器和--
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'border border-border rounded-lg bg-light h-12 flex items-center justify-center';
                    emptyDiv.innerHTML = '<span class="text-tertiary text-lg">--</span>';
                    displaySignatureContainer.appendChild(emptyDiv);
                }

                // 切换显示 - 添加过渡动画
                formContainer.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    formContainer.classList.add('hidden');
                    submissionInfo.classList.remove('hidden');
                    submissionInfo.classList.add('opacity-0');
                    setTimeout(() => {
                        submissionInfo.classList.remove('opacity-0');
                    }, 10);
                }, 300);
                showStatusMessage(translations[currentLang].success_message, 'success');
            });

            // 修改按钮点击事件
            editBtn.addEventListener('click', function() {
                // 恢复表单数据（跳过--值）
                const accountValue = document.getElementById('display-account').textContent;
                document.getElementById('user-account').value = accountValue === '--' ? '' : accountValue;
                
                // 选择品牌
                const brandText = document.getElementById('display-brand').textContent;
                const brandSelect = document.getElementById('brand');
                if (brandText === '--') {
                    brandSelect.selectedIndex = 0;
                } else {
                    for (let i = 0; i < brandSelect.options.length; i++) {
                        if (brandSelect.options[i].text === brandText) {
                            brandSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                const snValue = document.getElementById('display-sn').textContent;
                document.getElementById('device-sn').value = snValue === '--' ? '' : snValue;
                
                const addressValue = document.getElementById('display-address').textContent;
                document.getElementById('device-address').value = addressValue === '--' ? '' : addressValue;
                
                const meterValue = document.getElementById('display-meter').textContent;
                document.getElementById('meter-number').value = meterValue === '--' ? '' : meterValue;
                
                // 保持隐私协议勾选状态
                document.getElementById('privacy-agreement').checked = true;
                
                // 切换显示 - 添加过渡动画
                submissionInfo.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    submissionInfo.classList.add('hidden');
                    formContainer.classList.remove('hidden');
                    formContainer.classList.add('opacity-0');
                    setTimeout(() => {
                        formContainer.classList.remove('opacity-0');
                    }, 10);
                }, 300);
                showStatusMessage(translations[currentLang].edit_message, 'info');
            });
        }

        // 初始化语言选择器
        function initLanguageSelector() {
            const toggleBtn = document.getElementById('lang-toggle-btn');
            const dropdown = document.getElementById('lang-dropdown');
            
            // 点击按钮切换下拉菜单
            toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            });
            
            // 点击语言选项
            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const lang = this.getAttribute('data-lang');
                    changeLanguage(lang);
                    dropdown.classList.remove('show');
                });
            });
            
            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', function() {
                dropdown.classList.remove('show');
            });
        }
        
        // 初始化地址选择功能
        function initAddressSelection() {
            const addressInput = document.getElementById('device-address');
            const addressModal = document.getElementById('address-modal');
            const modalContent = document.getElementById('address-modal-content');
            const closeBtn = document.getElementById('close-address-btn');
            const modalLocationBtn = document.getElementById('modal-location-btn');
            const currentLocationText = document.getElementById('current-location-text');
            const addressSearch = document.getElementById('address-search');
            const manualInput = document.getElementById('manual-address-input');
            const confirmManualBtn = document.getElementById('confirm-manual-address');
            
            // 打开地址选择模态框
            addressInput.addEventListener('click', function() {
                addressModal.classList.remove('hidden');
                // 添加滑入动画
                setTimeout(() => {
                    modalContent.classList.add('translate-y-0');
                }, 10);
            });
            
            // 关闭模态框
            function closeAddressModal() {
                modalContent.classList.remove('translate-y-0');
                setTimeout(() => {
                    addressModal.classList.add('hidden');
                }, 300);
            }
            
            closeBtn.addEventListener('click', closeAddressModal);
            
            addressModal.addEventListener('click', function(e) {
                if (e.target === addressModal) {
                    closeAddressModal();
                }
            });
            
            // 选择地址项
            document.querySelectorAll('.address-item').forEach(item => {
                item.addEventListener('click', function() {
                    const address = this.dataset.address;
                    addressInput.value = address;
                    closeAddressModal();
                });
            });
            
            // 搜索地址
            addressSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                document.querySelectorAll('.address-item').forEach(item => {
                    const address = item.dataset.address.toLowerCase();
                    const text = item.textContent.toLowerCase();
                    if (address.includes(searchTerm) || text.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // 手动输入地址
            confirmManualBtn.addEventListener('click', function() {
                const address = manualInput.value.trim();
                if (address) {
                    addressInput.value = address;
                    manualInput.value = '';
                    closeAddressModal();
                }
            });
            
            // 在模态框中获取定位
            modalLocationBtn.addEventListener('click', function() {
                getLocationInModal();
            });
            
            // 获取定位（在模态框中）
            async function getLocationInModal() {
                const icon = modalLocationBtn.querySelector('.fa-location-arrow');
                icon.classList.add('fa-spin');
                currentLocationText.textContent = translations[currentLang].getting_location || '正在获取位置...';
                currentLocationText.classList.remove('text-success', 'text-danger');
                currentLocationText.classList.add('text-primary');
                
                if (!navigator.geolocation) {
                    await getLocationByIP();
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        try {
                            const address = await getAddressFromCoords(lat, lon);
                            addressInput.value = address;
                            currentLocationText.textContent = '已获取当前位置';
                            currentLocationText.classList.remove('text-primary', 'text-danger');
                            currentLocationText.classList.add('text-success');
                            
                            setTimeout(() => {
                                closeAddressModal();
                            }, 500);
                        } catch (error) {
                            const coordsText = `纬度: ${lat.toFixed(6)}, 经度: ${lon.toFixed(6)}`;
                            addressInput.value = coordsText;
                            currentLocationText.textContent = '已获取坐标';
                            currentLocationText.classList.add('text-success');
                            
                            setTimeout(() => {
                                closeAddressModal();
                            }, 500);
                        }
                        
                        icon.classList.remove('fa-spin');
                    },
                    async function(error) {
                        currentLocationText.textContent = translations[currentLang].location_error || '无法获取位置';
                        currentLocationText.classList.remove('text-primary', 'text-success');
                        currentLocationText.classList.add('text-danger');
                        icon.classList.remove('fa-spin');
                        
                        // 尝试IP定位
                        await getLocationByIP();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
            
            // 通过IP获取位置（保持原有功能）
            async function getLocationByIP() {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    if (data.city && data.country_name) {
                        const address = currentLang === 'zh' 
                            ? `${data.country_name} ${data.region} ${data.city}` 
                            : `${data.city}, ${data.region}, ${data.country_name}`;
                        
                        addressInput.value = address;
                        currentLocationText.textContent = '已获取大概位置';
                        currentLocationText.classList.remove('text-primary', 'text-danger');
                        currentLocationText.classList.add('text-success');
                        
                        setTimeout(() => {
                            closeAddressModal();
                        }, 500);
                    }
                } catch (error) {
                    console.error('IP location error:', error);
                    currentLocationText.textContent = '请手动选择或输入地址';
                    currentLocationText.classList.remove('text-primary', 'text-success');
                    currentLocationText.classList.add('text-warning');
                }
            }
            
            // 从坐标获取地址（保持原有功能）
            async function getAddressFromCoords(lat, lon) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=${currentLang}`,
                        {
                            headers: {
                                'User-Agent': 'AuthorizationForm/1.0'
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.display_name) {
                            return data.display_name;
                        }
                    }
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                }
                
                return `${currentLang === 'zh' ? '纬度' : 'Lat'}: ${lat.toFixed(6)}, ${currentLang === 'zh' ? '经度' : 'Lon'}: ${lon.toFixed(6)}`;
            }
        }
        
        // 初始化地理位置功能（现在为空函数，因为定位功能已整合到地址选择模态框中）
        function initGeolocation() {
            // 地理位置功能已经整合到 initAddressSelection 中的模态框里
            // 这个函数保留是为了兼容性，但不执行任何操作
        }
        
        // 初始化查询功能
        function initQueryFunction() {
            const queryBtn = document.getElementById('query-btn');
            const backBtn = document.getElementById('back-btn');
            const doQueryBtn = document.getElementById('do-query-btn');
            const queryAccountInput = document.getElementById('query-account-input');
            const queryBrandSelect = document.getElementById('query-brand');
            const queryResult = document.getElementById('query-result');
            const queryResultContent = document.getElementById('query-result-content');
            const editQueryBtn = document.getElementById('edit-query-btn');
            const noDataMessage = document.getElementById('no-data-message');
            const querySuccessMessage = document.getElementById('query-success-message');
            const queryPage = document.getElementById('query-page');
            const formContainer = document.getElementById('form-container');
            const submissionInfo = document.getElementById('submission-info');
            
            // 存储的数据（模拟数据库）
            let storedData = {};
            
            // 查询状态切换标志（用于演示）
            let queryToggle = false;
            
            // 点击查询按钮，切换到查询页面
            queryBtn.addEventListener('click', function() {
                formContainer.classList.add('hidden');
                submissionInfo.classList.add('hidden');
                queryPage.classList.remove('hidden');
                queryAccountInput.value = '';
                queryBrandSelect.value = '';
                queryResult.classList.add('hidden');
                noDataMessage.classList.add('hidden');
                querySuccessMessage.classList.add('hidden');
            });
            
            // 返回按钮
            backBtn.addEventListener('click', function() {
                queryPage.classList.add('hidden');
                formContainer.classList.remove('hidden');
            });
            
            // 执行查询
            doQueryBtn.addEventListener('click', function() {
                const account = queryAccountInput.value.trim();
                const brand = queryBrandSelect.value;
                
                if (!brand) {
                    showStatusMessage(translations[currentLang].brand_required || '请选择品牌', 'error');
                    return;
                }
                
                if (!account) {
                    showStatusMessage(translations[currentLang].account_required || '请输入账号', 'error');
                    return;
                }
                
                // 切换查询结果状态（用于演示）
                queryToggle = !queryToggle;
                
                if (queryToggle) {
                    // 模拟查询成功
                    const brandSelect = document.getElementById('query-brand');
                    const brandText = brandSelect.options[brandSelect.selectedIndex].text;
                    
                    // 模拟不同的授权状态
                    const isAuthorized = Math.random() > 0.3; // 70%概率已授权
                    
                    queryResultContent.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-tertiary">${translations[currentLang].brand_label || '品牌类型'}:</span>
                                <span class="font-medium">${brandText}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-tertiary">${translations[currentLang].account_label || '账号'}:</span>
                                <span class="font-medium">${account}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-tertiary">${translations[currentLang].sn_label || '设备SN'}:</span>
                                <span class="font-medium">SN2024${Math.floor(Math.random() * 10000)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-tertiary">${translations[currentLang].address_label || '设备地址'}:</span>
                                <span class="font-medium">${currentLang === 'zh' ? '悉尼, 新南威尔士州, 澳大利亚' : 'Sydney, NSW, Australia'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-tertiary">${translations[currentLang].meter_label || '电表号'}:</span>
                                <span class="font-medium">${Math.floor(Math.random() * 100000000)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-tertiary">${translations[currentLang].submit_time || '提交时间'}:</span>
                                <span class="font-medium">${new Date().toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-tertiary">${translations[currentLang].auth_status || '授权状态'}:</span>
                                <span class="font-medium text-success">${isAuthorized ? (translations[currentLang].authorized || '已授权') : (translations[currentLang].authorizing || '授权中')}</span>
                            </div>
                        </div>
                    `;
                    querySuccessMessage.classList.remove('hidden');
                    queryResult.classList.remove('hidden');
                    editQueryBtn.classList.remove('hidden');
                    noDataMessage.classList.add('hidden');
                    
                    // 编辑按钮功能
                    editQueryBtn.onclick = function() {
                        // 填充表单数据
                        document.getElementById('user-account').value = account;
                        document.getElementById('brand').value = brand;
                        document.getElementById('device-sn').value = 'SN2024' + Math.floor(Math.random() * 10000);
                        document.getElementById('device-address').value = currentLang === 'zh' ? '悉尼, 新南威尔士州, 澳大利亚' : 'Sydney, NSW, Australia';
                        document.getElementById('meter-number').value = Math.floor(Math.random() * 100000000).toString();
                        
                        // 返回表单页面
                        queryPage.classList.add('hidden');
                        formContainer.classList.remove('hidden');
                        submissionInfo.classList.add('hidden');
                        
                        showStatusMessage(translations[currentLang].edit_message || '您现在可以修改信息', 'info');
                    };
                } else {
                    // 模拟查询失败
                    queryResult.classList.add('hidden');
                    editQueryBtn.classList.add('hidden');
                    querySuccessMessage.classList.add('hidden');
                    noDataMessage.classList.remove('hidden');
                }
            });
            
            // 监听表单提交，保存数据用于查询
            document.getElementById('device-form').addEventListener('submit', function(e) {
                const userAccount = document.getElementById('user-account').value.trim();
                const brandValue = document.getElementById('brand').value;
                if (userAccount && brandValue) {
                    const brandSelect = document.getElementById('brand');
                    const queryKey = `${brandValue}_${userAccount}`;
                    storedData[queryKey] = {
                        brand: brandSelect.selectedIndex > 0 ? brandSelect.options[brandSelect.selectedIndex].text : '',
                        brandValue: brandValue,
                        deviceSn: document.getElementById('device-sn').value,
                        deviceAddress: document.getElementById('device-address').value,
                        meterNumber: document.getElementById('meter-number').value,
                        submitTime: new Date().toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US')
                    };
                }
            });
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initSignaturePad();
            initScanner();
            initModals();
            initPasswordToggle();
            initAddressSelection();
            initGeolocation();
            handleFormSubmit();
            initLanguageSelector();
            initQueryFunction();
        });
    </script>
</body>
</html>