<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模版详情 - 储能柜管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 页面布局 */
        .main-content {
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: 20px;
        }

        /* 页面头部 */
        .page-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* 模版信息卡片 */
        .template-info-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        [data-theme="dark"] .template-info-card {
            background: #1e293b;
        }

        .template-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .template-info-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .template-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* 消息通知设置 */
        .notification-settings-wrapper {
            margin-bottom: 20px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        [data-theme="dark"] .notification-settings-wrapper {
            background: #0f172a;
            border-color: #334155;
        }
        
        .notification-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .notification-options {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .checkbox-label {
            font-size: 14px;
            color: var(--text-primary);
            margin-left: 8px;
            user-select: none;
        }
        
        /* 模版名称输入框 */
        .template-name-input {
            width: 100%;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            background: white;
            transition: all 0.2s;
        }
        
        [data-theme="dark"] .template-name-input {
            background: #0f172a;
            border-color: #334155;
        }
        
        .template-name-input:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }
        
        /* 模版描述输入框 */
        .template-description-input {
            width: 100%;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            background: white;
            resize: vertical;
            min-height: 80px;
            transition: all 0.2s;
        }
        
        [data-theme="dark"] .template-description-input {
            background: #0f172a;
            border-color: #334155;
        }
        
        .template-description-input:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }

        .template-meta {
            display: flex;
            gap: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .template-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* 告警设置容器 */
        .alarm-settings-container {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        /* 左侧导航 */
        .alarm-nav {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        [data-theme="dark"] .alarm-nav {
            background: #1e293b;
        }

        .alarm-nav-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .alarm-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .alarm-nav-item:hover {
            background: #f3f4f6;
            color: var(--text-primary);
        }

        [data-theme="dark"] .alarm-nav-item:hover {
            background: #334155;
        }

        .alarm-nav-item.active {
            background: #eff6ff;
            color: #3562E3;
            font-weight: 500;
        }

        [data-theme="dark"] .alarm-nav-item.active {
            background: rgba(53, 98, 227, 0.1);
        }

        .alarm-nav-item i {
            width: 20px;
            text-align: center;
        }

        /* 右侧内容区 */
        .alarm-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .alarm-content {
            background: #1e293b;
        }

        .alarm-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .alarm-content-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* 告警参数表格 */
        .alarm-params-table {
            width: 100%;
            border-collapse: collapse;
        }

        .alarm-params-table th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        [data-theme="dark"] .alarm-params-table th {
            background: #0f172a;
            border-bottom-color: #334155;
        }

        .alarm-params-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        [data-theme="dark"] .alarm-params-table td {
            border-bottom-color: #334155;
        }

        .alarm-params-table tr:hover {
            background: #f9fafb;
        }

        [data-theme="dark"] .alarm-params-table tr:hover {
            background: #0f172a;
        }

        /* 参数输入框 */
        .param-input {
            width: 100px;
            height: 32px;
            padding: 0 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: var(--text-primary);
            text-align: center;
            transition: all 0.2s;
        }

        [data-theme="dark"] .param-input {
            background: #0f172a;
        }

        .param-input:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }

        /* 只读状态 */
        .param-input[readonly] {
            cursor: not-allowed;
            background: #f9fafb;
            color: #6b7280;
            border-color: #e5e7eb;
        }

        [data-theme="dark"] .param-input[readonly] {
            background: #0f172a;
            color: #9ca3af;
            border-color: #374151;
            opacity: 0.7;
        }

        /* 级别选择器 */
        .level-select {
            width: 80px;
            height: 32px;
            padding: 0 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        [data-theme="dark"] .level-select {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }
        
        .level-select:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }

        /* 勾选框组件 */
        .checkbox-wrapper {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .checkbox-custom {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            background: white;
            transition: all 0.2s;
        }
        
        [data-theme="dark"] .checkbox-custom {
            background: #1e293b;
            border-color: #4b5563;
        }
        
        .checkbox-custom i {
            color: white;
            font-size: 12px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom {
            background: #3562E3;
            border-color: #3562E3;
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom i {
            opacity: 1;
            transform: scale(1);
        }
        
        /* 禁用状态 */
        .checkbox-wrapper input[type="checkbox"]:disabled + .checkbox-custom {
            cursor: not-allowed;
            opacity: 0.5;
            background: #f9fafb;
        }
        
        .checkbox-wrapper input[type="checkbox"]:disabled:checked + .checkbox-custom {
            background: #93bbf8;
            border-color: #93bbf8;
        }
        
        [data-theme="dark"] .checkbox-wrapper input[type="checkbox"]:disabled + .checkbox-custom {
            background: #0f172a;
            opacity: 0.5;
        }
        
        /* 开关组件 - 保留给其他开关使用 */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: .4s;
            border-radius: 24px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .switch input:checked + .switch-slider {
            background-color: #3562E3;
        }

        .switch input:checked + .switch-slider:before {
            transform: translateX(24px);
        }

        /* 禁用状态 */
        .switch input:disabled + .switch-slider {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: #f3f4f6;
        }

        .switch input:disabled:checked + .switch-slider {
            background-color: #93bbf8;
            opacity: 0.5;
        }

        [data-theme="dark"] .switch input:disabled + .switch-slider {
            background-color: #1e293b;
            opacity: 0.5;
        }

        [data-theme="dark"] .switch input:disabled:checked + .switch-slider {
            background-color: #1e3a8a;
            opacity: 0.5;
        }

        /* 级别标签 */
        .level-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .level-badge.critical {
            background: #fee2e2;
            color: #dc2626;
        }

        .level-badge.major {
            background: #fef3c7;
            color: #d97706;
        }

        .level-badge.minor {
            background: #dbeafe;
            color: #2563eb;
        }

        [data-theme="dark"] .level-badge.critical {
            background: rgba(220, 38, 38, 0.2);
            color: #f87171;
        }

        [data-theme="dark"] .level-badge.major {
            background: rgba(217, 119, 6, 0.2);
            color: #fbbf24;
        }

        [data-theme="dark"] .level-badge.minor {
            background: rgba(37, 99, 235, 0.2);
            color: #60a5fa;
        }

        /* 操作按钮 */
        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
            align-items: center;
        }

        [data-theme="dark"] .action-buttons {
            border-top-color: #334155;
        }
        
        /* 取消按钮 - 小而精致 */
        .btn-cancel {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
        }
        
        .btn-cancel:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        [data-theme="dark"] .btn-cancel {
            color: #9ca3af;
        }
        
        [data-theme="dark"] .btn-cancel:hover {
            background: #374151;
            color: #e5e7eb;
        }
        
        .btn-cancel i {
            font-size: 14px;
        }
        
        /* 保存按钮 - 大而突出 */
        .btn-save {
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .btn-save:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);
        }
        
        .btn-save:active {
            transform: translateY(0);
        }
        
        .btn-save i {
            font-size: 18px;
        }

        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 40px;
            padding: 0 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            outline: none;
        }

        .btn-primary {
            background: #3562E3;
            color: white;
        }

        .btn-primary:hover {
            background: #2c51c9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(53, 98, 227, 0.25);
        }

        .btn-secondary {
            background: white;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: #f3f4f6;
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        [data-theme="dark"] .btn-secondary {
            background: #334155;
            color: #e2e8f0;
            border-color: #475569;
        }
        
        [data-theme="dark"] .btn-secondary:hover {
            background: #475569;
            border-color: var(--primary-color);
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .alarm-settings-container {
                grid-template-columns: 1fr;
            }

            .alarm-nav {
                position: static;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="header">
        <div class="header-left">
            <button class="menu-trigger" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <img src="logo.png" alt="AlwaysControl Technology" />
            </div>
        </div>
        
        <div class="header-right">
            <button class="theme-btn" onclick="toggleTheme()" title="切换主题">
                <i class="fas fa-moon" id="headerThemeIcon"></i>
            </button>
            <button class="lang-btn" onclick="toggleLanguage()" title="切换语言">
                <i class="fas fa-globe"></i>
            </button>
            <div class="notification-badge">
                <i class="fas fa-bell" style="font-size: 18px; color: var(--text-secondary);"></i>
            </div>
            <div class="user-menu" onclick="logout()">
                <div class="avatar">A</div>
                <span class="user-name" id="userName">管理员</span>
            </div>
        </div>
    </header>

    <!-- 侧边栏 -->
    <nav class="sidebar" id="sidebar">
        <div class="menu">
            <a href="dashboard.html" class="menu-item" data-menu="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span id="menuDashboard">仪表盘</span>
            </a>
            <a href="site1.html" class="menu-item" data-menu="site1">
                <i class="fas fa-building"></i>
                <span>站点管理</span>
            </a>
            <a href="devices.html" class="menu-item" data-menu="devices">
                <i class="fas fa-database"></i>
                <span id="menuDevices">设备管理</span>
            </a>
            <a href="alarm-management.html" class="menu-item" data-menu="alarm-management">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="menuAlarms">告警管理</span>
            </a>
            <a href="rule-engine.html" class="menu-item active" data-menu="rule-engine" style="display: none;">
                <i class="fas fa-code-branch"></i>
                <span>规则引擎</span>
            </a>
            <a href="system-management.html" class="menu-item" data-menu="system-management">
                <i class="fas fa-cogs"></i>
                <span id="menuSystem">系统管理</span>
            </a>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <main class="main-content" id="mainContent">
        <div class="page-header">
            <h1 class="page-title" style="display: flex; align-items: center;">
                <i class="fas fa-arrow-left" style="font-size: 20px; margin-right: 12px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s;" onclick="history.back()" onmouseover="this.style.color='#3562E3'" onmouseout="this.style.color='var(--text-secondary)'"></i>
                模版详情
            </h1>
            <div class="header-actions">
                <button class="btn btn-primary" id="editBtn" onclick="editTemplate()">
                    <i class="fas fa-edit"></i>
                    编辑
                </button>
            </div>
        </div>

        <!-- 模版信息卡片 -->
        <div class="template-info-card">
            <div class="template-info-header">
                <h2 class="template-info-title">
                    <span id="templateTitleText">标准模版</span>
                    <input type="text" id="templateTitleInput" class="template-name-input" value="标准模版" style="display: none;">
                </h2>
                <div class="template-status" style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 14px; color: var(--text-secondary);">状态：</span>
                    <label class="switch">
                        <input type="checkbox" id="templateStatus" checked disabled>
                        <span class="switch-slider"></span>
                    </label>
                    <span id="statusText" style="font-size: 14px; color: #10b981;">启用</span>
                </div>
            </div>
            <div class="notification-settings-wrapper">
                <div class="notification-label">消息通知：</div>
                <div class="notification-options" id="notificationOptions">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="notify_popup" checked disabled>
                        <span class="checkbox-custom">
                            <i class="fas fa-check"></i>
                        </span>
                        <span class="checkbox-label">消息弹窗</span>
                    </label>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="notify_email" checked disabled>
                        <span class="checkbox-custom">
                            <i class="fas fa-check"></i>
                        </span>
                        <span class="checkbox-label">邮箱</span>
                    </label>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="notify_message" disabled>
                        <span class="checkbox-custom">
                            <i class="fas fa-check"></i>
                        </span>
                        <span class="checkbox-label">站内信</span>
                    </label>
                </div>
            </div>
            <div class="template-meta">
                <div class="template-meta-item">
                    <i class="fas fa-clock"></i>
                    <span>创建时间：2024-01-15</span>
                </div>
                <div class="template-meta-item">
                    <i class="fas fa-user"></i>
                    <span>创建者：系统管理员</span>
                </div>
                <div class="template-meta-item">
                    <i class="fas fa-sync"></i>
                    <span>最后更新：2024-01-20</span>
                </div>
            </div>
        </div>

        <!-- 告警设置主体 -->
        <div class="alarm-settings-container">
            <!-- 左侧导航 -->
            <div class="alarm-nav">
                <div class="alarm-nav-title">告警类型</div>
                <div class="alarm-nav-item active" onclick="switchAlarmType('battery')">
                    <i class="fas fa-battery-three-quarters"></i>
                    <span>电池系统告警</span>
                </div>
                <div class="alarm-nav-item" onclick="switchAlarmType('pcs')">
                    <i class="fas fa-bolt"></i>
                    <span>PCS告警</span>
                </div>
                <div class="alarm-nav-item" onclick="switchAlarmType('bms')">
                    <i class="fas fa-microchip"></i>
                    <span>BMS告警</span>
                </div>
                <div class="alarm-nav-item" onclick="switchAlarmType('temperature')">
                    <i class="fas fa-thermometer-half"></i>
                    <span>温控系统告警</span>
                </div>
                <div class="alarm-nav-item" onclick="switchAlarmType('fire')">
                    <i class="fas fa-fire-extinguisher"></i>
                    <span>消防系统告警</span>
                </div>
                <div class="alarm-nav-item" onclick="switchAlarmType('power')">
                    <i class="fas fa-plug"></i>
                    <span>配电系统告警</span>
                </div>
                <div class="alarm-nav-item" onclick="switchAlarmType('communication')">
                    <i class="fas fa-wifi"></i>
                    <span>通信系统告警</span>
                </div>
            </div>

            <!-- 右侧内容区 -->
            <div class="alarm-content">
                <div class="alarm-content-header">
                    <h2 class="alarm-content-title" id="alarmTypeTitle">电池系统告警</h2>
                </div>

                <!-- 告警参数表格 -->
                <div id="alarmParamsContainer">
                    <!-- 告警参数动态生成 -->
                </div>

                <!-- 操作按钮 -->
                <div class="action-buttons" style="display: none;">
                    <button class="btn-cancel" onclick="cancelEdit()">
                        <i class="fas fa-times"></i>
                        取消
                    </button>
                    <button class="btn-save" onclick="saveTemplate()">
                        <i class="fas fa-save"></i>
                        保存
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 移动端遮罩 -->
    <div id="mobileOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;" onclick="closeMobileSidebar()"></div>

    <script src="common.js"></script>
    <script>
        // 检查登录状态
        checkAuth();
        
        // 设置当前页面菜单项
        setActiveMenuItem('rule-engine');

        // 告警参数数据
        const alarmData = {
            battery: {
                title: '电池系统告警',
                params: [
                    { id: 'bat_temp_high', name: '电池温度过高', threshold: 55, unit: '°C', level: 'critical', enabled: true },
                    { id: 'bat_temp_low', name: '电池温度过低', threshold: -10, unit: '°C', level: 'major', enabled: true },
                    { id: 'bat_voltage_high', name: '电池电压过高', threshold: 4.2, unit: 'V', level: 'critical', enabled: true },
                    { id: 'bat_voltage_low', name: '电池电压过低', threshold: 2.8, unit: 'V', level: 'critical', enabled: true },
                    { id: 'bat_current_high', name: '充放电电流过大', threshold: 200, unit: 'A', level: 'major', enabled: true },
                    { id: 'bat_soc_low', name: 'SOC过低', threshold: 10, unit: '%', level: 'minor', enabled: true },
                    { id: 'bat_soh_low', name: 'SOH异常', threshold: 80, unit: '%', level: 'major', enabled: true },
                    { id: 'bat_imbalance', name: '电池不均衡', threshold: 50, unit: 'mV', level: 'major', enabled: true }
                ]
            },
            pcs: {
                title: 'PCS告警',
                params: [
                    { id: 'pcs_temp_high', name: 'PCS温度过高', threshold: 65, unit: '°C', level: 'major', enabled: true },
                    { id: 'pcs_overload', name: 'PCS过载', threshold: 110, unit: '%', level: 'critical', enabled: true },
                    { id: 'pcs_fault', name: 'PCS故障', threshold: 1, unit: '', level: 'critical', enabled: true },
                    { id: 'pcs_offline', name: 'PCS离线', threshold: 5, unit: '分钟', level: 'major', enabled: true },
                    { id: 'pcs_efficiency_low', name: '转换效率低', threshold: 90, unit: '%', level: 'minor', enabled: true }
                ]
            },
            bms: {
                title: 'BMS告警',
                params: [
                    { id: 'bms_comm_fail', name: 'BMS通信故障', threshold: 3, unit: '次', level: 'critical', enabled: true },
                    { id: 'bms_sensor_fail', name: '传感器故障', threshold: 1, unit: '', level: 'major', enabled: true },
                    { id: 'bms_data_abnormal', name: '数据异常', threshold: 5, unit: '%', level: 'major', enabled: true },
                    { id: 'bms_version_mismatch', name: '版本不匹配', threshold: 1, unit: '', level: 'minor', enabled: true }
                ]
            },
            temperature: {
                title: '温控系统告警',
                params: [
                    { id: 'temp_env_high', name: '环境温度过高', threshold: 40, unit: '°C', level: 'major', enabled: true },
                    { id: 'temp_env_low', name: '环境温度过低', threshold: -5, unit: '°C', level: 'major', enabled: true },
                    { id: 'temp_hvac_fail', name: '空调故障', threshold: 1, unit: '', level: 'critical', enabled: true },
                    { id: 'temp_fan_fail', name: '风扇故障', threshold: 1, unit: '', level: 'major', enabled: true },
                    { id: 'temp_sensor_fail', name: '温度传感器故障', threshold: 1, unit: '', level: 'major', enabled: true }
                ]
            },
            fire: {
                title: '消防系统告警',
                params: [
                    { id: 'fire_smoke_detect', name: '烟雾检测', threshold: 1, unit: '', level: 'critical', enabled: true },
                    { id: 'fire_temp_detect', name: '火灾温度检测', threshold: 60, unit: '°C', level: 'critical', enabled: true },
                    { id: 'fire_system_fail', name: '消防系统故障', threshold: 1, unit: '', level: 'critical', enabled: true },
                    { id: 'fire_water_low', name: '消防水压低', threshold: 0.2, unit: 'MPa', level: 'major', enabled: true }
                ]
            },
            power: {
                title: '配电系统告警',
                params: [
                    { id: 'power_voltage_high', name: '电网电压过高', threshold: 253, unit: 'V', level: 'major', enabled: true },
                    { id: 'power_voltage_low', name: '电网电压过低', threshold: 187, unit: 'V', level: 'major', enabled: true },
                    { id: 'power_frequency_abnormal', name: '频率异常', threshold: 0.5, unit: 'Hz', level: 'major', enabled: true },
                    { id: 'power_phase_loss', name: '缺相', threshold: 1, unit: '', level: 'critical', enabled: true },
                    { id: 'power_ground_fault', name: '接地故障', threshold: 30, unit: 'mA', level: 'critical', enabled: true }
                ]
            },
            communication: {
                title: '通信系统告警',
                params: [
                    { id: 'comm_network_fail', name: '网络中断', threshold: 5, unit: '分钟', level: 'critical', enabled: true },
                    { id: 'comm_packet_loss', name: '丢包率高', threshold: 5, unit: '%', level: 'major', enabled: true },
                    { id: 'comm_delay_high', name: '通信延迟', threshold: 1000, unit: 'ms', level: 'minor', enabled: true },
                    { id: 'comm_device_offline', name: '设备离线', threshold: 10, unit: '分钟', level: 'major', enabled: true }
                ]
            }
        };

        let currentAlarmType = 'battery';

        // 页面初始化
        // 获取条件文本
        function getConditionText(param) {
            const conditionMap = {
                'bat_temp_high': '电池温度 > ',
                'bat_temp_low': '电池温度 < ',
                'bat_voltage_high': '电池电压 > ',
                'bat_voltage_low': '电池电压 < ',
                'bat_current_high': '充放电电流 > ',
                'bat_soc_low': 'SOC < ',
                'bat_soh_low': 'SOH < ',
                'bat_imbalance': '电池不均衡 > ',
                'pcs_temp_high': 'PCS温度 > ',
                'pcs_overload': 'PCS负载 > ',
                'pcs_fault': 'PCS故障 = ',
                'pcs_offline': 'PCS离线时长 > ',
                'pcs_efficiency_low': '转换效率 < ',
                'bms_comm_fail': 'BMS通信失败 > ',
                'bms_sensor_fail': '传感器故障 = ',
                'bms_data_abnormal': '数据异常 > ',
                'bms_version_mismatch': '版本不匹配 = ',
                'temp_env_high': '环境温度 > ',
                'temp_env_low': '环境温度 < ',
                'temp_hvac_fail': '空调故障 = ',
                'temp_fan_fail': '风扇故障 = ',
                'temp_sensor_fail': '温度传感器故障 = ',
                'fire_smoke_detect': '烟雾检测 = ',
                'fire_temp_detect': '火灾温度 > ',
                'fire_system_fail': '消防系统故障 = ',
                'fire_water_low': '消防水压 < ',
                'power_voltage_high': '电网电压 > ',
                'power_voltage_low': '电网电压 < ',
                'power_frequency_abnormal': '频率偏差 > ',
                'power_phase_loss': '缺相 = ',
                'power_ground_fault': '接地故障 > ',
                'comm_network_fail': '网络中断 > ',
                'comm_packet_loss': '丢包率 > ',
                'comm_delay_high': '通信延迟 > ',
                'comm_device_offline': '设备离线 > '
            };
            
            const prefix = conditionMap[param.id] || '数值 > ';
            return prefix + param.threshold + ' ' + param.unit;
        }
        
        function initPage() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const templateType = urlParams.get('type') || 'temperature';
            
            // 设置模版信息
            updateTemplateInfo(templateType);
            
            // 初始化告警参数
            renderAlarmParams(currentAlarmType);
            
            // 设置状态切换事件
            document.getElementById('templateStatus').addEventListener('change', function(e) {
                const statusText = document.getElementById('statusText');
                if (e.target.checked) {
                    statusText.textContent = '启用';
                    statusText.style.color = '#10b981';
                } else {
                    statusText.textContent = '禁用';
                    statusText.style.color = '#dc2626';
                }
            });
        }

        // 更新模版信息
        function updateTemplateInfo(templateType) {
            const templates = {
                temperature: {
                    name: '标准模版',
                    description: '实时监测设备温度，当温度超过设定阈值时触发告警并自动执行降温策略，保护设备安全运行。',
                    enabled: true
                },
                battery: {
                    name: '自定义模版 1',
                    description: '监测电池SOC、SOH等关键指标，智能预测电池寿命，提前发现潜在故障，优化充放电策略。',
                    enabled: true
                },
                pricing: {
                    name: '自定义模版 2',
                    description: '根据电价时段自动调整充放电策略，在电价低谷期充电，高峰期放电，最大化经济效益。',
                    enabled: false
                },
                safety: {
                    name: '自定义模版 3',
                    description: '多重安全保护机制，包括过流、过压、短路等异常检测，快速响应并执行保护动作。',
                    enabled: true
                },
                linkage: {
                    name: '自定义模版 4',
                    description: '配置多设备间的联动规则，实现设备协同工作，提高系统整体运行效率和可靠性。',
                    enabled: true
                },
                energy: {
                    name: '自定义模版 5',
                    description: '基于历史数据和实时负载分析，自动优化能源分配策略，降低运营成本，提高能效。',
                    enabled: false
                }
            };

            const template = templates[templateType] || templates.temperature;
            
            document.getElementById('templateTitleText').textContent = template.name;
            document.getElementById('templateTitleInput').value = template.name;
            document.getElementById('templateStatus').checked = template.enabled;
            document.getElementById('statusText').textContent = template.enabled ? '启用' : '禁用';
            document.getElementById('statusText').style.color = template.enabled ? '#10b981' : '#dc2626';
        }

        // 切换告警类型
        function switchAlarmType(type) {
            currentAlarmType = type;
            
            // 更新导航选中状态
            document.querySelectorAll('.alarm-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.alarm-nav-item').classList.add('active');
            
            // 更新内容
            renderAlarmParams(type);
        }

        // 渲染告警参数
        function renderAlarmParams(type) {
            const data = alarmData[type];
            document.getElementById('alarmTypeTitle').textContent = data.title;
            
            const container = document.getElementById('alarmParamsContainer');
            container.innerHTML = `
                <table class="alarm-params-table">
                    <thead>
                        <tr>
                            <th style="width: 60px; white-space: nowrap;">状态</th>
                            <th style="white-space: nowrap;">告警名称</th>
                            <th style="width: 120px; white-space: nowrap;">触发条件</th>
                            <th style="width: 100px; white-space: nowrap;">告警级别</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.params.map(param => `
                            <tr>
                                <td style="text-align: center;">
                                    <label class="checkbox-wrapper">
                                        <input type="checkbox" ${param.enabled ? 'checked' : ''} 
                                               id="${param.id}_enabled" disabled>
                                        <span class="checkbox-custom">
                                            <i class="fas fa-check"></i>
                                        </span>
                                    </label>
                                </td>
                                <td>${param.name}</td>
                                <td>
                                    <div style="font-size: 14px; color: var(--text-primary);">
                                        <span class="condition-text" id="${param.id}_condition_text">
                                            ${getConditionText(param)}
                                        </span>
                                        <div class="condition-edit" id="${param.id}_condition_edit" style="display: none;">
                                            <input type="number" class="param-input" value="${param.threshold}" 
                                                   id="${param.id}_threshold" readonly style="width: 70px; display: inline-block;">
                                            <span style="font-size: 14px; color: var(--text-secondary); margin-left: 4px;">${param.unit}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="level-badge ${param.level}" id="${param.id}_level_badge">
                                        ${param.level === 'critical' ? '严重' : param.level === 'major' ? '重要' : '一般'}
                                    </span>
                                    <select class="level-select" id="${param.id}_level_select" style="display: none;" data-value="${param.level}">
                                        <option value="critical" ${param.level === 'critical' ? 'selected' : ''}>严重</option>
                                        <option value="major" ${param.level === 'major' ? 'selected' : ''}>重要</option>
                                        <option value="minor" ${param.level === 'minor' ? 'selected' : ''}>一般</option>
                                    </select>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // 编辑模版
        function editTemplate() {
            // 显示输入框，隐藏文本
            document.getElementById('templateTitleText').style.display = 'none';
            document.getElementById('templateTitleInput').style.display = 'block';
            
            // 显示级别选择器，隐藏级别标签
            document.querySelectorAll('.level-badge').forEach(badge => {
                badge.style.display = 'none';
            });
            document.querySelectorAll('.level-select').forEach(select => {
                select.style.display = 'block';
            });
            
            // 显示条件编辑，隐藏条件文本
            document.querySelectorAll('.condition-text').forEach(text => {
                text.style.display = 'none';
            });
            document.querySelectorAll('.condition-edit').forEach(edit => {
                edit.style.display = 'flex';
            });
            
            // 启用所有输入框和选择器
            document.querySelectorAll('.param-input').forEach(input => {
                input.removeAttribute('readonly');
            });
            document.querySelectorAll('.switch input').forEach(input => {
                input.removeAttribute('disabled');
            });
            document.querySelectorAll('.checkbox-wrapper input').forEach(input => {
                input.removeAttribute('disabled');
            });
            // 启用通知选项
            document.querySelectorAll('#notificationOptions .checkbox-wrapper input').forEach(input => {
                input.removeAttribute('disabled');
            });
            
            // 隐藏编辑按钮，显示保存按钮
            document.getElementById('editBtn').style.display = 'none';
            const actionButtons = document.querySelector('.action-buttons');
            actionButtons.style.display = 'flex';
            
            showNotification('已进入编辑模式', 'info');
        }

        // 取消编辑
        function cancelEdit() {
            // 恢复原始值
            const titleText = document.getElementById('templateTitleText').textContent;
            document.getElementById('templateTitleInput').value = titleText;
            
            // 恢复级别选择器的原始值
            document.querySelectorAll('.level-select').forEach(select => {
                select.value = select.getAttribute('data-value');
            });
            
            // 隐藏输入框，显示文本
            document.getElementById('templateTitleText').style.display = 'block';
            document.getElementById('templateTitleInput').style.display = 'none';
            
            // 隐藏级别选择器，显示级别标签
            document.querySelectorAll('.level-badge').forEach(badge => {
                badge.style.display = 'inline-flex';
            });
            document.querySelectorAll('.level-select').forEach(select => {
                select.style.display = 'none';
            });
            
            // 隐藏条件编辑，显示条件文本
            document.querySelectorAll('.condition-text').forEach(text => {
                text.style.display = 'inline';
            });
            document.querySelectorAll('.condition-edit').forEach(edit => {
                edit.style.display = 'none';
            });
            
            // 恢复只读状态
            document.querySelectorAll('.param-input').forEach(input => {
                input.setAttribute('readonly', 'readonly');
            });
            document.querySelectorAll('.switch input').forEach(input => {
                input.setAttribute('disabled', 'disabled');
            });
            document.querySelectorAll('.checkbox-wrapper input').forEach(input => {
                input.setAttribute('disabled', 'disabled');
            });
            // 禁用通知选项
            document.querySelectorAll('#notificationOptions .checkbox-wrapper input').forEach(input => {
                input.setAttribute('disabled', 'disabled');
            });
            
            // 显示编辑按钮，隐藏保存按钮
            document.getElementById('editBtn').style.display = 'inline-flex';
            const actionButtons = document.querySelector('.action-buttons');
            actionButtons.style.display = 'none';
            
            showNotification('已退出编辑模式', 'info');
        }

        // 保存修改
        function saveTemplate() {
            // 更新显示的文本
            const newTitle = document.getElementById('templateTitleInput').value;
            document.getElementById('templateTitleText').textContent = newTitle;
            
            // 更新级别标签
            document.querySelectorAll('.level-select').forEach(select => {
                const newLevel = select.value;
                const badgeId = select.id.replace('_level_select', '_level_badge');
                const badge = document.getElementById(badgeId);
                if (badge) {
                    // 更新标签类名
                    badge.className = `level-badge ${newLevel}`;
                    // 更新标签文本
                    badge.textContent = newLevel === 'critical' ? '严重' : newLevel === 'major' ? '重要' : '一般';
                    // 更新data-value
                    select.setAttribute('data-value', newLevel);
                }
            });
            
            // 隐藏输入框，显示文本
            document.getElementById('templateTitleText').style.display = 'block';
            document.getElementById('templateTitleInput').style.display = 'none';
            
            // 隐藏级别选择器，显示级别标签
            document.querySelectorAll('.level-badge').forEach(badge => {
                badge.style.display = 'inline-flex';
            });
            document.querySelectorAll('.level-select').forEach(select => {
                select.style.display = 'none';
            });
            
            // 隐藏条件编辑，显示条件文本
            document.querySelectorAll('.condition-text').forEach(text => {
                text.style.display = 'inline';
            });
            document.querySelectorAll('.condition-edit').forEach(edit => {
                edit.style.display = 'none';
            });
            
            // 恢复只读状态
            document.querySelectorAll('.param-input').forEach(input => {
                input.setAttribute('readonly', 'readonly');
            });
            document.querySelectorAll('.switch input').forEach(input => {
                input.setAttribute('disabled', 'disabled');
            });
            document.querySelectorAll('.checkbox-wrapper input').forEach(input => {
                input.setAttribute('disabled', 'disabled');
            });
            // 禁用通知选项
            document.querySelectorAll('#notificationOptions .checkbox-wrapper input').forEach(input => {
                input.setAttribute('disabled', 'disabled');
            });
            
            // 显示编辑按钮，隐藏保存按钮
            document.getElementById('editBtn').style.display = 'inline-flex';
            const actionButtons = document.querySelector('.action-buttons');
            actionButtons.style.display = 'none';
            
            showNotification('模版修改已保存', 'success');
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6',
                warning: '#f59e0b'
            };
            
            notification.innerHTML = `
                <i class="fas ${icons[type]}" style="color: ${colors[type]}; font-size: 20px;"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
        });
    </script>
</body>
</html>