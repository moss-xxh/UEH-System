<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据监控 - 储能柜管理系统</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="common-header-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0e1a;
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* 科技风背景网格 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 150, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 150, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        /* 动态光效背景 */
        .bg-effects {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            z-index: 0;
        }

        .bg-effects::after {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 150, 255, 0.15) 0%, transparent 50%);
            animation: rotate 20s linear infinite;
            top: -50%;
            left: -50%;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 头部导航 */
        .header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 30px;
            border-bottom: 1px solid rgba(0, 150, 255, 0.3);
            position: relative;
            z-index: 100;
            gap: 40px;
            flex-wrap: nowrap;
            min-width: 0;
        }

        /* Logo区域 */
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: none;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(90deg, #0096ff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 导航菜单 */
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: center;
            flex-wrap: nowrap;
            min-width: 0;
        }

        .nav-item {
            padding: 12px 28px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 17px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 8px;
            white-space: nowrap;
            display: inline-block;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00d4ff, transparent);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-item:hover {
            color: #00d4ff;
            background: rgba(0, 150, 255, 0.1);
        }

        .nav-item:hover::before {
            width: 80%;
        }

        .nav-item.active {
            color: #00d4ff;
            background: rgba(0, 150, 255, 0.15);
        }

        .nav-item.active::before {
            width: 80%;
            background: #00d4ff;
            box-shadow: 0 0 10px #00d4ff;
        }

        /* 头部右侧 */
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* 时间显示 */
        .header-time {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-family: 'SF Mono', monospace;
            letter-spacing: 1px;
        }

        /* 科技风图标按钮 */
        .tech-icon-btn {
            width: 40px;
            height: 40px;
            background: rgba(0, 150, 255, 0.1);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tech-icon-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(0, 150, 255, 0.6) 0%, transparent 70%);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .tech-icon-btn:hover {
            background: rgba(0, 150, 255, 0.2);
            border-color: rgba(0, 150, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 150, 255, 0.4);
        }

        .tech-icon-btn:hover::before {
            width: 100px;
            height: 100px;
        }

        .tech-icon-btn:active {
            transform: translateY(0);
        }

        /* 图标样式 */
        .tech-icon {
            width: 20px;
            height: 20px;
            position: relative;
            z-index: 1;
        }

        /* 语言切换图标 */
        .lang-icon {
            width: 20px;
            height: 20px;
            border: 2px solid #00d4ff;
            border-radius: 50%;
            position: relative;
        }

        .lang-icon::before,
        .lang-icon::after {
            content: '';
            position: absolute;
            border: 1px solid #00d4ff;
            border-radius: 50%;
        }

        .lang-icon::before {
            width: 100%;
            height: 8px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .lang-icon::after {
            width: 8px;
            height: 100%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* 新的语言切换器样式 */
        .lang-switcher {
            position: relative;
            margin-left: 15px;
        }
        
        .lang-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
        }
        
        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .lang-btn svg {
            width: 20px;
            height: 20px;
        }
        
        /* 语言下拉菜单 - 白色卡片风格 */
        .lang-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 12px;
            padding: 8px;
            min-width: 140px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .lang-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }

        .lang-option:hover {
            background: #f3f4f6;
        }

        .lang-option.active {
            background: #e5f3ff;
            color: #2563eb;
        }
        
        .lang-option .flag {
            font-size: 18px;
            line-height: 1;
        }
        
        /* 工具提示 */
        .tooltip {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .tech-icon-btn:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* 主内容容器 */
        .main-container {
            height: calc(100vh - 60px);
            display: flex;
            position: relative;
            z-index: 1;
        }

        /* 左侧组件列表 */
        .component-sidebar {
            width: 220px;
            padding: 20px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(0, 150, 255, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .component-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        /* OTA升级按钮 */
        .ota-upgrade-box {
            margin-top: auto;
            margin-bottom: 15px;
        }
        
        .ota-upgrade-btn {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #0096ff 0%, #00d4ff 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 150, 255, 0.3);
        }
        
        .ota-upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 150, 255, 0.4);
        }
        
        .ota-upgrade-btn:active {
            transform: translateY(0);
        }
        
        .ota-upgrade-btn i {
            font-size: 18px;
        }

        .component-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(0, 150, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        .component-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 150, 255, 0.15), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .component-item:hover {
            color: rgba(255, 255, 255, 0.95);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 150, 255, 0.4);
            transform: translateX(5px);
        }

        .component-item.active {
            color: #00d4ff;
            background: rgba(0, 150, 255, 0.15);
            border-color: rgba(0, 150, 255, 0.5);
            box-shadow: inset 0 0 20px rgba(0, 150, 255, 0.2);
        }

        .component-item.active::before {
            opacity: 1;
        }

        .component-status {
            margin-left: auto;
            font-size: 14px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-normal {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.5);
        }
        
        .status-error {
            color: #ffffff;
            background: #ff4444;
            border: 1px solid #ff6666;
        }
        
        .status-offline {
            color: #ffffff;
            background: rgba(255, 193, 7, 0.9);
            border: 1px solid rgba(255, 193, 7, 1);
        }

        /* 右侧内容区 */
        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(10, 14, 26, 0.5);
            overflow: hidden;
        }

        /* 容器 */
        .data-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* 内容区域 */
        .content-section {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .content-section.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        /* 子标签页 */
        .sub-tabs {
            display: flex;
            gap: 30px;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(0, 150, 255, 0.1);
            flex-shrink: 0;
            position: relative;
        }
        
        /* 数据设置按钮 */
        .data-settings-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 150, 255, 0.1);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 6px;
            padding: 10px 16px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
        }
        
        .data-settings-btn:hover {
            background: rgba(0, 150, 255, 0.2);
            color: #00d4ff;
            border-color: rgba(0, 150, 255, 0.5);
        }
        
        /* 设置面板 */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(0, 150, 255, 0.3);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .settings-panel.show {
            right: 0;
        }
        
        .settings-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 150, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-title {
            font-size: 18px;
            color: #00d4ff;
        }
        
        .settings-close {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .settings-close:hover {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
        }
        
        .settings-content {
            padding: 20px;
        }
        
        .settings-section {
            margin-bottom: 30px;
        }
        
        .settings-section-title {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .field-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(0, 150, 255, 0.1);
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .field-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(0, 150, 255, 0.3);
        }
        
        .field-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .field-toggle {
            position: relative;
            width: 40px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .field-toggle.active {
            background: rgba(0, 150, 255, 0.5);
        }
        
        .field-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }
        
        .field-toggle.active::after {
            left: 22px;
        }

        /* 设置类型选择 */
        .settings-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .type-btn {
            flex: 1;
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .type-btn.active {
            background: rgba(0, 150, 255, 0.3);
            color: #00d4ff;
        }

        .sub-tab {
            padding: 10px 5px;
            padding-bottom: 18px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 22px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .sub-tab:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .sub-tab.active {
            color: #00d4ff;
        }

        .sub-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* 子内容区域 */
        .sub-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .sub-content.active {
            display: block;
        }
        
        /* 自定义滚动条样式 */
        .sub-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .sub-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .sub-content::-webkit-scrollbar-thumb {
            background: rgba(0, 150, 255, 0.3);
            border-radius: 4px;
        }
        
        .sub-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 150, 255, 0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 实时数据网格 - 固定4列布局 */
        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 45px;
            max-width: 1100px;
        }
        
        /* 节标题在网格中跨越所有列 */
        .realtime-grid .section-header {
            grid-column: 1 / -1;
        }
        
        /* 历史数据网格 */
        .history-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* 电表详细数据网格 */
        .meter-detail-grid {
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .meter-section {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(0, 150, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
        }
        
        .meter-section .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meter-section .section-title::before {
            content: '⚡';
            font-size: 18px;
        }
        
        .meter-params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .meter-params-grid.energy-stats {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        
        .meter-param-card {
            background: rgba(0, 150, 255, 0.08);
            border: 1px solid rgba(0, 150, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .meter-param-card:hover {
            background: rgba(0, 150, 255, 0.12);
            border-color: rgba(0, 150, 255, 0.4);
            transform: translateY(-2px);
        }
        
        .meter-param-card .param-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }
        
        .meter-param-card .param-value {
            font-size: 24px;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        
        .meter-param-card .param-unit {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: normal;
        }
        
        .meter-param-card .param-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .meter-param-card .param-status.normal {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .data-card {
            background: rgba(15, 25, 42, 0.6);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            min-width: 0;
            backdrop-filter: blur(10px);
            width: 260px;
            height: 130px;
            box-sizing: border-box;
        }

        .data-card:hover {
            border-color: rgba(0, 150, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 150, 255, 0.15);
            transform: translateY(-3px);
        }

        .data-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #0096ff, #00d4ff);
        }

        .card-title {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-icon {
            font-size: 20px;
            opacity: 0.9;
        }

        .card-value {
            font-size: 32px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.2;
        }

        .card-unit {
            font-size: 14px;
            color: rgba(0, 212, 255, 0.8);
            margin-left: 4px;
            font-weight: 500;
        }

        .card-status {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            margin-top: 4px;
        }

        .card-status.good {
            color: #00ff88;
        }

        .card-status.warning {
            color: #ffdd00;
        }

        .card-status.error {
            color: #ffdd00;
        }

        .card-status.normal {
            color: #00ff88;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }
        
        /* 三相参数卡片样式 */
        .three-phase-card {
            min-height: 150px;
        }
        
        .three-phase-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 12px 0;
        }
        
        .phase-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: rgba(0, 150, 255, 0.05);
            border-radius: 6px;
            border-left: 3px solid rgba(0, 150, 255, 0.4);
        }
        
        .phase-item.total {
            grid-column: 1 / -1;
            background: rgba(0, 212, 255, 0.1);
            border-left-color: rgba(0, 212, 255, 0.6);
        }
        
        .phase-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }
        
        .phase-value {
            font-size: 16px;
            color: #ffffff;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* 图表容器 */
        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(0, 150, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-shrink: 0;
            height: 40px;
        }

        .chart-title {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .chart-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
            max-height: inherit !important;
        }
        
        .chart-wrapper[style*="height: 450px"] canvas {
            height: 450px !important;
            max-height: 450px !important;
        }

        .time-range-selector {
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.05);
            padding: 3px;
            border-radius: 6px;
        }

        .time-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .time-btn:hover {
            color: #00d4ff;
        }

        .time-btn.active {
            background: rgba(0, 150, 255, 0.3);
            color: #00d4ff;
        }

        /* 数据区块标题 */
        .section-header {
            margin-bottom: 5px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 150, 255, 0.1);
        }

        .section-title {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .settings-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        
        .settings-btn i {
            font-size: 12px;
        }

        /* 遮罩层 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* 响应式 - 小屏幕3列 */
        /* 退出按钮样式 */
        .logout-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 18px;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            transform: scale(1.05);
            color: #ef4444;
        }

        @media (max-width: 1200px) {
            .realtime-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .confirm-icon i {
            font-size: 36px;
            color: #ef4444;
        }




/* 响应式 - 更小屏幕2列 */
        @media (max-width: 768px) {
            .data-container {
                padding: 15px;
            }

            .realtime-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 响应式 - 手机1列 */
        @media (max-width: 480px) {
            .realtime-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 悬浮滚动按钮 */
        .floating-scroll-buttons {
            position: fixed;
            right: 15px;
            bottom: 50%;
            transform: translateY(50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .scroll-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 150, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 150, 255, 0.4);
            transition: all 0.3s ease;
        }

        .scroll-btn:hover {
            background: rgba(0, 150, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(0, 150, 255, 0.6);
        }

        .scroll-btn:active {
            transform: scale(0.95);
        }

        .scroll-btn.up {
            background: linear-gradient(135deg, #00d4ff 0%, #0096ff 100%);
        }

        .scroll-btn.down {
            background: linear-gradient(135deg, #0096ff 0%, #00d4ff 100%);
        }

        .scroll-btn i {
            pointer-events: none;
        }
        
        /* 隐藏原生日期选择器 */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            display: none;
        }
        
        /* 自定义日期输入框样式 */
        .custom-date-input {
            position: relative;
            display: inline-block;
        }
        
        .custom-date-input input {
            background: rgba(15, 25, 42, 0.8);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.9);
            padding: 4px 32px 4px 8px;
            font-size: 13px;
            width: 140px;
            height: 32px;
            cursor: pointer;
        }
        
        .custom-date-input .calendar-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 16px;
        }
        
        .custom-date-input .calendar-icon:hover {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* 自定义日期选择弹窗 */
        .custom-calendar-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 25, 42, 0.98);
            border: 2px solid rgba(0, 150, 255, 0.4);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8);
            z-index: 10000;
            min-width: 450px;
            backdrop-filter: blur(10px);
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        
        .custom-calendar-popup.show {
            display: block;
        }
        
        /* 遮罩层 */
        .calendar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .calendar-overlay.show {
            display: block;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 150, 255, 0.2);
        }
        
        .calendar-nav-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 150, 255, 0.2);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            touch-action: manipulation;
        }
        
        .calendar-nav-btn:hover {
            background: rgba(0, 150, 255, 0.3);
            border-color: rgba(0, 150, 255, 0.5);
        }
        
        .calendar-month-year {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-month-year select {
            background: rgba(15, 25, 42, 0.8);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            font-size: 16px;
            height: 45px;
            cursor: pointer;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .calendar-weekday {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            font-weight: 600;
            padding: 10px 0;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day {
            width: 55px;
            height: 55px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 150, 255, 0.2);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 20px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            touch-action: manipulation;
            pointer-events: auto;
            position: relative;
            z-index: 1;
        }
        
        .calendar-day:hover {
            background: rgba(0, 150, 255, 0.2);
            border-color: rgba(0, 150, 255, 0.4);
            color: white;
        }
        
        .calendar-day.other-month {
            color: rgba(255, 255, 255, 0.3);
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #0096ff, #00d4ff);
            border-color: #00d4ff;
            color: white;
            font-weight: 600;
        }
        
        .calendar-day.today {
            border-color: #00d4ff;
            position: relative;
        }
        
        .calendar-day.today::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: #00d4ff;
            border-radius: 50%;
        }
        
        .calendar-footer {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 150, 255, 0.2);
        }
        
        .calendar-btn {
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            min-width: 120px;
            touch-action: manipulation;
        }
        
        .calendar-btn.primary {
            background: linear-gradient(135deg, #0096ff, #00d4ff);
            color: white;
        }
        
        .calendar-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 150, 255, 0.4);
        }
        
        .calendar-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .calendar-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }



    </style>
</head>
<body>
    <!-- 背景效果 -->
    <div class="bg-effects"></div>

    <!-- 悬浮滚动按钮 -->
    <div class="floating-scroll-buttons">
        <button class="scroll-btn up" onclick="scrollPage('up')" title="向上滚动">
            <i class="fas fa-chevron-up"></i>
        </button>
        <button class="scroll-btn down" onclick="scrollPage('down')" title="向下滚动">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>

    <!-- 头部导航 -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">
                    <img src="logo.png" alt="Logo">
                </div>
                <div class="logo-text">储能柜管理系统</div>
            </div>
        </div>
        
        <!-- 导航菜单 -->
        <nav class="nav-menu">
            <div class="nav-item" onclick="switchPage('home')">首页</div>
            <a href="#data" class="nav-item active" onclick="switchPage('data')">数据</a>
            <a href="#" class="nav-item" onclick="switchPage('history')">历史</a>
            <a href="#control" class="nav-item" onclick="switchPage('control')">控制</a>
            <a href="#alarm" class="nav-item" onclick="switchPage('alarm')">告警</a>
            <a href="#log" class="nav-item" onclick="switchPage('log')">日志</a>
            <a href="#settings" class="nav-item" onclick="switchPage('settings')">设置</a>
        </nav>
        
        <div class="header-right">
            <div class="header-time" id="currentTime">2024-01-31 14:30:00</div>
            
            <!-- 语言切换按钮 -->
            <div class="lang-switcher">
                <button class="lang-btn" onclick="toggleLanguageDropdown(event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                </button>
                <div class="lang-dropdown" id="langDropdown">
                    <div class="lang-option" onclick="changeLanguage('zh', event)">
                        <span class="flag">🇨🇳</span>
                        <span>中文</span>
                    </div>
                    <div class="lang-option" onclick="changeLanguage('en', event)">
                        <span class="flag">🇺🇸</span>
                        <span>English</span>
                    </div>
                </div>
            </div>
            
            <!-- 退出按钮 -->
            <button class="logout-btn" onclick="logout()" title="退出登录">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- 主内容区域 -->
    <div class="main-container">
        <!-- 左侧组件列表 -->
        <div class="component-sidebar">
            <!-- Component List - Updated 2025-01-05 -->
            <div class="component-list">
                <div class="component-item active" onclick="switchDataTab('overall')">
                    <span>整机</span>
                </div>
                <div class="component-item" onclick="switchDataTab('ems')">
                    <span>EMS</span>
                    <span class="component-status status-normal">正常</span>
                </div>
                <div class="component-item" onclick="switchDataTab('pcs')">
                    <span>PCS</span>
                    <span class="component-status status-normal" id="pcs-status">正常</span>
                </div>
                <div class="component-item" onclick="switchDataTab('bms')">
                    <span>BMS</span>
                    <span class="component-status status-error" id="bms-status">异常</span>
                </div>
                <div class="component-item" onclick="switchDataTab('meter')">
                    <span>电表</span>
                    <span class="component-status status-normal" id="meter-status">正常</span>
                </div>
                <div class="component-item" onclick="switchDataTab('thermal')">
                    <span>温度</span>
                    <span class="component-status status-normal" id="thermal-status">正常</span>
                </div>
                <div class="component-item" onclick="switchDataTab('fire')">
                    <span>消防</span>
                    <span class="component-status status-offline" id="fire-status">离线</span>
                </div>
            </div>
            
            <!-- OTA升级按钮 -->
            <div class="ota-upgrade-box">
                <button class="ota-upgrade-btn" onclick="showOTAUpgrade()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>OTA升级</span>
                </button>
            </div>
        </div>

        <!-- 右侧内容区 -->
        <div class="content-wrapper">
            <div class="data-container">

        <!-- 整机概览 -->
        <div class="content-section active" id="overallSection">
            <!-- 子标签页 -->
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('overall', 'realtime')">实时数据</button>
                <button class="sub-tab" onclick="switchSubTab('overall', 'history')">历史数据</button>
                <button class="data-settings-btn" onclick="openSettings('overall')">
                    <span>⚙️</span>
                    <span>自定义</span>
                </button>
            </div>
            
            <!-- 实时数据内容 -->
            <div class="sub-content active" id="overall-realtime">
                <!-- 策略调度参数 -->
                <div class="section-header">
                    <h3 class="section-title">策略调度参数</h3>
                </div>
                <div class="realtime-grid" id="overall-策略调度参数">
                    <!-- 动态生成 -->
                </div>

                <!-- 核心运行参数 -->
                <div class="section-header">
                    <h3 class="section-title">核心运行参数</h3>
                </div>
                <div class="realtime-grid" id="overall-核心运行参数">
                    <!-- 动态生成 -->
                </div>

                <!-- 运行统计 -->
                <div class="section-header">
                    <h3 class="section-title">运行统计</h3>
                </div>
                <div class="realtime-grid" id="overall-运行统计">
                    <!-- 动态生成 -->
                </div>

                <!-- 其他参数 -->
                <div class="section-header">
                    <h3 class="section-title">其他参数</h3>
                </div>
                <div class="realtime-grid" id="overall-其他参数">
                    <!-- 动态生成 -->
                </div>

            </div>
            
            <!-- 历史数据内容 -->
            <div class="sub-content" id="overall-history">
                <div class="history-grid" id="overall-history-charts">
                    <!-- 动态生成历史数据图表 -->
                </div>
            </div>
        </div>

        <!-- EMS控制器 -->
        <div class="content-section" id="emsSection">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('ems', 'realtime')">实时数据</button>
                <button class="sub-tab" onclick="switchSubTab('ems', 'history')">历史数据</button>
                <button class="data-settings-btn" onclick="openSettings('ems')">
                    <span>⚙️</span>
                    <span>自定义</span>
                </button>
            </div>
            
            <div class="sub-content active" id="ems-realtime">
                <div class="realtime-grid" id="ems-data">
                    <!-- 动态生成 -->
                </div>
            </div>
            
            <div class="sub-content" id="ems-history">
                <div class="history-grid" id="ems-history-charts">
                    <!-- 动态生成历史数据图表 -->
                </div>
                <div style="text-align: center; padding: 100px 20px 60px 20px; color: rgba(255, 255, 255, 0.8); font-size: 28px; font-weight: 600;">
                    更多数据开发中...
                </div>
            </div>
        </div>

        <!-- PCS逆变器 -->
        <div class="content-section" id="pcsSection">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('pcs', 'realtime')">实时数据</button>
                <button class="sub-tab" onclick="switchSubTab('pcs', 'history')">历史数据</button>
                <button class="data-settings-btn" onclick="openSettings('pcs')">
                    <span>⚙️</span>
                    <span>自定义</span>
                </button>
            </div>
            
            <div class="sub-content active" id="pcs-realtime">
                <div class="realtime-grid" id="pcs-data">
                    <!-- 动态生成 -->
                </div>
            </div>
            
            <div class="sub-content" id="pcs-history">
                <div class="history-grid" id="pcs-history-charts">
                    <!-- 动态生成历史数据图表 -->
                </div>
            </div>
        </div>

        <!-- 电表系统 -->
        <div class="content-section" id="meterSection">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('meter', 'realtime')">实时数据</button>
                <button class="sub-tab" onclick="switchSubTab('meter', 'history')">历史数据</button>
                <button class="data-settings-btn" onclick="openSettings('meter')">
                    <span>⚙️</span>
                    <span>自定义</span>
                </button>
            </div>
            
            <div class="sub-content active" id="meter-realtime">
                <div class="realtime-grid" id="meter-data">
                    <!-- 动态生成 -->
                </div>
            </div>
            
            <div class="sub-content" id="meter-history">
                <div class="history-grid" id="meter-history-charts">
                    <!-- 动态生成历史数据图表 -->
                </div>
            </div>
        </div>

        <!-- BMS系统(包含BMS和电池模组) -->
        <div class="content-section" id="bmsSection">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('bms', 'realtime')">实时数据</button>
                <button class="sub-tab" onclick="switchSubTab('bms', 'history')">历史数据</button>
                <button class="data-settings-btn" onclick="openSettings('bms')">
                    <span>⚙️</span>
                    <span>自定义</span>
                </button>
            </div>
            
            <div class="sub-content active" id="bms-realtime">
                <div class="realtime-grid" id="bms-data">
                    <!-- 动态生成 -->
                </div>
            </div>
            
            <div class="sub-content" id="bms-history">
                <div class="history-grid" id="bms-history-charts">
                    <!-- 动态生成历史数据图表 -->
                </div>
            </div>
        </div>

        <!-- 温度 -->
        <div class="content-section" id="thermalSection">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('thermal', 'realtime')">实时数据</button>
                <button class="sub-tab" onclick="switchSubTab('thermal', 'history')">历史数据</button>
                <button class="data-settings-btn" onclick="openSettings('thermal')">
                    <span>⚙️</span>
                    <span>自定义</span>
                </button>
            </div>
            
            <div class="sub-content active" id="thermal-realtime">
                <div class="realtime-grid" id="thermal-data">
                    <!-- 动态生成 -->
                </div>
            </div>
            
            <div class="sub-content" id="thermal-history">
                <div class="history-grid" id="thermal-history-charts">
                    <!-- 动态生成历史数据图表 -->
                </div>
            </div>
        </div>

        <!-- 消防 -->
        <div class="content-section" id="fireSection">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('fire', 'realtime')">实时数据</button>
                <button class="sub-tab" onclick="switchSubTab('fire', 'history')">历史数据</button>
                <button class="data-settings-btn" onclick="openSettings('fire')">
                    <span>⚙️</span>
                    <span>自定义</span>
                </button>
            </div>
            
            <div class="sub-content active" id="fire-realtime">
                <div class="realtime-grid" id="fire-data">
                    <!-- 动态生成 -->
                </div>
            </div>
            
            <div class="sub-content" id="fire-history">
                <div class="history-grid" id="fire-history-charts">
                    <!-- 动态生成历史数据图表 -->
                </div>
            </div>
        </div>

            </div>
        </div>
    </div>

    <!-- 遮罩层 -->
    <div class="overlay" id="overlay" onclick="closeSettings()"></div>

    <!-- 设置面板 -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h3 class="settings-title">数据显示设置</h3>
            <button class="settings-close" onclick="closeSettings()">✕</button>
        </div>
        
        <!-- 设置类型选择 -->
        <div class="settings-type-selector">
            <button class="type-btn active" id="realtime-type-btn" onclick="switchSettingsType('realtime')">实时数据</button>
            <button class="type-btn" id="history-type-btn" onclick="switchSettingsType('history')">历史数据</button>
        </div>
        
        <div class="settings-content" id="settingsContent">
            <!-- 动态生成设置内容 -->
        </div>
    </div>

    <script>
        // 数据字段配置
        const dataFieldsConfig = {
            overall: {
                realtime: {
                    '策略调度参数': {
                        strategy: { label: '当前策略', unit: '', default: true, value: '峰谷套利', status: '自动执行中', statusColor: '#00ff88' },
                        dispatch: { label: '调度指令', unit: '', default: true, value: '充电', statusColor: '#00ff88', subValue: '最大功率：300kW' },
                        targetSOC: { label: '目标SOC', unit: '%', default: true, value: '90' },
                        maxPower: { label: '最大功率', unit: 'kW', default: true }
                    },
                    '核心运行参数': {
                        soc: { label: 'SOC', unit: '%', default: true },
                        soh: { label: 'SOH', unit: '%', default: true },
                        temperature: { label: '温度', unit: '°C', default: true },
                        power: { label: '充放电功率', unit: 'kW', default: true },
                        batteryCurrent: { label: '电池电流', unit: 'A', default: true },
                        batteryVoltage: { label: '电池电压', unit: 'V', default: true }
                    },
                    '运行统计': {
                        todayCharge: { label: '今日充电量', unit: 'kWh', default: true },
                        todayDischarge: { label: '今日放电量', unit: 'kWh', default: true },
                        totalCharge: { label: '累计充电量', unit: 'MWh', default: true },
                        totalDischarge: { label: '累计放电量', unit: 'MWh', default: true }
                    },
                    '其他参数': {
                        cycles: { label: '循环次数', unit: '次', default: true }
                    },
                },
                history: {
                    '图表分析': {
                        powerTrend: { label: '功率与SOC综合分析', default: true },
                        efficiency: { label: '收益分析', default: true }
                    }
                }
            },
            // EMS控制器
            ems: {
                realtime: {
                    'CPU状态': {
                        cpuUsage: { label: '使用率', unit: '%', default: true },
                        cpuTemp: { label: '温度', unit: '°C', default: true }
                    },
                    '内存状态': {
                        memoryUsage: { label: '占用率', unit: '%', default: true }
                    },
                    '磁盘状态': {
                        diskUsage: { label: '空间使用率', unit: '%', default: true }
                    },
                    '开发板温度': {
                        boardTemp: { label: '当前温度', unit: '°C', default: true }
                    },
                    '4G网络状态': {
                        signalStrength: { label: '信号强度', unit: 'dBm', default: true },
                        simStatus: { label: 'SIM卡状态', unit: '', default: true },
                        networkStatus: { label: '网络接口', unit: '', default: true }
                    },
                    'WiFi状态': {
                        wifiSignal: { label: '信号强度', unit: 'dBm', default: true },
                        wifiConnection: { label: '网络接口', unit: '', default: true }
                    },
                    '系统信息': {
                        runTime: { label: '系统运行时长', unit: '', default: true },
                        systemTime: { label: '当前系统时间', unit: '', default: true },
                        hardwareTime: { label: '当前硬件时间', unit: '', default: true }
                    }
                },
                history: {
                    '性能监控': {
                        cpuHistory: { label: 'CPU使用率历史', default: true },
                        memoryHistory: { label: '内存使用率历史', default: true },
                        temperatureHistory: { label: '温度变化趋势', default: true }
                    },
                    '网络状态': {
                        networkHistory: { label: '网络连接历史', default: true },
                        signalHistory: { label: '信号强度变化', default: true }
                    },
                    '系统日志': {
                        systemLog: { label: '系统运行日志', default: true },
                        eventLog: { label: '重要事件记录', default: true }
                    }
                }
            },
            // PCS逆变器
            pcs: {
                realtime: {
                    'PCS电网侧参数': {
                        gridVoltage: { label: 'PCS电网侧电压', unit: 'V', default: true, type: 'three-phase' },
                        gridCurrent: { label: 'PCS电网侧电流', unit: 'A', default: true, type: 'three-phase' },
                        gridPower: { label: 'PCS电网侧功率', unit: 'kW', default: true, type: 'three-phase-power' }
                    },
                    'PCS温度': {
                        transformerTemp: { label: 'PCS温度', unit: '°C', default: true }
                    }
                },
                history: {
                    '图表': {
                        powerConversion: { label: '功率转换历史', default: true },
                        voltageCurrent: { label: '电压电流趋势', default: true },
                        efficiency: { label: '转换效率分析', default: true }
                    }
                }
            },
            // 电表系统
            meter: {
                realtime: {
                    '电能计量': {
                        totalActivePower: { label: '总有功功率', unit: 'kW', default: true },
                        totalReactivePower: { label: '总无功功率', unit: 'kVar', default: true },
                        totalApparentPower: { label: '总视在功率', unit: 'kVA', default: true },
                        frequency: { label: '频率', unit: 'Hz', default: true }
                    },
                    '电压电流': {
                        meterVoltage: { label: '电表电压', unit: 'V', default: true, type: 'three-phase' },
                        meterCurrent: { label: '电表电流', unit: 'A', default: true, type: 'three-phase' }
                    },
                    '电能统计': {
                        dailyActiveEnergy: { label: '日有功电量', unit: 'kWh', default: true },
                        dailyReactiveEnergy: { label: '日无功电量', unit: 'kVarh', default: true },
                        totalActiveEnergy: { label: '累计有功电量', unit: 'MWh', default: true },
                        totalReactiveEnergy: { label: '累计无功电量', unit: 'MVarh', default: true }
                    }
                },
                history: {
                    '图表': {
                        powerTrend: { label: '功率趋势分析', default: true },
                        energyConsumption: { label: '电量消耗统计', default: true },
                        voltageQuality: { label: '电压质量监测', default: true },
                        harmonicAnalysis: { label: '谐波分析', default: true }
                    }
                }
            },
            // BMS系统（合并BMS和电池模组）
            bms: {
                realtime: {
                    '核心指标': {
                        totalVoltage: { label: '电池总电压', unit: 'V', default: true },
                        totalCurrent: { label: '电池总电流', unit: 'A', default: true },
                        batteryPower: { label: '电池功率', unit: 'kW', default: true },
                        soc: { label: 'SOC', unit: '%', default: true },
                        soh: { label: 'SOH', unit: '%', default: true },
                        pack: { label: 'Pack', unit: '个', default: true },
                        cycles: { label: '循环次数', unit: '次', default: true }
                    },
                    '运行统计': {
                        dailyCharge: { label: '日充电量', unit: 'kWh', default: true },
                        dailyDischarge: { label: '日放电量', unit: 'kWh', default: true },
                        totalCharge: { label: '累计充电量', unit: 'MWh', default: true },
                        totalDischarge: { label: '累计放电量', unit: 'MWh', default: true }
                    },
                    'Pack电池簇信息': {
                        pack1: { label: 'Pack1', unit: '', default: true },
                        pack2: { label: 'Pack2', unit: '', default: true },
                        pack3: { label: 'Pack3', unit: '', default: true },
                        pack4: { label: 'Pack4', unit: '', default: true }
                    }
                },
                history: {
                    '图表': {
                        performance: { label: '电池性能趋势', default: true },
                        cycles: { label: '循环寿命统计', default: true },
                        capacity: { label: '容量衰减分析', default: true },
                        voltageHistory: { label: '电池电压历史', default: true },
                        socBalance: { label: '电池SOC趋势', default: true },
                        tempDistribution: { label: '温度分布分析', default: true }
                    }
                }
            },
            // 温控系统
            thermal: {
                realtime: {
                    '运行状态': {
                        thermalManagementStatus: { label: '储能柜温度', unit: '°C', default: true },
                        runningMode: { label: '运行模式', unit: '', default: true },
                        humidity: { label: '相对湿度', unit: '%', default: true }
                    },
                    '核心监控参数': {
                        battMaxTemp: { label: '电池包最高温度', unit: '℃', default: true },
                        battMinTemp: { label: '电池包最低温度', unit: '℃', default: true },
                        battAvgTemp: { label: '电池包平均温度', unit: '℃', default: true },
                        battTempDiff: { label: '电池包温差', unit: '℃', default: true },
                        inletTemp: { label: '进风温度', unit: '℃', default: true },
                        outletTemp: { label: '出风温度', unit: '℃', default: true },
                        coolantTemp: { label: '冷却液温度', unit: '℃', default: true }
                    }
                },
                history: {
                    '图表': {
                        tempDistribution: { label: '温度分布历史', default: true },
                        coolingSystem: { label: '冷却系统运行', default: true },
                        heatMap: { label: '温度热力图', default: true }
                    }
                }
            },
            // 消防系统
            fire: {
                realtime: {
                    '火灾探测': {
                        smokeDetector1: { label: '烟感探测器', unit: '', default: true },
                        fireAlarmStatus: { label: '火警状态', unit: '', default: true }
                    },
                    '消防联动': {
                        extinguisherStatus: { label: '灭火器状态', unit: '', default: true },
                        emergencyStop: { label: '紧急停机', unit: '', default: true },
                        evacuationAlarm: { label: '声光报警器', unit: '', default: true }
                    }
                },
                history: {
                    '图表': {
                        systemStatus: { label: '系统状态历史', default: true },
                        gasConcentration: { label: '气体浓度监测', default: true },
                        alarmHistory: { label: '告警记录分析', default: true }
                    }
                }
            }
        };

        // 存储用户自定义显示设置
        // 清理旧的localStorage数据
        if (localStorage.getItem('dataFieldSettings')) {
            localStorage.removeItem('dataFieldSettings');
        }
        
        let userFieldSettings = JSON.parse(localStorage.getItem('touchscreenFieldSettings') || '{}');
        
        let currentComponent = '';
        let currentSettingsType = 'realtime';

        // 打开字段设置对话框
        function openFieldSettings(component) {
            const config = dataFieldsConfig[component];
            if (!config) return;
            
            // 创建设置对话框
            const dialog = document.createElement('div');
            dialog.className = 'field-settings-dialog';
            dialog.innerHTML = `
                <div class="field-settings-overlay" onclick="closeFieldSettings()"></div>
                <div class="field-settings-content">
                    <div class="field-settings-header">
                        <h3>${translations[currentLanguage].fieldSettings || '字段设置'}</h3>
                        <button class="close-btn" onclick="closeFieldSettings()">×</button>
                    </div>
                    <div class="field-settings-body">
                        <div class="settings-tabs">
                            <button class="settings-tab active" onclick="switchSettingsTab('${component}', 'realtime')">
                                ${translations[currentLanguage].realtimeData || '实时数据'}
                            </button>
                            ${config.history ? `
                                <button class="settings-tab" onclick="switchSettingsTab('${component}', 'history')">
                                    ${translations[currentLanguage].historyData || '历史数据'}
                                </button>
                            ` : ''}
                        </div>
                        <div class="settings-content" id="settingsContent">
                            ${generateFieldSettingsContent(component, 'realtime')}
                        </div>
                    </div>
                    <div class="field-settings-footer">
                        <button class="btn btn-secondary" onclick="closeFieldSettings()">
                            ${translations[currentLanguage].cancel || '取消'}
                        </button>
                        <button class="btn btn-primary" onclick="saveFieldSettings('${component}')">
                            ${translations[currentLanguage].save || '保存'}
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
            
            // 添加样式
            if (!document.getElementById('fieldSettingsStyles')) {
                const style = document.createElement('style');
                style.id = 'fieldSettingsStyles';
                style.textContent = `
                    .field-settings-dialog {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .field-settings-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                    }
                    
                    .field-settings-content {
                        position: relative;
                        background: white;
                        border-radius: 8px;
                        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .field-settings-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    
                    .field-settings-header h3 {
                        margin: 0;
                        font-size: 18px;
                        color: #111827;
                    }
                    
                    .close-btn {
                        background: none;
                        border: none;
                        font-size: 24px;
                        color: #6b7280;
                        cursor: pointer;
                        padding: 0;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .close-btn:hover {
                        color: #111827;
                    }
                    
                    .field-settings-body {
                        flex: 1;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .settings-tabs {
                        display: flex;
                        padding: 0 20px;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    
                    .settings-tab {
                        background: none;
                        border: none;
                        padding: 12px 20px;
                        font-size: 14px;
                        color: #6b7280;
                        cursor: pointer;
                        border-bottom: 2px solid transparent;
                        margin-bottom: -1px;
                    }
                    
                    .settings-tab.active {
                        color: #3b82f6;
                        border-bottom-color: #3b82f6;
                    }
                    
                    .settings-content {
                        flex: 1;
                        overflow-y: auto;
                        padding: 20px;
                    }
                    
                    .field-category {
                        margin-bottom: 20px;
                    }
                    
                    .field-category-title {
                        font-size: 14px;
                        font-weight: 600;
                        color: #374151;
                        margin-bottom: 10px;
                    }
                    
                    .field-item {
                        display: flex;
                        align-items: center;
                        padding: 8px 0;
                    }
                    
                    .field-checkbox {
                        margin-right: 10px;
                    }
                    
                    .field-label {
                        font-size: 14px;
                        color: #4b5563;
                    }
                    
                    .field-settings-footer {
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                        padding: 20px;
                        border-top: 1px solid #e5e7eb;
                    }
                    
                    .btn {
                        padding: 8px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        cursor: pointer;
                        border: none;
                    }
                    
                    .btn-primary {
                        background: #3b82f6;
                        color: white;
                    }
                    
                    .btn-primary:hover {
                        background: #2563eb;
                    }
                    
                    .btn-secondary {
                        background: #e5e7eb;
                        color: #374151;
                    }
                    
                    .btn-secondary:hover {
                        background: #d1d5db;
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // 生成字段设置内容
        function generateFieldSettingsContent(component, type) {
            const config = dataFieldsConfig[component][type];
            if (!config) return '';
            
            let html = '';
            
            for (const category in config) {
                html += `<div class="field-category">`;
                html += `<div class="field-category-title">${category}</div>`;
                
                for (const field in config[category]) {
                    const fieldConfig = config[category][field];
                    const isChecked = shouldShowField(component, type, field);
                    
                    html += `
                        <div class="field-item">
                            <input type="checkbox" 
                                   class="field-checkbox" 
                                   id="${component}_${type}_${field}"
                                   ${isChecked ? 'checked' : ''}>
                            <label class="field-label" for="${component}_${type}_${field}">
                                ${fieldConfig.label}
                            </label>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            return html;
        }
        
        // 切换设置标签
        function switchSettingsTab(component, tab) {
            // 更新标签状态
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 更新内容
            document.getElementById('settingsContent').innerHTML = generateFieldSettingsContent(component, tab);
        }
        
        // 关闭字段设置
        function closeFieldSettings() {
            const dialog = document.querySelector('.field-settings-dialog');
            if (dialog) {
                dialog.remove();
            }
        }
        
        // 保存字段设置
        function saveFieldSettings(component) {
            // 获取所有复选框状态
            const checkboxes = document.querySelectorAll('.field-checkbox');
            
            checkboxes.forEach(checkbox => {
                const [comp, type, field] = checkbox.id.split('_');
                if (comp === component) {
                    // 初始化嵌套结构
                    if (!userFieldSettings[component]) {
                        userFieldSettings[component] = {};
                    }
                    if (!userFieldSettings[component][type]) {
                        userFieldSettings[component][type] = {};
                    }
                    
                    // 保存状态
                    userFieldSettings[component][type][field] = checkbox.checked;
                }
            });
            
            // 保存到localStorage
            localStorage.setItem('touchscreenFieldSettings', JSON.stringify(userFieldSettings));
            
            // 关闭对话框
            closeFieldSettings();
            
            // 刷新当前组件显示
            renderComponentData(component);
            
            // 如果当前在历史数据标签页，刷新历史数据
            const activeSubTab = document.querySelector(`#${component}Section .sub-tab.active`);
            if (activeSubTab && activeSubTab.textContent.includes('历史数据')) {
                renderHistoryData(component);
            }
        }
        
        // 初始化字段设置
        function initFieldSettings() {
            let needsSave = false;
            
            for (const component in dataFieldsConfig) {
                if (!userFieldSettings[component]) {
                    userFieldSettings[component] = { realtime: {}, history: {} };
                    needsSave = true;
                }
                
                // 初始化实时数据设置
                for (const section in dataFieldsConfig[component].realtime) {
                    for (const field in dataFieldsConfig[component].realtime[section]) {
                        if (userFieldSettings[component].realtime[field] === undefined) {
                            const defaultValue = dataFieldsConfig[component].realtime[section][field].default;
                            userFieldSettings[component].realtime[field] = defaultValue;
                            needsSave = true;
                        }
                    }
                }
                
                // 初始化历史数据设置
                if (dataFieldsConfig[component].history) {
                    for (const field in dataFieldsConfig[component].history) {
                        if (userFieldSettings[component].history[field] === undefined) {
                            const defaultValue = dataFieldsConfig[component].history[field].default;
                            userFieldSettings[component].history[field] = defaultValue;
                            needsSave = true;
                        }
                    }
                }
            }
            
            if (needsSave) {
                localStorage.setItem('touchscreenFieldSettings', JSON.stringify(userFieldSettings));
            }
        }

        // 切换设置类型
        function switchSettingsType(type) {
            currentSettingsType = type;
            
            // 更新按钮状态
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${type}-type-btn`).classList.add('active');
            
            // 重新渲染设置内容
            if (currentComponent) {
                renderSettingsContent(currentComponent);
            }
        }

        // 打开设置面板
        function openSettings(component) {
            currentComponent = component;
            const activeSubTab = document.querySelector(`#${component}Section .sub-tab.active`);
            const isHistory = activeSubTab && activeSubTab.textContent === '历史数据';
            
            // 设置默认类型
            currentSettingsType = isHistory ? 'history' : 'realtime';
            switchSettingsType(currentSettingsType);
            
            renderSettingsContent(component);
            
            document.getElementById('settingsPanel').classList.add('show');
            document.getElementById('overlay').classList.add('show');
        }

        // 渲染设置内容
        function renderSettingsContent(component) {
            const settingsContent = document.getElementById('settingsContent');
            settingsContent.innerHTML = '';

            const config = dataFieldsConfig[component][currentSettingsType];
            if (!config) {
                settingsContent.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center;">该组件暂无可配置项</p>';
                return;
            }
            
            if (currentSettingsType === 'realtime') {
                // 实时数据：按section分组
                for (const section in config) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'settings-section';
                    
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'settings-section-title';
                    sectionTitle.textContent = section;
                    sectionDiv.appendChild(sectionTitle);

                    for (const field in config[section]) {
                        const fieldItem = document.createElement('div');
                        fieldItem.className = 'field-item';
                        
                        const label = document.createElement('span');
                        label.className = 'field-label';
                        label.textContent = config[section][field].label;
                        
                        const toggle = document.createElement('div');
                        toggle.className = 'field-toggle';
                        
                        // 检查字段状态：如果用户设置存在就用用户设置，否则用默认值
                        let isActive = config[section][field].default; // 默认值
                        if (userFieldSettings[component] && userFieldSettings[component][currentSettingsType] && userFieldSettings[component][currentSettingsType][field] !== undefined) {
                            isActive = userFieldSettings[component][currentSettingsType][field];
                        }
                        
                        if (isActive) {
                            toggle.classList.add('active');
                        }
                        
                        toggle.onclick = () => {
                            toggle.classList.toggle('active');
                            
                            // 确保用户设置对象存在
                            if (!userFieldSettings[component]) {
                                userFieldSettings[component] = { realtime: {}, history: {} };
                            }
                            if (!userFieldSettings[component][currentSettingsType]) {
                                userFieldSettings[component][currentSettingsType] = {};
                            }
                            
                            userFieldSettings[component][currentSettingsType][field] = toggle.classList.contains('active');
                            localStorage.setItem('touchscreenFieldSettings', JSON.stringify(userFieldSettings));
                            
                            renderComponentData(component);
                        };
                        
                        fieldItem.appendChild(label);
                        fieldItem.appendChild(toggle);
                        sectionDiv.appendChild(fieldItem);
                    }
                    
                    settingsContent.appendChild(sectionDiv);
                }
            } else {
                // 历史数据：按分类显示
                for (const category in config) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'settings-section';
                    
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'settings-section-title';
                    sectionTitle.textContent = category;
                    sectionDiv.appendChild(sectionTitle);

                    const categoryFields = config[category];
                    for (const field in categoryFields) {
                        const fieldItem = document.createElement('div');
                        fieldItem.className = 'field-item';
                        
                        const label = document.createElement('span');
                        label.className = 'field-label';
                        label.textContent = categoryFields[field].label;
                        
                        const toggle = document.createElement('div');
                        toggle.className = 'field-toggle';
                        
                        // 检查字段状态：如果用户设置存在就用用户设置，否则用默认值
                        let isActive = categoryFields[field].default; // 默认值
                        if (userFieldSettings[component] && userFieldSettings[component][currentSettingsType] && userFieldSettings[component][currentSettingsType][field] !== undefined) {
                            isActive = userFieldSettings[component][currentSettingsType][field];
                        }
                        
                        if (isActive) {
                            toggle.classList.add('active');
                        }
                        
                        toggle.onclick = () => {
                            toggle.classList.toggle('active');
                            
                            // 确保用户设置对象存在
                            if (!userFieldSettings[component]) {
                                userFieldSettings[component] = { realtime: {}, history: {} };
                            }
                            if (!userFieldSettings[component][currentSettingsType]) {
                                userFieldSettings[component][currentSettingsType] = {};
                            }
                            
                            userFieldSettings[component][currentSettingsType][field] = toggle.classList.contains('active');
                            localStorage.setItem('touchscreenFieldSettings', JSON.stringify(userFieldSettings));
                            
                            renderHistoryData(component);
                        };
                        
                        fieldItem.appendChild(label);
                        fieldItem.appendChild(toggle);
                        sectionDiv.appendChild(fieldItem);
                    }
                    
                    settingsContent.appendChild(sectionDiv);
                }
            }
        }

        // 关闭设置面板
        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        // 渲染组件数据
        function renderComponentData(component) {
            console.log(`开始渲染组件: ${component}`);
            const config = dataFieldsConfig[component]?.realtime;
            if (!config) {
                console.log(`No config found for component: ${component}`);
                return;
            }
            console.log(`${component} 配置:`, config);
            console.log(`Rendering component: ${component}`, config);
            
            // 整机概览使用分区域布局
            if (component === 'overall') {
                for (const section in config) {
                    const containerId = `${component}-${section}`;
                    const container = document.getElementById(containerId);
                    
                    if (!container) continue;
                    
                    container.innerHTML = '';
                    
                    for (const field in config[section]) {
                        const fieldConfig = config[section][field];
                        
                        // 简化逻辑：如果用户设置存在就用用户设置，否则用默认值
                        let shouldShow = fieldConfig.default; // 先设为默认值
                        if (userFieldSettings[component] && userFieldSettings[component].realtime && userFieldSettings[component].realtime[field] !== undefined) {
                            shouldShow = userFieldSettings[component].realtime[field];
                        }
                        
                        if (shouldShow) {
                            const card = createDataCard(field, fieldConfig);
                            container.appendChild(card);
                        }
                    }
                }
            } else {
                // 其他组件使用简化布局
                const containerId = `${component}-data`;
                const container = document.getElementById(containerId);
                
                if (!container) {
                    console.log(`Container not found: ${containerId}`);
                    return;
                }
                
                container.innerHTML = '';
                
                // 需要显示节标题的组件
                const componentsWithSections = ['ems', 'pcs', 'bms', 'meter', 'thermal', 'fire'];
                if (componentsWithSections.includes(component)) {
                    let firstSection = true;
                    for (const section in config) {
                        // 创建节标题和设置按钮
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = 'section-header';
                        sectionHeader.style.gridColumn = '1 / -1'; // 跨越所有列
                        sectionHeader.style.display = 'flex';
                        sectionHeader.style.justifyContent = 'space-between';
                        sectionHeader.style.alignItems = 'center';
                        sectionHeader.style.marginBottom = '5px';
                        
                        let headerContent = `<h3 class="section-title" style="margin: 0;">${section}</h3>`;
                        
                        // 只在第一个分段添加设置按钮（排除特定组件）
                        const excludedComponents = ['ems', 'pcs', 'bms', 'meter', 'thermal', 'fire'];
                        if (firstSection && !excludedComponents.includes(component)) {
                            headerContent += `
                                <button class="settings-btn" onclick="openFieldSettings('${component}')" title="字段设置" style="padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>设置</span>
                                </button>
                            `;
                            firstSection = false;
                        }
                        
                        sectionHeader.innerHTML = headerContent;
                        container.appendChild(sectionHeader);
                        
                        // BMS组件Pack电池簇信息特殊处理 - 每个电池簇作为一个卡片
                        if (component === 'bms' && section === 'Pack电池簇信息') {
                            const packContainer = createPackBatteryCards(config[section]);
                            packContainer.style.gridColumn = '1 / -1'; // Pack容器跨越所有列
                            container.appendChild(packContainer);
                        } else {
                            // 直接将数据卡片添加到主容器，保持网格布局
                            for (const field in config[section]) {
                                const fieldConfig = config[section][field];
                                
                                let shouldShow = fieldConfig.default;
                                if (userFieldSettings[component] && userFieldSettings[component].realtime && userFieldSettings[component].realtime[field] !== undefined) {
                                    shouldShow = userFieldSettings[component].realtime[field];
                                }
                                
                                if (shouldShow) {
                                    const card = createDataCard(field, fieldConfig);
                                    container.appendChild(card);
                                }
                            }
                        }
                    }
                } else {
                    // 其他组件不显示节标题 - 直接处理扁平结构字段
                    for (const field in config) {
                        const fieldConfig = config[field];
                        
                        let shouldShow = fieldConfig.default;
                        if (userFieldSettings[component] && userFieldSettings[component].realtime && userFieldSettings[component].realtime[field] !== undefined) {
                            shouldShow = userFieldSettings[component].realtime[field];
                        }
                        
                        if (shouldShow) {
                            const card = createDataCard(field, fieldConfig);
                            container.appendChild(card);
                        }
                    }
                }
            }
        }

        // 渲染历史数据
        function renderHistoryData(component) {
            const container = document.getElementById(`${component}-history-charts`);
            if (!container) return;
            
            if (component === 'overall') {
                // 整机历史数据 - 根据字段设置动态显示
                let historyHtml = ``;
                
                const config = dataFieldsConfig[component].history;
                
                // 功率与SOC综合分析
                if (shouldShowField('overall', 'history', 'powerTrend')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    功率与SOC综合分析
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="historyEndDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('historyEndDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('historyEndDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="powerSocChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 收益分析
                if (shouldShowField('overall', 'history', 'efficiency')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    收益分析
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <select id="revenueTimeType" class="form-input" style="width: 220px; height: 55px; padding: 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9);" onchange="updateRevenueAnalysisChart()">
                                        <option value="day" selected>日</option>
                                        <option value="month">月</option>
                                        <option value="year">年</option>
                                        <option value="total">合计</option>
                                    </select>
                                    <div class="custom-date-input" id="revenueDatePickerWrapper" style="display: inline-block;">
                                        <input type="text" id="revenueDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('revenueDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('revenueDatePicker')">📅</span>
                                    </div>
                                    <input type="month" id="revenueMonthPicker" class="form-input" style="width: 220px; height: 55px; padding: 12px 16px; font-size: 24px; font-weight: 600; display: none; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9);" onchange="updateRevenueAnalysisChart()">
                                    <select id="revenueYearPicker" class="form-input" style="width: 220px; height: 55px; padding: 12px 16px; font-size: 24px; font-weight: 600; display: none; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9);" onchange="updateRevenueAnalysisChart()">
                                        <option value="2023">2023年</option>
                                        <option value="2024">2024年</option>
                                        <option value="2025" selected>2025年</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="revenueAnalysisChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = historyHtml;
                
                // 初始化图表
                setTimeout(() => {
                    // 设置默认日期值
                    const today = new Date();
                    const datePicker = document.getElementById('revenueDatePicker');
                    const monthPicker = document.getElementById('revenueMonthPicker');
                    
                    if (datePicker) {
                        datePicker.value = today.toISOString().split('T')[0];
                    }
                    if (monthPicker) {
                        const year = today.getFullYear();
                        const month = (today.getMonth() + 1).toString().padStart(2, '0');
                        monthPicker.value = `${year}-${month}`;
                    }
                    
                    initOverallHistoryCharts();
                }, 100);
                return;
            }
            
            // EMS历史数据
            if (component === 'ems') {
                let historyHtml = ``;
                
                // EMS策略执行历史
                if (shouldShowField('ems', 'history', 'strategyHistory')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">EMS策略执行历史</h3>
                            </div>
                            <div class="chart-wrapper" style="height: 400px !important;">
                                <canvas id="emsStrategyChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 调度响应时间分析
                if (shouldShowField('ems', 'history', 'responseTimeAnalysis')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">调度响应时间分析</h3>
                            </div>
                            <div class="chart-wrapper" style="height: 400px !important;">
                                <canvas id="emsResponseChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = historyHtml;
                
                // 延迟初始化EMS图表
                setTimeout(() => {
                    initEMSHistoryCharts();
                }, 100);
                return;
            }
            
            // PCS历史数据
            if (component === 'pcs') {
                let historyHtml = ``;
                
                // PCS功率转换历史
                if (shouldShowField('pcs', 'history', 'powerConversion')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    PCS功率转换历史
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="pcsPowerDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('pcsPowerDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('pcsPowerDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="pcsPowerChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 电压电流趋势
                if (shouldShowField('pcs', 'history', 'voltageCurrent')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    电压电流趋势
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="pcsVoltageDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('pcsVoltageDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('pcsVoltageDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="pcsVoltageChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 转换效率分析
                if (shouldShowField('pcs', 'history', 'efficiency')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    转换效率分析
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <select id="pcsEfficiencyTimePicker" class="form-input" style="width: 120px; height: 55px; padding: 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onchange="updatePcsEfficiencyTimePeriod()">
                                        <option value="day" selected>日</option>
                                        <option value="month">月</option>
                                        <option value="year">年</option>
                                        <option value="total">合计</option>
                                    </select>
                                    <div class="custom-date-input" id="pcsEfficiencyDatePickerWrapper" style="display: inline-block;">
                                        <input type="text" id="pcsEfficiencyDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('pcsEfficiencyDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('pcsEfficiencyDatePicker')">📅</span>
                                    </div>
                                    <input type="month" id="pcsEfficiencyMonthPicker" class="form-input" style="width: 220px; height: 55px; padding: 12px 16px; font-size: 24px; font-weight: 600; display: none; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9);" onchange="updatePcsEfficiencyChart()">
                                    <select id="pcsEfficiencyYearPicker" class="form-input" style="width: 220px; height: 55px; padding: 12px 16px; font-size: 24px; font-weight: 600; display: none; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9);" onchange="updatePcsEfficiencyChart()">
                                        <option value="2023">2023年</option>
                                        <option value="2024">2024年</option>
                                        <option value="2025" selected>2025年</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="pcsEfficiencyChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = historyHtml;
                
                setTimeout(() => {
                    // 设置默认日期值
                    const today = new Date();
                    const dateString = today.toISOString().split('T')[0];
                    
                    const pickers = ['pcsPowerDatePicker', 'pcsVoltageDatePicker', 'pcsEfficiencyDatePicker'];
                    pickers.forEach(pickerId => {
                        const picker = document.getElementById(pickerId);
                        if (picker) {
                            picker.value = dateString;
                        }
                    });
                    
                    // 设置默认日期值 for PCS效率分析
                    const datePicker = document.getElementById('pcsEfficiencyDatePicker');
                    const monthPicker = document.getElementById('pcsEfficiencyMonthPicker');
                    
                    if (datePicker) {
                        datePicker.value = today.toISOString().split('T')[0];
                    }
                    if (monthPicker) {
                        const year = today.getFullYear();
                        const month = (today.getMonth() + 1).toString().padStart(2, '0');
                        monthPicker.value = `${year}-${month}`;
                    }
                    
                    initPCSHistoryCharts();
                }, 100);
                return;
            }
            
            // 电表历史数据
            if (component === 'meter') {
                console.log('Rendering meter history data');
                console.log('Meter config:', dataFieldsConfig.meter);
                console.log('User settings:', userFieldSettings.meter);
                
                let historyHtml = ``;
                
                // 功率趋势分析
                const shouldShowPowerTrend = shouldShowField('meter', 'history', 'powerTrend');
                console.log('shouldShowPowerTrend:', shouldShowPowerTrend);
                
                if (shouldShowPowerTrend) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    功率趋势分析
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="meterPowerDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('meterPowerDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('meterPowerDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="meterPowerChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 电量消耗统计
                const shouldShowEnergyConsumption = shouldShowField('meter', 'history', 'energyConsumption');
                console.log('shouldShowEnergyConsumption:', shouldShowEnergyConsumption);
                
                if (shouldShowEnergyConsumption) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    电量消耗统计
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="meterEnergyDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('meterEnergyDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('meterEnergyDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="meterEnergyChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 电压质量监测
                if (shouldShowField('meter', 'history', 'voltageQuality')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    电压质量监测
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="meterVoltageDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('meterVoltageDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('meterVoltageDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="meterVoltageChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 谐波分析
                if (shouldShowField('meter', 'history', 'harmonicAnalysis')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    谐波分析
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="meterHarmonicDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('meterHarmonicDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('meterHarmonicDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="meterHarmonicChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                console.log('Final meter historyHtml:', historyHtml);
                console.log('Container element:', container);
                
                container.innerHTML = historyHtml;
                
                setTimeout(() => {
                    // 设置默认日期值
                    const today = new Date();
                    const dateString = today.toISOString().split('T')[0];
                    
                    const meterPickers = ['meterPowerDatePicker', 'meterEnergyDatePicker', 'meterVoltageDatePicker', 'meterHarmonicDatePicker'];
                    meterPickers.forEach(pickerId => {
                        const picker = document.getElementById(pickerId);
                        if (picker) {
                            picker.value = dateString;
                        }
                    });
                    
                    initMeterHistoryCharts();
                    
                    // 初始化各个图表的默认数据
                    setTimeout(() => {
                        updateMeterPowerChart(dateString);
                        updateMeterEnergyChart(dateString);
                        updateMeterVoltageChart(dateString);
                        updateMeterHarmonicChart(dateString);
                    }, 200);
                }, 100);
                return;
            }
            
            // BMS历史数据
            if (component === 'bms') {
                let historyHtml = ``;
                
                // 电池SOC趋势
                if (shouldShowField('bms', 'history', 'socBalance')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    电池SOC趋势
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="bmsBalanceDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('bmsBalanceDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('bmsBalanceDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="bmsBalanceChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 电池电压历史
                if (shouldShowField('bms', 'history', 'voltageHistory')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    电池电压历史
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="bmsVoltageDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('bmsVoltageDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('bmsVoltageDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="bmsVoltageChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 温度分布分析
                if (shouldShowField('bms', 'history', 'tempDistribution')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    温度分布分析
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="bmsTempDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('bmsTempDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('bmsTempDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="bmsTempChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = historyHtml;
                
                setTimeout(() => {
                    // 设置默认日期值
                    const today = new Date();
                    const dateString = today.toISOString().split('T')[0];
                    
                    const bmsPickers = ['bmsVoltageDatePicker', 'bmsBalanceDatePicker', 'bmsTempDatePicker'];
                    bmsPickers.forEach(pickerId => {
                        const picker = document.getElementById(pickerId);
                        if (picker) {
                            picker.value = dateString;
                        }
                    });
                    
                    initBMSHistoryCharts();
                }, 100);
                return;
            }
            
            // Battery历史数据
            if (component === 'battery') {
                let historyHtml = ``;
                
                // 电池性能趋势
                if (shouldShowField('battery', 'history', 'performance')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">电池性能趋势</h3>
                            </div>
                            <div class="chart-wrapper" style="height: 400px !important;">
                                <canvas id="batteryPerformanceChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 循环寿命统计
                if (shouldShowField('battery', 'history', 'cycles')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">循环寿命统计</h3>
                            </div>
                            <div class="chart-wrapper" style="height: 400px !important;">
                                <canvas id="batteryCycleChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 容量衰减分析
                if (shouldShowField('battery', 'history', 'capacity')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">容量衰减分析</h3>
                            </div>
                            <div class="chart-wrapper" style="height: 400px !important;">
                                <canvas id="batteryCapacityChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = historyHtml;
                
                setTimeout(() => {
                    initBatteryHistoryCharts();
                }, 100);
                return;
            }
            
            // Thermal历史数据
            if (component === 'thermal') {
                let historyHtml = ``;
                
                // 温度分布历史
                if (shouldShowField('thermal', 'history', 'tempDistribution')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    温度分布历史
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="thermalTempDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('thermalTempDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('thermalTempDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="thermalTempChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 冷却系统运行
                if (shouldShowField('thermal', 'history', 'coolingSystem')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    冷却系统运行
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="thermalCoolingDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('thermalCoolingDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('thermalCoolingDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="thermalCoolingChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 温度热力图
                if (shouldShowField('thermal', 'history', 'heatMap')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    温度热力图
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="thermalHeatMapDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('thermalHeatMapDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('thermalHeatMapDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="thermalHeatMapChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = historyHtml;
                
                setTimeout(() => {
                    // 设置默认日期值
                    const today = new Date();
                    const dateString = today.toISOString().split('T')[0];
                    
                    const thermalPickers = ['thermalTempDatePicker', 'thermalCoolingDatePicker', 'thermalHeatMapDatePicker'];
                    thermalPickers.forEach(pickerId => {
                        const picker = document.getElementById(pickerId);
                        if (picker) {
                            picker.value = dateString;
                        }
                    });
                    
                    initThermalHistoryCharts();
                }, 100);
                return;
            }
            
            // Fire历史数据
            if (component === 'fire') {
                let historyHtml = ``;
                
                // 系统状态历史
                if (shouldShowField('fire', 'history', 'systemStatus')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    系统状态历史
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="fireSystemDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('fireSystemDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('fireSystemDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="fireSystemChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 气体浓度监测
                if (shouldShowField('fire', 'history', 'gasConcentration')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    气体浓度监测
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="fireGasDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('fireGasDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('fireGasDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="fireGasChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                // 告警记录分析
                if (shouldShowField('fire', 'history', 'alarmHistory')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="chart-title" style="font-size: 18px; font-weight: 600; color: rgba(255, 255, 255, 0.95); display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 4px; height: 18px; background: linear-gradient(45deg, #0096ff, #00d4ff); border-radius: 2px;"></span>
                                    告警记录分析
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="custom-date-input">
                                        <input type="text" id="fireAlarmDatePicker" readonly style="width: 220px; height: 55px; padding: 12px 45px 12px 16px; font-size: 24px; font-weight: 600; background: rgba(15, 25, 42, 0.8); border: 1px solid rgba(0, 150, 255, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.9); cursor: pointer;" onclick="showCustomCalendar('fireAlarmDatePicker')">
                                        <span class="calendar-icon" onclick="showCustomCalendar('fireAlarmDatePicker')">📅</span>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 450px !important;">
                                <canvas id="fireAlarmChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = historyHtml;
                
                setTimeout(() => {
                    // 设置默认日期值
                    const today = new Date();
                    const dateString = today.toISOString().split('T')[0];
                    
                    const firePickers = ['fireSystemDatePicker', 'fireGasDatePicker', 'fireAlarmDatePicker'];
                    firePickers.forEach(pickerId => {
                        const picker = document.getElementById(pickerId);
                        if (picker) {
                            picker.value = dateString;
                        }
                    });
                    
                    initFireHistoryCharts();
                }, 100);
                return;
            }
            
            // 其他组件保持原有逻辑
            container.innerHTML = '';
            
            const config = dataFieldsConfig[component].history;
            if (!config) return;
            
            for (const field in config) {
                // 使用设置值，如果不存在则使用默认值
                let shouldShow = config[field].default;
                if (userFieldSettings[component] && userFieldSettings[component].history && userFieldSettings[component].history[field] !== undefined) {
                    shouldShow = userFieldSettings[component].history[field];
                }
                
                if (shouldShow) {
                    const chartContainer = createHistoryChart(field, config[field]);
                    container.appendChild(chartContainer);
                }
            }
        }

        // 创建历史数据图表
        function createHistoryChart(field, config) {
            const div = document.createElement('div');
            div.className = 'chart-container';
            div.innerHTML = `
                <div class="chart-header">
                    <h3 class="chart-title">${config.label}</h3>
                    <div class="time-range-selector">
                        <button class="time-btn active" onclick="changeHistoryRange('${field}', '24h')">24小时</button>
                        <button class="time-btn" onclick="changeHistoryRange('${field}', '7d')">7天</button>
                        <button class="time-btn" onclick="changeHistoryRange('${field}', '30d')">30天</button>
                    </div>
                </div>
                <div class="chart-wrapper" style="height: 400px !important;">
                    <canvas id="${field}Chart"></canvas>
                </div>
            `;
            
            // 延迟初始化图表
            setTimeout(() => {
                const canvas = div.querySelector('canvas');
                if (canvas) {
                    initSpecificChart(canvas, field);
                }
            }, 100);
            
            return div;
        }

        // 创建Pack电池簇卡片视图 - 每个电池簇作为一个整体卡片
        function createPackBatteryCards(packFields) {
            const container = document.createElement('div');
            container.className = 'pack-battery-cards-container';
            
            // 根据用户设置获取要显示的Pack
            const allPackData = [
                { 
                    id: 1, 
                    voltage: getFieldValue('pack1Voltage'), 
                    current: getFieldValue('pack1Current'), 
                    soc: getFieldValue('pack1Soc'), 
                    soh: getFieldValue('pack1Soh'),
                    temp: getFieldValue('pack1Temp') 
                },
                { 
                    id: 2, 
                    voltage: getFieldValue('pack2Voltage'), 
                    current: getFieldValue('pack2Current'), 
                    soc: getFieldValue('pack2Soc'), 
                    soh: getFieldValue('pack2Soh'),
                    temp: getFieldValue('pack2Temp') 
                },
                { 
                    id: 3, 
                    voltage: getFieldValue('pack3Voltage'), 
                    current: getFieldValue('pack3Current'), 
                    soc: getFieldValue('pack3Soc'), 
                    soh: getFieldValue('pack3Soh'),
                    temp: getFieldValue('pack3Temp') 
                },
                { 
                    id: 4, 
                    voltage: getFieldValue('pack4Voltage'), 
                    current: getFieldValue('pack4Current'), 
                    soc: getFieldValue('pack4Soc'), 
                    soh: getFieldValue('pack4Soh'),
                    temp: getFieldValue('pack4Temp') 
                }
            ];
            
            // 根据配置过滤要显示的Pack
            const packData = allPackData.filter(pack => {
                const packKey = `pack${pack.id}`;
                const fieldConfig = packFields[packKey];
                if (!fieldConfig) return false;
                
                // 检查用户设置
                let shouldShow = fieldConfig.default;
                if (userFieldSettings.bms && userFieldSettings.bms.realtime && userFieldSettings.bms.realtime[packKey] !== undefined) {
                    shouldShow = userFieldSettings.bms.realtime[packKey];
                }
                return shouldShow;
            });
            
            // 根据实际Pack数量设置网格
            const packCount = packData.length;
            container.style.display = 'grid';
            container.style.gridTemplateColumns = `repeat(${packCount}, minmax(250px, 1fr))`;
            container.style.gap = '25px';
            container.style.marginBottom = '20px';
            container.style.width = '100%';
            container.style.overflow = 'visible';
            
            // 添加调试信息
            console.log(`Pack容器已创建，将显示${packCount}个Pack卡片`);
            
            // 为每个Pack创建一个整体卡片
            packData.forEach(pack => {
                const packCard = document.createElement('div');
                packCard.className = 'data-card pack-cluster-card';
                
                packCard.innerHTML = `
                    <div class="pack-header">
                        <div class="pack-title">Pack${pack.id}</div>
                        <div class="pack-status">正常</div>
                    </div>
                    <div class="pack-grid">
                        <div class="pack-item">
                            <div class="pack-label">电压</div>
                            <div class="pack-value">${pack.voltage}V</div>
                        </div>
                        <div class="pack-item">
                            <div class="pack-label">电流</div>
                            <div class="pack-value">${pack.current}A</div>
                        </div>
                        <div class="pack-item">
                            <div class="pack-label">SOC</div>
                            <div class="pack-value">${pack.soc}%</div>
                        </div>
                        <div class="pack-item">
                            <div class="pack-label">SOH</div>
                            <div class="pack-value">${pack.soh}%</div>
                        </div>
                        <div class="pack-item">
                            <div class="pack-label">温度</div>
                            <div class="pack-value">${pack.temp}°C</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(packCard);
                console.log(`Pack${pack.id} 卡片已添加到容器`);
            });
            
            console.log(`总共创建了 ${packData.length} 个Pack卡片`);
            
            // 添加Pack专用样式
            const style = document.createElement('style');
            if (!document.getElementById('pack-industrial-styles')) {
                style.id = 'pack-industrial-styles';
                style.textContent = `
                    .pack-cluster-card {
                        min-height: 250px;
                        height: auto;
                        padding: 20px;
                        background: rgba(15, 25, 42, 0.8);
                        border: 2px solid rgba(0, 150, 255, 0.5);
                        margin: 0;
                    }
                    
                    .pack-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 15px;
                        border-bottom: 1px solid rgba(0, 150, 255, 0.3);
                        padding-bottom: 10px;
                    }
                    
                    .pack-title {
                        font-size: 18px;
                        font-weight: 700;
                        color: #00d4ff;
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
                    }
                    
                    .pack-status {
                        font-size: 12px;
                        color: #00ff88;
                        background: rgba(0, 255, 136, 0.1);
                        padding: 4px 8px;
                        border-radius: 4px;
                        border: 1px solid rgba(0, 255, 136, 0.3);
                    }
                    
                    .pack-grid {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    
                    .pack-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 6px 8px;
                        background: rgba(0, 150, 255, 0.05);
                        border-radius: 4px;
                    }
                    
                    .pack-label {
                        font-size: 16px;
                        color: rgba(255, 255, 255, 0.8);
                        margin-bottom: 4px;
                        font-weight: 600;
                    }
                    
                    .pack-value {
                        font-size: 18px;
                        font-weight: 700;
                        color: #ffffff;
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                        line-height: 1.2;
                    }
                `;
                document.head.appendChild(style);
            }
            
            return container;
        }

        // 创建Pack电池簇对比视图
        function createPackBatteryComparisonView(packFields) {
            const container = document.createElement('div');
            container.className = 'pack-battery-container';
            
            // 添加样式
            container.innerHTML = `
                <style>
                    .pack-battery-container {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 20px;
                        margin-bottom: 20px;
                    }
                    
                    .pack-card {
                        background: linear-gradient(135deg, rgba(15, 25, 42, 0.8) 0%, rgba(20, 35, 60, 0.6) 100%);
                        border: 1px solid rgba(0, 150, 255, 0.3);
                        border-radius: 12px;
                        padding: 20px;
                        position: relative;
                        overflow: hidden;
                        transition: all 0.3s ease;
                        backdrop-filter: blur(10px);
                    }
                    
                    .pack-card:hover {
                        border-color: rgba(0, 150, 255, 0.6);
                        transform: translateY(-2px);
                        box-shadow: 0 8px 25px rgba(0, 150, 255, 0.15);
                    }
                    
                    .pack-card.best-performance {
                        border-color: rgba(0, 255, 136, 0.6);
                        background: linear-gradient(135deg, rgba(0, 50, 25, 0.3) 0%, rgba(15, 25, 42, 0.8) 100%);
                    }
                    
                    .pack-card.needs-attention {
                        border-color: rgba(255, 193, 7, 0.6);
                        background: linear-gradient(135deg, rgba(50, 35, 0, 0.3) 0%, rgba(15, 25, 42, 0.8) 100%);
                    }
                    
                    .pack-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 15px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    }
                    
                    .pack-title {
                        font-size: 16px;
                        font-weight: 600;
                        color: rgba(255, 255, 255, 0.95);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .pack-status {
                        font-size: 12px;
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-weight: 500;
                    }
                    
                    .pack-status.excellent {
                        background: rgba(0, 255, 136, 0.2);
                        color: #00ff88;
                    }
                    
                    .pack-status.good {
                        background: rgba(0, 255, 136, 0.2);
                        color: #00ff88;
                    }
                    
                    .pack-status.warning {
                        background: rgba(255, 221, 0, 0.2);
                        color: #ffdd00;
                    }
                    
                    .pack-metrics {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                    }
                    
                    .metric-item {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }
                    
                    .metric-label {
                        font-size: 11px;
                        color: rgba(255, 255, 255, 0.6);
                        font-weight: 500;
                    }
                    
                    .metric-value {
                        font-size: 14px;
                        font-weight: 600;
                        color: rgba(255, 255, 255, 0.95);
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }
                    
                    .metric-trend {
                        font-size: 10px;
                        opacity: 0.8;
                    }
                    
                    .trend-up { color: #00ff88; }
                    .trend-down { color: #ff4757; }
                    .trend-stable { color: #ffc107; }
                    
                    .pack-comparison-summary {
                        grid-column: 1 / -1;
                        background: rgba(15, 25, 42, 0.6);
                        border: 1px solid rgba(0, 150, 255, 0.2);
                        border-radius: 8px;
                        padding: 15px;
                        margin-top: 15px;
                    }
                    
                    .comparison-title {
                        font-size: 14px;
                        font-weight: 600;
                        color: rgba(255, 255, 255, 0.9);
                        margin-bottom: 10px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .comparison-stats {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 15px;
                        font-size: 12px;
                    }
                    
                    .stat-item {
                        text-align: center;
                    }
                    
                    .stat-label {
                        color: rgba(255, 255, 255, 0.6);
                        margin-bottom: 4px;
                    }
                    
                    .stat-value {
                        color: rgba(255, 255, 255, 0.95);
                        font-weight: 600;
                    }
                </style>
            `;
            
            // 获取Pack数据
            const packs = [
                { 
                    id: 1, 
                    voltage: getFieldValue('pack1Voltage'), 
                    current: getFieldValue('pack1Current'), 
                    soc: getFieldValue('pack1Soc'), 
                    temp: getFieldValue('pack1Temp') 
                },
                { 
                    id: 2, 
                    voltage: getFieldValue('pack2Voltage'), 
                    current: getFieldValue('pack2Current'), 
                    soc: getFieldValue('pack2Soc'), 
                    temp: getFieldValue('pack2Temp') 
                },
                { 
                    id: 3, 
                    voltage: getFieldValue('pack3Voltage'), 
                    current: getFieldValue('pack3Current'), 
                    soc: getFieldValue('pack3Soc'), 
                    temp: getFieldValue('pack3Temp') 
                },
                { 
                    id: 4, 
                    voltage: getFieldValue('pack4Voltage'), 
                    current: getFieldValue('pack4Current'), 
                    soc: getFieldValue('pack4Soc'), 
                    temp: getFieldValue('pack4Temp') 
                }
            ];
            
            // 计算统计数据
            const avgVoltage = packs.reduce((sum, p) => sum + parseFloat(p.voltage), 0) / packs.length;
            const avgSOC = packs.reduce((sum, p) => sum + parseFloat(p.soc), 0) / packs.length;
            const avgTemp = packs.reduce((sum, p) => sum + parseFloat(p.temp), 0) / packs.length;
            const maxTemp = Math.max(...packs.map(p => parseFloat(p.temp)));
            const minTemp = Math.min(...packs.map(p => parseFloat(p.temp)));
            const tempDiff = maxTemp - minTemp;
            
            // 创建Pack卡片
            packs.forEach(pack => {
                const packCard = document.createElement('div');
                const soc = parseFloat(pack.soc);
                const temp = parseFloat(pack.temp);
                const voltage = parseFloat(pack.voltage);
                
                // 判断Pack状态
                let statusClass = 'good';
                let statusText = '正常';
                let cardClass = '';
                
                if (soc > avgSOC && temp < avgTemp && voltage > avgVoltage - 1) {
                    statusClass = 'excellent';
                    statusText = '优秀';
                    cardClass = 'best-performance';
                } else if (soc < avgSOC - 5 || temp > avgTemp + 2 || Math.abs(voltage - avgVoltage) > 2) {
                    statusClass = 'warning';
                    statusText = '关注';
                    cardClass = 'needs-attention';
                }
                
                packCard.className = `pack-card ${cardClass}`;
                packCard.innerHTML = `
                    <div class="pack-header">
                        <div class="pack-title">
                            🔋 Pack ${pack.id}
                        </div>
                        <div class="pack-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="pack-metrics">
                        <div class="metric-item">
                            <div class="metric-label">电压</div>
                            <div class="metric-value">
                                ${pack.voltage}<span style="font-size: 10px; margin-left: 2px;">V</span>
                                <span class="metric-trend ${voltage > avgVoltage ? 'trend-up' : voltage < avgVoltage ? 'trend-down' : 'trend-stable'}">
                                    ${voltage > avgVoltage ? '↑' : voltage < avgVoltage ? '↓' : '~'}
                                </span>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">电流</div>
                            <div class="metric-value">
                                ${pack.current}<span style="font-size: 10px; margin-left: 2px;">A</span>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">SOC</div>
                            <div class="metric-value">
                                ${pack.soc}<span style="font-size: 10px; margin-left: 2px;">%</span>
                                <span class="metric-trend ${soc > avgSOC ? 'trend-up' : soc < avgSOC ? 'trend-down' : 'trend-stable'}">
                                    ${soc > avgSOC ? '↑' : soc < avgSOC ? '↓' : '~'}
                                </span>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">温度</div>
                            <div class="metric-value">
                                ${pack.temp}<span style="font-size: 10px; margin-left: 2px;">°C</span>
                                <span class="metric-trend ${temp > avgTemp ? 'trend-up' : temp < avgTemp ? 'trend-down' : 'trend-stable'}">
                                    ${temp > avgTemp ? '↑' : temp < avgTemp ? '↓' : '~'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(packCard);
            });
            
            // 添加对比统计摘要
            const summaryCard = document.createElement('div');
            summaryCard.className = 'pack-comparison-summary';
            summaryCard.innerHTML = `
                <div class="comparison-title">
                    📊 集群统计对比
                </div>
                <div class="comparison-stats">
                    <div class="stat-item">
                        <div class="stat-label">平均电压</div>
                        <div class="stat-value">${avgVoltage.toFixed(1)}V</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">平均SOC</div>
                        <div class="stat-value">${avgSOC.toFixed(1)}%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">温度范围</div>
                        <div class="stat-value">${minTemp.toFixed(1)}~${maxTemp.toFixed(1)}°C</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">温差</div>
                        <div class="stat-value" style="color: ${tempDiff > 3 ? '#ffc107' : '#00ff88'}">${tempDiff.toFixed(1)}°C</div>
                    </div>
                </div>
            `;
            container.appendChild(summaryCard);
            
            return container;
        }

        // 创建三相参数卡片
        function createThreePhaseCard(field, config) {
            // 所有实时数据都不显示图标
            const showIcon = false;
            const card = document.createElement('div');
            card.className = 'data-card three-phase-card';
            card.style.cssText = 'height: auto !important; min-height: 130px;';
            
            const isPower = config.type === 'three-phase-power';
            
            // 获取三相数据
            const phaseA = getFieldValue(field + 'A');
            const phaseB = getFieldValue(field + 'B');
            const phaseC = getFieldValue(field + 'C');
            const total = isPower ? getFieldValue('totalPower') : null;
            
            card.innerHTML = `
                <div class="card-title" style="font-size: 18px; margin-bottom: 8px; color: rgba(255, 255, 255, 0.85); font-weight: 600;">
                    ${showIcon ? `<span class="card-icon">${getFieldIcon(field)}</span>` : ''}
                    ${config.label}
                </div>
                <div class="three-phase-list" style="
                    display: flex;
                    flex-direction: column;
                    gap: 6px;
                ">
                    <div class="phase-row" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 5px 0;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    ">
                        <span class="phase-label" style="
                            font-size: 16px;
                            color: #ffffff;
                            font-weight: 500;
                            min-width: 45px;
                        ">A相</span>
                        <span class="phase-value" style="
                            font-size: 18px;
                            color: #ffffff;
                            font-weight: bold;
                            text-align: right;
                        ">${phaseA} ${config.unit}</span>
                    </div>
                    <div class="phase-row" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 5px 0;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    ">
                        <span class="phase-label" style="
                            font-size: 16px;
                            color: #ffffff;
                            font-weight: 500;
                            min-width: 45px;
                        ">B相</span>
                        <span class="phase-value" style="
                            font-size: 18px;
                            color: #ffffff;
                            font-weight: bold;
                            text-align: right;
                        ">${phaseB} ${config.unit}</span>
                    </div>
                    <div class="phase-row" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 5px 0;
                    ">
                        <span class="phase-label" style="
                            font-size: 16px;
                            color: #ffffff;
                            font-weight: 500;
                            min-width: 45px;
                        ">C相</span>
                        <span class="phase-value" style="
                            font-size: 18px;
                            color: #ffffff;
                            font-weight: bold;
                            text-align: right;
                        ">${phaseC} ${config.unit}</span>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // 创建数据卡片
        function createDataCard(field, config) {
            // 检查是否是三相参数
            if (config.type === 'three-phase' || config.type === 'three-phase-power') {
                return createThreePhaseCard(field, config);
            }
            
            // 所有实时数据都不显示图标
            const showIcon = false;
            
            const card = document.createElement('div');
            card.className = 'data-card';
            
            // 检查是否有预定义的值（用于EMS等特殊组件）
            if (config.value !== undefined) {
                const statusColor = config.statusColor || '#666';
                
                // 特殊处理不同类型的值显示
                if (field === 'dispatch' && config.subValue) {
                    // 调度指令特殊处理
                    card.innerHTML = `
                        <div class="card-title">
                            ${showIcon ? `<span class="card-icon">${getFieldIcon(field)}</span>` : ''}
                            ${config.label}
                        </div>
                        <div class="card-value">
                            <span style="font-size: 24px; color: ${statusColor};">${config.value}</span>
                        </div>
                        <div style="font-size: 16px; color: ${statusColor}; margin-top: 4px;">${config.subValue}</div>
                    `;
                } else if (config.unit) {
                    // 有单位的数值
                    card.innerHTML = `
                        <div class="card-title">
                            ${showIcon ? `<span class="card-icon">${getFieldIcon(field)}</span>` : ''}
                            ${config.label}
                        </div>
                        <div class="card-value">
                            <span id="${field}Value">${config.value}</span>
                            <span class="card-unit">${config.unit}</span>
                        </div>
                        ${config.status ? `<div style="font-size: 16px; color: ${statusColor || '#666'}; margin-top: 4px;">${config.status}</div>` : ''}
                    `;
                } else {
                    // 纯文本值
                    card.innerHTML = `
                        <div class="card-title">
                            ${showIcon ? `<span class="card-icon">${getFieldIcon(field)}</span>` : ''}
                            ${config.label}
                        </div>
                        <div class="card-value">
                            <span style="font-size: 24px; color: ${statusColor};">${config.value}</span>
                        </div>
                        ${config.status ? `<div style="font-size: 16px; color: ${statusColor || '#666'}; margin-top: 4px;">${config.status}</div>` : ''}
                    `;
                }
            } else {
                // 使用原有的动态值逻辑
                const statusText = getFieldStatus(field);
                const statusClass = getStatusClass(statusText);
                const fieldValue = getFieldValue(field);
                
                // 检查是否是状态型字段（消防系统的探测器等）
                const isStatusOnlyField = ['smokeDetector1', 'smokeDetector2', 'tempDetector1', 'tempDetector2', 
                                         'fireAlarmStatus', 'extinguisherStatus', 'emergencyStop', 'evacuationAlarm'].includes(field);
                
                if (isStatusOnlyField) {
                    // 状态型字段只显示状态，不显示数值
                    const statusColor = statusClass === 'warning' || statusClass === 'error' ? '#ffdd00' : '#00ff88';
                    card.innerHTML = `
                        <div class="card-title">
                            ${showIcon ? `<span class="card-icon">${getFieldIcon(field)}</span>` : ''}
                            ${config.label}
                        </div>
                        <div class="card-value" style="font-size: 24px; color: ${statusColor}; padding: 15px 0;">
                            <span>${statusText}</span>
                        </div>
                    `;
                } else {
                    // 普通字段显示数值和状态
                    card.innerHTML = `
                        <div class="card-title">
                            ${showIcon ? `<span class="card-icon">${getFieldIcon(field)}</span>` : ''}
                            ${config.label}
                        </div>
                        <div class="card-value">
                            <span id="${field}Value">${fieldValue}</span>
                            ${config.unit ? `<span class="card-unit">${config.unit}</span>` : ''}
                        </div>
                        ${statusText ? `<div class="card-status ${statusClass}">
                            <span>${statusText}</span>
                        </div>` : ''}
                    `;
                }
            }
            
            return card;
        }

        // 根据状态文字返回对应的CSS类
        function getStatusClass(statusText) {
            if (statusText.includes('良好') || statusText.includes('充足') || statusText.includes('健康') || 
                statusText.includes('正常') || statusText.includes('稳定') || statusText.includes('运行') ||
                statusText.includes('优秀') || statusText.includes('在线') || statusText.includes('启用') ||
                statusText.includes('正常工作') || statusText.includes('正常状态')) {
                return 'normal'; // 绿色 - 好的状态
            } else if (statusText.includes('警告') || statusText.includes('偏高') || statusText.includes('偏低') ||
                       statusText.includes('错误') || statusText.includes('故障') || statusText.includes('异常') ||
                       statusText.includes('关注') || statusText.includes('未启动') || statusText.includes('停止')) {
                return 'warning'; // 黄色 - 不好的状态
            }
            return 'normal'; // 默认绿色
        }

        // 获取字段图标
        function getFieldIcon(field) {
            const iconMap = {
                // 核心运行参数
                soc: '🔋',
                soh: '💚',
                temperature: '🌡️',
                power: '⚡',
                batteryCurrent: '📈',
                batteryVoltage: '📊',
                
                // 运行统计
                todayCharge: '🔋',
                todayDischarge: '⚡',
                totalCharge: '📈',
                totalDischarge: '📉',
                
                // 其他参数
                cycles: '🔄',
                
                // 策略调度参数
                strategy: '📋',
                dispatch: '🎯',
                targetSOC: '🎯',
                maxPower: '⚡',
                
                // 通信控制参数
                communication: '📡',
                responseTime: '⏱️',
                agc: '📊',
                gridFrequency: '〰️',
                powerDeviation: '📈',
                protectionStatus: '🛡️',
                
                // EMS控制器
                cpuUsage: '💻',
                cpuTemp: '🌡️',
                memoryUsage: '💾',
                diskUsage: '💿',
                boardTemp: '🌡️',
                signalStrength: '📶',
                simStatus: '📱',
                networkStatus: '🌐',
                wifiSignal: '📶',
                wifiConnection: '📡',
                runTime: '',  // 移除时钟图标
                systemTime: '',  // 移除时钟图标
                hardwareTime: '',  // 移除时钟图标
                
                // PCS逆变器
                acVoltage: '📊',
                acCurrent: '📈',
                frequency: '〰️',
                powerFactor: '📐',
                
                // BMS系统 - 实时数据
                totalVoltage: '⚡',
                totalCurrent: '🔌',
                batteryPower: '🔋',
                soc: '📊',
                soh: '💯',
                pack: '📦',
                cycles: '🔄',
                
                // BMS系统 - 运行统计
                dailyCharge: '🔋',
                dailyDischarge: '⚡',
                totalCharge: '📈',
                totalDischarge: '📉',
                
                // 电池模组
                nominalCapacity: '🔋',
                batteryActualCapacity: '📊',
                batteryEnergyDensity: '⚡',
                batteryCRate: '📈',
                batteryDod: '📉',
                batteryWeight: '⚖️',
                batteryEfficiency: '💯',
                batteryAgingRate: '📅',
                
                // 温控系统 - 核心监控参数
                battMaxTemp: '🌡️',
                battMinTemp: '🌡️',
                battAvgTemp: '🌡️',
                battTempDiff: '📊',
                inletTemp: '🌡️',
                outletTemp: '🌡️',
                humidity: '💧',
                coolantTemp: '🌡️',
                
                // 温控系统 - 运行状态
                thermalManagementStatus: '🌡️',
                runningMode: '❄️',
                
                // 消防系统
                smokeLevel: '💨',
                fireAlarm: '🚨',
                extinguisherStatus: '🧯',
                emergencyStop: '🛑',
                
                // 电表系统 - 电能计量
                totalActivePower: '🏭',
                totalReactivePower: '🌊',
                totalApparentPower: '💎',
                frequency: '⚡',
                
                // 电表系统 - 电压电流
                meterVoltage: '🔺',
                meterCurrent: '🔃',
                
                // 电表系统 - 电能统计
                dailyActiveEnergy: '📄',
                dailyReactiveEnergy: '🌀',
                totalActiveEnergy: '📚',
                totalReactiveEnergy: '💰'
            };
            return iconMap[field] || '📊';
        }

        // 获取字段值（模拟数据）
        function getFieldValue(field) {
            const valueMap = {
                // 整机概览 - 核心运行参数
                soc: (85 + Math.random() * 10).toFixed(1),
                soh: (96 + Math.random() * 2).toFixed(1),
                temperature: (25 + Math.random() * 10).toFixed(1),
                power: (Math.random() > 0.5 ? '+' : '-') + (100 + Math.random() * 50).toFixed(1),
                batteryCurrent: (150 + Math.random() * 50).toFixed(1),
                batteryVoltage: (750 + Math.random() * 20).toFixed(1),
                
                // 整机概览 - 运行统计
                todayCharge: (850 + Math.random() * 100).toFixed(1),
                todayDischarge: (720 + Math.random() * 100).toFixed(1),
                totalCharge: (186.5 + Math.random() * 0.5).toFixed(1),
                totalDischarge: (179.0 + Math.random() * 0.5).toFixed(1),
                
                // 整机概览 - 其他参数
                cycles: Math.floor(1850 + Math.random() * 50),
                maxPower: '250',
                
                // EMS控制器 - CPU状态
                cpuUsage: '35',
                cpuTemp: '45',
                
                // EMS控制器 - 内存状态
                memoryUsage: '62',
                
                // EMS控制器 - 磁盘状态
                diskUsage: '35',
                
                // EMS控制器 - 开发板温度
                boardTemp: '38',
                
                // EMS控制器 - 4G网络状态
                signalStrength: '-65',
                simStatus: '已插入',
                networkStatus: '开',
                
                // EMS控制器 - WiFi状态
                wifiSignal: '-79',
                wifiConnection: '关',
                
                // EMS控制器 - 系统信息
                runTime: '15天 8小时 32分',  // 保留数值但不显示时钟
                systemTime: '2025-07-11 09:42',
                hardwareTime: '2025-07-11 09:42',
                
                // PCS逆变器 - 电网侧电压（三相）
                gridVoltageA: (380 + Math.random() * 10).toFixed(1),
                gridVoltageB: (378 + Math.random() * 12).toFixed(1),
                gridVoltageC: (382 + Math.random() * 8).toFixed(1),
                
                // PCS逆变器 - 电网侧电流（三相）
                gridCurrentA: (85 + Math.random() * 15).toFixed(1),
                gridCurrentB: (87 + Math.random() * 13).toFixed(1),
                gridCurrentC: (83 + Math.random() * 17).toFixed(1),
                
                // PCS逆变器 - 电网侧功率（三相）
                gridPowerA: (40 + Math.random() * 20).toFixed(1),
                gridPowerB: (42 + Math.random() * 18).toFixed(1),
                gridPowerC: (38 + Math.random() * 22).toFixed(1),
                totalPower: (120 + Math.random() * 50).toFixed(1),
                
                // PCS逆变器 - 温度
                transformerTemp: (50 + Math.random() * 5).toFixed(1),
                
                // 电表系统 - 电能计量
                totalActivePower: (150 + Math.random() * 100).toFixed(1),
                totalReactivePower: (25 + Math.random() * 15).toFixed(1),
                totalApparentPower: (155 + Math.random() * 105).toFixed(1),
                frequency: (49.95 + Math.random() * 0.1).toFixed(2),
                
                // 电表系统 - 电压电流（三相数据）
                meterVoltageA: (380 + Math.random() * 10).toFixed(1),
                meterVoltageB: (381 + Math.random() * 9).toFixed(1),
                meterVoltageC: (379 + Math.random() * 11).toFixed(1),
                meterCurrentA: (125 + Math.random() * 50).toFixed(1),
                meterCurrentB: (128 + Math.random() * 48).toFixed(1),
                meterCurrentC: (122 + Math.random() * 52).toFixed(1),
                
                // 电表系统 - 电能统计
                dailyActiveEnergy: (1250 + Math.random() * 200).toFixed(1),
                dailyReactiveEnergy: (180 + Math.random() * 40).toFixed(1),
                totalActiveEnergy: (45.2 + Math.random() * 10).toFixed(1),
                totalReactiveEnergy: (6.8 + Math.random() * 2).toFixed(1),
                
                // BMS系统 - 实时数据
                totalVoltage: (756 + Math.random() * 20).toFixed(1),
                totalCurrent: (150 + Math.random() * 50).toFixed(1),
                batteryPower: (120 + Math.random() * 80).toFixed(1),
                soc: (85 + Math.random() * 10).toFixed(1),
                soh: (96 + Math.random() * 2).toFixed(1),
                pack: 4,
                cycles: (2847 + Math.floor(Math.random() * 100)),
                
                // BMS系统 - 运行统计
                dailyCharge: (286.5 + Math.random() * 50).toFixed(1),
                dailyDischarge: (245.8 + Math.random() * 40).toFixed(1),
                totalCharge: (1247.3 + Math.random() * 100).toFixed(1),
                totalDischarge: (1156.8 + Math.random() * 80).toFixed(1),
                
                // BMS系统 - Pack电池簇信息
                pack1Voltage: (189 + Math.random() * 5).toFixed(1),
                pack1Current: (37.5 + Math.random() * 12.5).toFixed(1),
                pack1Soc: (85 + Math.random() * 8).toFixed(1),
                pack1Soh: (96 + Math.random() * 3).toFixed(1),
                pack1Temp: (28 + Math.random() * 4).toFixed(1),
                pack2Voltage: (188.5 + Math.random() * 5).toFixed(1),
                pack2Current: (38 + Math.random() * 12).toFixed(1),
                pack2Soc: (84.5 + Math.random() * 8).toFixed(1),
                pack2Soh: (95.5 + Math.random() * 3).toFixed(1),
                pack2Temp: (29 + Math.random() * 4).toFixed(1),
                pack3Voltage: (189.2 + Math.random() * 5).toFixed(1),
                pack3Current: (37.8 + Math.random() * 12.2).toFixed(1),
                pack3Soc: (85.2 + Math.random() * 7.8).toFixed(1),
                pack3Soh: (96.2 + Math.random() * 2.8).toFixed(1),
                pack3Temp: (27.5 + Math.random() * 4.5).toFixed(1),
                pack4Voltage: (188.8 + Math.random() * 5).toFixed(1),
                pack4Current: (38.2 + Math.random() * 11.8).toFixed(1),
                pack4Soc: (84.8 + Math.random() * 8.2).toFixed(1),
                pack4Soh: (95.8 + Math.random() * 3.2).toFixed(1),
                pack4Temp: (28.5 + Math.random() * 4).toFixed(1),
                
                // 温控系统 - 核心监控参数
                battMaxTemp: (35 + Math.random() * 5).toFixed(1),
                battMinTemp: (25 + Math.random() * 3).toFixed(1),
                battAvgTemp: (30 + Math.random() * 3).toFixed(1),
                battTempDiff: (5 + Math.random() * 3).toFixed(1),
                inletTemp: (32 + Math.random() * 3).toFixed(1),
                outletTemp: (26 + Math.random() * 2).toFixed(1),
                humidity: (45 + Math.random() * 10).toFixed(1),
                coolantTemp: (22 + Math.random() * 3).toFixed(1),
                
                // 温控系统 - 运行状态
                thermalManagementStatus: (28 + Math.random() * 5).toFixed(1),
                runningMode: Math.random() > 0.3 ? '制冷' : '制热',
                
                // 消防系统 - 火灾探测
                smokeDetector1: '',  // 状态型字段，不显示数值
                fireAlarmStatus: '',  // 状态型字段，不显示数值
                
                // 消防系统 - 消防联动
                extinguisherStatus: '',  // 状态型字段，不显示数值
                emergencyStop: '',  // 状态型字段，不显示数值
                evacuationAlarm: ''  // 状态型字段，不显示数值
            };
            return valueMap[field] || '0';
        }

        // 获取字段状态
        function getFieldStatus(field) {
            const statusMap = {
                // 整机概览 - 核心运行参数
                soc: '电量充足',
                soh: '健康良好',
                temperature: '温度正常',
                power: '充电中',
                batteryCurrent: '电流正常',
                batteryVoltage: '电压稳定',
                
                // 整机概览 - 运行统计
                todayCharge: '',
                todayDischarge: '',
                totalCharge: '',
                totalDischarge: '',
                
                // 整机概览 - 其他参数
                cycles: '健康范围',
                maxPower: '',
                
                // EMS控制器
                cpuUsage: '',
                cpuTemp: '温度正常',
                memoryUsage: '',
                diskUsage: '',
                boardTemp: '温度正常',
                signalStrength: '信号良好',
                simStatus: '',
                networkStatus: '',
                wifiSignal: '信号良好',
                wifiConnection: '',
                runTime: '',
                systemTime: '',
                hardwareTime: '',
                
                // PCS逆变器 - 电网侧电压
                gridVoltageA: 'A相电压正常',
                gridVoltageB: 'B相电压正常',
                gridVoltageC: 'C相电压正常',
                
                // PCS逆变器 - 电网侧电流
                gridCurrentA: 'A相电流稳定',
                gridCurrentB: 'B相电流稳定',
                gridCurrentC: 'C相电流稳定',
                
                // PCS逆变器 - 电网侧功率
                gridPowerA: 'A相功率正常',
                gridPowerB: 'B相功率正常',
                gridPowerC: 'C相功率正常',
                totalPower: '总功率稳定',
                
                // PCS逆变器 - 温度
                transformerTemp: '温度正常',
                
                // 电表系统 - 电能计量
                totalActivePower: '',
                totalReactivePower: '',
                totalApparentPower: '',
                frequency: '',
                
                // 电表系统 - 电压电流
                meterVoltageA: '',
                meterVoltageB: '',
                meterVoltageC: '',
                meterCurrentA: '',
                meterCurrentB: '',
                meterCurrentC: '',
                
                // 电表系统 - 电能统计
                dailyActiveEnergy: '',
                dailyReactiveEnergy: '',
                totalActiveEnergy: '',
                totalReactiveEnergy: '',
                
                // BMS系统 - 实时数据
                totalVoltage: '电压正常',
                totalCurrent: '电流稳定',
                batteryPower: '功率稳定',
                soc: '',
                soh: 'SOH良好',
                pack: '',
                cycles: '寿命正常',
                
                // BMS系统 - 运行统计
                dailyCharge: '',
                dailyDischarge: '',
                totalCharge: '',
                totalDischarge: '',
                
                // BMS系统 - 单体电芯监控
                maxCellVoltage: '最高电压正常',
                minCellVoltage: '最低电压正常',
                voltageDiff: '压差正常',
                consistency: '一致性良好',
                abnormalCells: '无异常',
                totalCells: '数量正确',
                samplingAccuracy: '精度良好',
                
                // BMS系统 - 安全保护参数
                overvoltageProtection: '保护正常',
                undervoltageProtection: '保护正常',
                overcurrentProtection: '保护正常',
                overtemperatureProtection: '保护正常',
                shortcircuitProtection: '保护正常',
                faultCode: '无故障',
                hardwareVersion: '最新版本',
                
                // 电池模组 - 电池性能参数
                nominalCapacity: '设计容量',
                batteryActualCapacity: '运行容量',
                batteryEnergyDensity: '高能量密度',
                batteryCRate: '标准倍率',
                batteryDod: '深度放电',
                batteryWeight: '标准重量',
                batteryEfficiency: '高效运行',
                batteryAgingRate: '正常老化',
                
                // 温控系统 - 核心监控参数
                battMaxTemp: '温度正常',
                battMinTemp: '温度正常',
                battAvgTemp: '平均温度正常',
                battTempDiff: '温差正常',
                inletTemp: '进风温度正常',
                outletTemp: '出风温度正常',
                humidity: '湿度正常',
                coolantTemp: '冷却液温度正常',
                
                // 温控系统 - 运行状态
                thermalManagementStatus: '温度正常',
                runningMode: '',
                
                // 消防系统 - 火灾探测
                smokeDetector1: '探测器正常',
                fireAlarmStatus: '火警状态正常',
                
                // 消防系统 - 消防联动
                extinguisherStatus: '灭火器就绪',
                emergencyStop: '未触发',
                evacuationAlarm: '警报正常'
            };
            return statusMap[field] || '';
        }

        // 初始化特定图表
        function initSpecificChart(canvas, type) {
            const ctx = canvas.getContext('2d');
            
            switch(type) {
                case 'powerHistory':
                    // 功率曲线
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => i + ':00'),
                            datasets: [{
                                label: '功率 (kW)',
                                data: Array.from({length: 24}, () => (Math.random() - 0.5) * 200),
                                borderColor: '#00d4ff',
                                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: getChartOptions('功率 (kW)')
                    });
                    break;
                    
                case 'socHistory':
                    // SOC与充放电状态
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => i + ':00'),
                            datasets: [{
                                label: 'SOC (%)',
                                data: Array.from({length: 24}, (_, i) => {
                                    const base = 85;
                                    return base + Math.sin(i * 0.3) * 15;
                                }),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: getChartOptions('SOC (%)', 0, 100)
                    });
                    break;
                    
                case 'tempHistory':
                    // 电池温度分布
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => i + ':00'),
                            datasets: [{
                                label: '最高温度',
                                data: Array.from({length: 24}, () => 25 + Math.random() * 10),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4
                            }, {
                                label: '平均温度',
                                data: Array.from({length: 24}, () => 22 + Math.random() * 8),
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4
                            }, {
                                label: '最低温度',
                                data: Array.from({length: 24}, () => 20 + Math.random() * 6),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: getChartOptions('温度 (°C)')
                    });
                    break;
                    
                case 'voltageConsistency':
                    // 电压一致性
                    new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: '电压分布',
                                data: Array.from({length: 100}, () => ({
                                    x: Math.random() * 100,
                                    y: 3.2 + Math.random() * 0.6
                                })),
                                backgroundColor: 'rgba(0, 212, 255, 0.6)',
                                borderColor: '#00d4ff'
                            }]
                        },
                        options: getChartOptions('电压 (V)', 3.0, 4.0)
                    });
                    break;
                    
                case 'efficiencyAnalysis':
                    // 充放电效率分析
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                            datasets: [{
                                label: '充电效率 (%)',
                                data: Array.from({length: 6}, () => 92 + Math.random() * 6),
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: '#10b981'
                            }, {
                                label: '放电效率 (%)',
                                data: Array.from({length: 6}, () => 90 + Math.random() * 8),
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: '#3b82f6'
                            }]
                        },
                        options: getChartOptions('效率 (%)', 80, 100)
                    });
                    break;
                    
                case 'arbitrageAnalysis':
                    // 峰谷套利分析
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                            datasets: [{
                                label: '电价 (元/kWh)',
                                data: [0.3, 0.28, 0.65, 0.58, 0.72, 0.45],
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                yAxisID: 'y'
                            }, {
                                label: '功率 (kW)',
                                data: [150, 120, -180, -160, -200, 100],
                                borderColor: '#00d4ff',
                                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            ...getChartOptions(),
                            scales: {
                                x: {
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                    ticks: { 
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        font: { size: 14 }
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: '电价 (元/kWh)', color: 'rgba(255, 255, 255, 0.8)' },
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                    ticks: { 
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        font: { size: 14 }
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: '功率 (kW)', color: 'rgba(255, 255, 255, 0.8)' },
                                    grid: { drawOnChartArea: false },
                                    ticks: { 
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        font: { size: 14 }
                                    }
                                }
                            }
                        }
                    });
                    break;
                    
                case 'sohTrend':
                    // 健康度趋势
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['2024-01', '2024-03', '2024-05', '2024-07', '2024-09', '2024-11'],
                            datasets: [{
                                label: 'SOH (%)',
                                data: [100, 99.2, 98.5, 97.8, 97.1, 96.8],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: getChartOptions('SOH (%)', 95, 100)
                    });
                    break;
                    
                default:
                    // 默认图表
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array(24).fill('').map((_, i) => i + ':00'),
                            datasets: [{
                                label: '数据趋势',
                                data: Array(24).fill(0).map(() => Math.random() * 100),
                                borderColor: '#00d4ff',
                                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: getChartOptions()
                    });
            }
        }

        // 获取图表通用配置
        function getChartOptions(yAxisTitle = '', minY = null, maxY = null) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { 
                            color: 'rgba(255, 255, 255, 0.9)',
                            font: { size: 16 }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { 
                            color: 'rgba(255, 255, 255, 0.7)',
                            font: { size: 14 }
                        }
                    },
                    y: {
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { 
                            color: 'rgba(255, 255, 255, 0.7)',
                            font: { size: 14 }
                        },
                        title: yAxisTitle ? { 
                            display: true, 
                            text: yAxisTitle, 
                            color: 'rgba(255, 255, 255, 0.8)' 
                        } : undefined,
                        min: minY,
                        max: maxY
                    }
                }
            };
        }

        // 页面导航功能
        function switchPage(page) {
            if (page === 'home') {
                window.location.href = 'index.html';
            } else if (page === 'data') {
                window.location.href = 'data.html';
            } else if (page === 'control') {
                window.location.href = 'control.html';
            } else if (page === 'alarm') {
                window.location.href = 'alarm.html';
            } else if (page === 'history') {
                window.location.href = 'history.html';
            } else if (page === 'log') {
                window.location.href = 'logs.html';
            } else if (page === 'settings') {
                window.location.href = 'settings.html';
            }
        }

        // 更新时间
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeStr;
        }
        
        // 更新组件状态
        function updateComponentStatuses() {
            const components = ['pcs', 'bms', 'meter', 'thermal', 'fire'];
            
            // 随机选择一个组件显示离线
            const offlineIndex = Math.floor(Math.random() * components.length);
            
            // 随机选择一个组件显示异常（不能是离线的那个）
            let errorIndex;
            do {
                errorIndex = Math.floor(Math.random() * components.length);
            } while (errorIndex === offlineIndex);
            
            components.forEach((component, index) => {
                const statusElement = document.getElementById(`${component}-status`);
                if (statusElement) {
                    let status;
                    if (index === offlineIndex) {
                        // 这个组件显示离线
                        status = { text: '离线', class: 'status-offline' };
                    } else if (index === errorIndex) {
                        // 这个组件显示异常
                        status = { text: '异常', class: 'status-error' };
                    } else {
                        // 其他组件显示正常
                        status = { text: '正常', class: 'status-normal' };
                    }
                    
                    // 更新状态文本和样式
                    statusElement.textContent = status.text;
                    statusElement.className = `component-status ${status.class}`;
                }
            });
        }

        // 语言翻译配置
        const translations = {
            zh: {
                // 页面标题
                pageTitle: '数据监控',
                currentTime: '当前时间',
                switchLanguage: '切换语言',
                
                // 导航菜单
                overview: '整机',
                ems: 'EMS',
                pcs: 'PCS',
                meter: '电表',
                bms: 'BMS',
                thermal: '温度',
                fire: '消防',
                
                // 标签页
                realtimeData: '实时数据',
                historyData: '历史数据',
                customize: '自定义',
                
                // 确认对话框
                cancel: '取消',
                confirm: '确定',
                
                // 字段设置
                fieldSettings: '字段设置',
                save: '保存',
                
                // 储能柜状态
                cabinetStatus: '储能柜状态',
                onlineRunning: '在线运行',
                
                // 数据节标题
                coreParams: '核心运行参数',
                runStats: '运行统计',
                otherParams: '其他参数',
                strategySchedule: '策略调度参数',
                commControl: '通信控制参数',
                batteryStatus: '电池状态参数',
                systemManagement: '系统管理',
                moduleBasicInfo: '模组基本信息',
                cellMonitoring: '单体监控',
                acSystem: '空调系统',
                fanSystem: '风扇系统',
                fireDetection: '火灾探测',
                fireLinkage: '消防联动'
            },
            en: {
                // Page titles
                pageTitle: 'Data Monitoring',
                currentTime: 'Current Time',
                switchLanguage: 'Switch Language',
                
                // Navigation menu
                overview: 'System',
                ems: 'EMS',
                pcs: 'PCS',
                meter: 'Meter',
                bms: 'BMS',
                thermal: 'Temperature',
                fire: 'Fire Protection',
                
                // Tabs
                realtimeData: 'Real-time Data',
                historyData: 'History Data',
                customize: 'Customize',
                
                // Confirmation dialog
                cancel: 'Cancel',
                confirm: 'Confirm',
                
                // Field settings
                fieldSettings: 'Field Settings',
                save: 'Save',
                
                // Cabinet status
                cabinetStatus: 'Cabinet Status',
                onlineRunning: 'Online Running',
                
                // Data section titles
                coreParams: 'Core Operating Parameters',
                runStats: 'Running Statistics',
                otherParams: 'Other Parameters',
                strategySchedule: 'Strategy Scheduling Parameters',
                commControl: 'Communication Control Parameters',
                powerConversion: 'Power Conversion Parameters',
                deviceOperation: 'Device Operation Parameters',
                batteryStatus: 'Battery Status Parameters',
                systemManagement: 'System Management',
                moduleBasicInfo: 'Module Basic Info',
                cellMonitoring: 'Cell Monitoring',
                acSystem: 'AC System',
                fanSystem: 'Fan System',
                fireDetection: 'Fire Detection',
                fireLinkage: 'Fire Linkage'
            }
        };
        
        // 当前语言
        let currentLang = localStorage.getItem('touchscreen_lang') || 'zh';
        
        // 应用语言
        function applyLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            // 更新页面标题
            document.title = t.pageTitle + ' - 储能监控系统';
            
            // 更新导航菜单
            document.querySelectorAll('.component-item span:first-child').forEach((el, index) => {
                const keys = ['overview', 'ems', 'pcs', 'bms', 'meter', 'thermal', 'fire'];
                if (keys[index]) {
                    el.textContent = t[keys[index]];
                }
            });
            
            // 更新储能柜状态
            const cabinetTitle = document.querySelector('.cabinet-status-title');
            if (cabinetTitle) cabinetTitle.textContent = t.cabinetStatus;
            
            const cabinetText = document.querySelector('.cabinet-status-text');
            if (cabinetText) cabinetText.textContent = t.onlineRunning;
            
            // 更新所有标签页按钮
            document.querySelectorAll('.sub-tab').forEach(tab => {
                if (tab.textContent.includes('实时') || tab.textContent.includes('Real-time')) {
                    tab.textContent = t.realtimeData;
                } else if (tab.textContent.includes('历史') || tab.textContent.includes('History')) {
                    tab.textContent = t.historyData;
                }
            });
            
            // 更新自定义按钮
            document.querySelectorAll('.data-settings-btn span:last-child').forEach(btn => {
                btn.textContent = t.customize;
            });
            
            // 更新提示文字
            document.querySelectorAll('.tooltip').forEach((tooltip, index) => {
                if (index === 0) tooltip.textContent = t.switchLanguage;
            });
        }
        
        // 切换语言下拉菜单
        // 切换语言下拉菜单
        function toggleLanguageDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('langDropdown');
            dropdown.classList.toggle('show');
        }

        // 更改语言
        function changeLanguage(lang, event) {
            event.stopPropagation();
            
            // 更新选中状态
            document.querySelectorAll('.lang-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 保存语言设置
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            // 关闭下拉菜单
            document.getElementById('langDropdown').classList.remove('show');
            
            // 应用新语言
            applyLanguage(lang);
        }

        // 切换数据标签页
        function switchDataTab(tab) {
            // 更新组件项状态
            document.querySelectorAll('.component-item').forEach(item => {
                item.classList.remove('active');
                // 通过onclick属性查找对应的tab
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`'${tab}'`)) {
                    item.classList.add('active');
                }
            });

            // 切换内容
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(tab + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // 渲染组件数据
            renderComponentData(tab);
        }

        // 切换子标签页
        function switchSubTab(component, tab) {
            // 更新子标签状态
            const section = document.getElementById(component + 'Section');
            section.querySelectorAll('.sub-tab').forEach(btn => {
                btn.classList.remove('active');
                // 通过onclick属性查找对应的tab按钮
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${tab}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // 切换子内容
            section.querySelectorAll('.sub-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(component + '-' + tab).classList.add('active');
            
            // 如果是历史数据，渲染历史图表
            if (tab === 'history') {
                setTimeout(() => {
                    renderHistoryData(component);
                }, 50);
            }
        }

        // 切换历史数据时间范围
        function changeHistoryRange(chart, range, element) {
            if (!element && event && event.target) {
                element = event.target;
            }
            if (element) {
                element.parentElement.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');
            }
            // 这里可以根据range更新图表数据
        }

        // 强制显示所有默认数据 - 简单可靠的方法
        function showAllDefaultData() {
            const overallConfig = dataFieldsConfig.overall.realtime;
            
            // 策略调度参数
            const strategyContainer = document.getElementById('overall-策略调度参数');
            if (strategyContainer) {
                strategyContainer.innerHTML = '';
                const strategyFields = overallConfig['策略调度参数'];
                if (strategyFields) {
                    for (const field in strategyFields) {
                        if (strategyFields[field].default) {
                            const card = createDataCard(field, strategyFields[field]);
                            strategyContainer.appendChild(card);
                        }
                    }
                }
            }
            
            // 核心运行参数
            const coreContainer = document.getElementById('overall-核心运行参数');
            if (coreContainer) {
                coreContainer.innerHTML = '';
                const coreFields = overallConfig['核心运行参数'];
                if (coreFields) {
                    for (const field in coreFields) {
                        if (coreFields[field].default) {
                            const card = createDataCard(field, coreFields[field]);
                            coreContainer.appendChild(card);
                        }
                    }
                }
            }
            
            // 运行统计
            const statsContainer = document.getElementById('overall-运行统计');
            if (statsContainer) {
                statsContainer.innerHTML = '';
                const statsFields = overallConfig['运行统计'];
                if (statsFields) {
                    for (const field in statsFields) {
                        if (statsFields[field].default) {
                            const card = createDataCard(field, statsFields[field]);
                            statsContainer.appendChild(card);
                        }
                    }
                }
            }
            
            // 其他参数
            const otherContainer = document.getElementById('overall-其他参数');
            if (otherContainer) {
                otherContainer.innerHTML = '';
                const otherFields = overallConfig['其他参数'];
                if (otherFields) {
                    for (const field in otherFields) {
                        if (otherFields[field].default) {
                            const card = createDataCard(field, otherFields[field]);
                            otherContainer.appendChild(card);
                        }
                    }
                }
            }
            
        }

        // 显示历史数据
        function showAllHistoryData() {
            renderHistoryData('overall');
        }

        // 自动初始化历史数据
        function autoInitHistoryData() {
            // 检查当前是否在历史数据标签页
            const currentTab = document.querySelector('.sub-tab.active');
            if (currentTab && currentTab.textContent === '历史数据') {
                // 自动渲染整机历史数据
                renderHistoryData('overall');
            }
        }
        
        // 更新数据值
        function updateDataValues(component) {
            const section = document.getElementById(component + 'Section');
            if (!section) return;
            
            // 检查是否在实时数据标签页
            const activeSubTab = section.querySelector('.sub-tab.active');
            if (!activeSubTab || !activeSubTab.textContent.includes('实时数据')) return;
            
            // 更新所有数据卡片的值
            const dataCards = section.querySelectorAll('.data-card');
            dataCards.forEach(card => {
                // 查找带有id的值元素
                const valueSpan = card.querySelector('[id$="Value"]');
                if (valueSpan && valueSpan.id) {
                    const fieldName = valueSpan.id.replace('Value', '');
                    
                    // 特殊处理运行模式字段
                    if (fieldName === 'runningMode') {
                        valueSpan.textContent = Math.random() > 0.3 ? '制冷' : '制热';
                        return;
                    }
                    
                    // 特殊处理其他文本型字段
                    if (fieldName === 'thermalManagementStatus' || 
                        fieldName === 'alarmStatus' || 
                        fieldName === 'controlStatus' ||
                        fieldName === 'simStatus' ||
                        fieldName === 'networkStatus' ||
                        fieldName === 'wifiConnection' ||
                        fieldName === 'runTime' ||
                        fieldName === 'systemTime' ||
                        fieldName === 'hardwareTime') {
                        // 保持原值不变，这些状态通常不需要频繁变化
                        return;
                    }
                    
                    // 更新数值型数据
                    const currentValue = parseFloat(valueSpan.textContent) || 0;
                    if (!isNaN(currentValue)) {
                        const variation = (Math.random() - 0.5) * 0.1; // ±5%的变化
                        const newValue = currentValue * (1 + variation);
                        
                        // 保留合适的小数位数
                        const unitElement = card.querySelector('.card-unit');
                        const unit = unitElement ? unitElement.textContent : '';
                        
                        if (unit.includes('kW') || unit.includes('V') || unit.includes('A') || unit.includes('°C') || unit.includes('℃')) {
                            valueSpan.textContent = newValue.toFixed(1);
                        } else if (unit.includes('%')) {
                            valueSpan.textContent = Math.min(100, Math.max(0, newValue)).toFixed(1);
                        } else {
                            valueSpan.textContent = newValue.toFixed(0);
                        }
                    }
                }
            });
        }

        // 检查字段是否应该显示
        function shouldShowField(component, type, field) {
            // 检查用户设置
            if (userFieldSettings[component] && userFieldSettings[component][type] && userFieldSettings[component][type][field] !== undefined) {
                return userFieldSettings[component][type][field];
            }
            
            // 如果没有用户设置，使用默认值
            const config = dataFieldsConfig[component] && dataFieldsConfig[component][type];
            if (config) {
                // 检查是否为分类结构（如历史数据）
                for (const category in config) {
                    if (config[category][field]) {
                        return config[category][field].default || false;
                    }
                }
                // 检查是否为直接字段结构（如实时数据的某些组件）
                if (config[field]) {
                    return config[field].default || false;
                }
            }
            
            return false;
        }

        // 整机历史数据图表初始化函数
        function initOverallHistoryCharts(timeRange = '30d', endDate = null) {
            // 设置默认日期为今天
            if (!endDate) {
                const today = new Date();
                const picker = document.getElementById('historyEndDatePicker');
                if (picker) {
                    picker.value = today.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                }
            }
            
            // 生成每日数据
            const { labels, powerData, socData } = generateHistoryDailyData(timeRange, endDate);
            
            // 功率与SOC综合分析
            const powerSocCtx = document.getElementById('powerSocChart');
            if (powerSocCtx) {
                // 销毁现有图表
                if (chartInstances.powerSocChart) {
                    chartInstances.powerSocChart.destroy();
                }
                
                chartInstances.powerSocChart = new Chart(powerSocCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '功率',
                            data: powerData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        }, {
                            label: 'SOC',
                            data: socData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 15,
                                bottom: 10,
                                left: 15
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                align: 'center',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 20,
                                    font: {
                                        size: 13,
                                        weight: '500'
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1
                                },
                                ticks: {
                                    font: {
                                        size: 12
                                    },
                                    color: '#6b7280'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '功率 (kW)',
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    },
                                    color: '#10b981'
                                },
                                grid: {
                                    color: 'rgba(16, 185, 129, 0.1)',
                                    lineWidth: 1
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    color: '#10b981'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'SOC (%)',
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    },
                                    color: '#f59e0b'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    color: '#f59e0b'
                                }
                            }
                        }
                    }
                });
            }
            
            // 收益分析
            initRevenueAnalysisChart();
        }
        
        function generateHistoryDailyData(timeRange, endDate) {
            const labels = [];
            const powerData = [];
            const socData = [];
            
            // 生成24小时的时间点数据
            for (let hour = 0; hour < 24; hour++) {
                labels.push(`${hour.toString().padStart(2, '0')}:00`);
                
                // 模拟功率数据 (-50 到 50 kW)，根据时间段调整
                let basePower = 0;
                if (hour >= 8 && hour <= 18) {
                    // 白天放电
                    basePower = -20 - Math.random() * 30;
                } else if (hour >= 23 || hour <= 6) {
                    // 夜间充电
                    basePower = 15 + Math.random() * 25;
                } else {
                    // 过渡时段
                    basePower = (Math.random() - 0.5) * 20;
                }
                powerData.push(basePower);
                
                // 模拟SOC数据，根据充放电调整
                let socValue;
                if (hour === 0) {
                    socValue = 50 + Math.random() * 20;
                } else {
                    const prevSoc = socData[hour - 1] || 60;
                    const powerEffect = basePower > 0 ? 2 : basePower < 0 ? -1.5 : 0;
                    socValue = Math.max(20, Math.min(95, prevSoc + powerEffect + (Math.random() - 0.5) * 3));
                }
                socData.push(socValue);
            }
            
            return { labels, powerData, socData };
        }
        
        function initRevenueAnalysisChart() {
            const ctx = document.getElementById('revenueAnalysisChart');
            if (!ctx) return;
            
            // 销毁现有图表
            if (chartInstances.revenueAnalysisChart) {
                chartInstances.revenueAnalysisChart.destroy();
            }
            
            const timeType = document.getElementById('revenueTimeType')?.value || 'day';
            const { labels, chargingData, dischargingData, revenueData } = generateRevenueData(timeType);
            
            chartInstances.revenueAnalysisChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '充电量 (kWh)',
                        data: chargingData,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: '放电量 (kWh)',
                        data: dischargingData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: '净收益 (¥)',
                        data: revenueData,
                        type: 'line',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderColor: '#f59e0b',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '电量 (kWh)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '收益 (¥)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        function generateRevenueData(timeType) {
            let labels, chargingData, dischargingData, revenueData;
            
            if (timeType === 'day') {
                // 日：x轴为时间点（24小时）
                labels = [];
                chargingData = [];
                dischargingData = [];
                revenueData = [];
                for (let i = 0; i < 24; i += 2) {
                    labels.push(`${i.toString().padStart(2, '0')}:00`);
                    // 夜间充电多，白天放电多
                    const charging = (i >= 22 || i <= 6) ? 15 + Math.random() * 20 : 5 + Math.random() * 10;
                    const discharging = (i >= 8 && i <= 18) ? 20 + Math.random() * 25 : 8 + Math.random() * 12;
                    const revenue = discharging * 0.8 - charging * 0.6 + Math.random() * 50;
                    chargingData.push(charging);
                    dischargingData.push(discharging);
                    revenueData.push(revenue);
                }
            } else if (timeType === 'month') {
                // 月：x轴为天（1-30天）
                labels = [];
                chargingData = [];
                dischargingData = [];
                revenueData = [];
                for (let day = 1; day <= 30; day += 3) {
                    labels.push(`${day}日`);
                    const charging = 300 + Math.random() * 200;
                    const discharging = 280 + Math.random() * 180;
                    const revenue = discharging * 0.8 - charging * 0.6 + Math.random() * 100;
                    chargingData.push(charging);
                    dischargingData.push(discharging);
                    revenueData.push(revenue);
                }
            } else if (timeType === 'year') {
                // 年：x轴为月（1-12月）
                labels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                chargingData = [3200, 2800, 3500, 3800, 4200, 4500, 4800, 4600, 4000, 3600, 3200, 2900];
                dischargingData = [3000, 2600, 3300, 3600, 4000, 4300, 4600, 4400, 3800, 3400, 3000, 2700];
                revenueData = [8500, 7200, 9800, 11200, 13500, 14800, 16200, 15500, 12800, 10500, 8200, 7800];
            } else { // total 合计
                // 合计：x轴为年（多年对比）
                labels = ['2021年', '2022年', '2023年', '2024年', '2025年'];
                chargingData = [32000, 38000, 42000, 45000, 48000];
                dischargingData = [30000, 36000, 40000, 42500, 45500];
                revenueData = [85000, 105000, 125000, 135000, 148000];
            }
            
            return { labels, chargingData, dischargingData, revenueData };
        }
        
        function updateHistoryChart() {
            const endDate = document.getElementById('historyEndDatePicker').value;
            initOverallHistoryCharts('30d', endDate);
        }
        
        function updateRevenueAnalysisChart() {
            const timeType = document.getElementById('revenueTimeType').value;
            const datePickerWrapper = document.getElementById('revenueDatePickerWrapper');
            const datePicker = document.getElementById('revenueDatePicker');
            const monthPicker = document.getElementById('revenueMonthPicker');
            const yearPicker = document.getElementById('revenueYearPicker');
            
            // 隐藏所有选择器
            datePickerWrapper.style.display = 'none';
            monthPicker.style.display = 'none';
            yearPicker.style.display = 'none';
            
            // 根据时间类型显示对应的选择器并设置默认值
            const today = new Date();
            switch(timeType) {
                case 'day':
                    datePickerWrapper.style.display = 'inline-block';
                    // 设置默认为今日
                    if (!datePicker.value) {
                        datePicker.value = today.toISOString().split('T')[0];
                    }
                    break;
                case 'month':
                    monthPicker.style.display = 'block';
                    // 设置默认为本月
                    if (!monthPicker.value) {
                        const year = today.getFullYear();
                        const month = (today.getMonth() + 1).toString().padStart(2, '0');
                        monthPicker.value = `${year}-${month}`;
                    }
                    break;
                case 'year':
                    yearPicker.style.display = 'block';
                    break;
                case 'total':
                    // 合计不需要额外选择器
                    break;
            }
            
            initRevenueAnalysisChart();
        }
        
        function updatePcsEfficiencyTimePeriod() {
            const timeType = document.getElementById('pcsEfficiencyTimePicker').value;
            const datePickerWrapper = document.getElementById('pcsEfficiencyDatePickerWrapper');
            const datePicker = document.getElementById('pcsEfficiencyDatePicker');
            const monthPicker = document.getElementById('pcsEfficiencyMonthPicker');
            const yearPicker = document.getElementById('pcsEfficiencyYearPicker');
            
            // 隐藏所有选择器
            datePickerWrapper.style.display = 'none';
            monthPicker.style.display = 'none';
            yearPicker.style.display = 'none';
            
            // 根据时间类型显示对应的选择器并设置默认值
            const today = new Date();
            switch(timeType) {
                case 'day':
                    datePickerWrapper.style.display = 'inline-block';
                    // 设置默认为今日
                    if (!datePicker.value) {
                        datePicker.value = today.toISOString().split('T')[0];
                    }
                    break;
                case 'month':
                    monthPicker.style.display = 'block';
                    // 设置默认为本月
                    if (!monthPicker.value) {
                        const year = today.getFullYear();
                        const month = (today.getMonth() + 1).toString().padStart(2, '0');
                        monthPicker.value = `${year}-${month}`;
                    }
                    break;
                case 'year':
                    yearPicker.style.display = 'block';
                    break;
                case 'total':
                    // 合计不需要额外选择器
                    break;
            }
            
            updatePcsEfficiencyChart();
        }
        
        function updatePcsEfficiencyChart() {
            const timeType = document.getElementById('pcsEfficiencyTimePicker').value;
            let labels, efficiencyData;
            
            // 根据时间类型生成数据
            switch(timeType) {
                case 'day':
                    // 日：x轴为时间点（24小时）
                    labels = Array.from({length: 24}, (_, i) => `${i}:00`);
                    efficiencyData = Array.from({length: 24}, () => Math.random() * 5 + 93);
                    break;
                case 'month':
                    // 月：x轴为天（1-30天）
                    labels = Array.from({length: 30}, (_, i) => `${i + 1}日`);
                    efficiencyData = Array.from({length: 30}, () => Math.random() * 4 + 94);
                    break;
                case 'year':
                    // 年：x轴为月（1-12月）
                    labels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                    efficiencyData = [95.2, 94.8, 95.5, 95.8, 96.2, 96.5, 96.8, 96.6, 96.0, 95.6, 95.2, 94.9];
                    break;
                case 'total':
                    // 合计：x轴为年（多年对比）
                    labels = ['2021年', '2022年', '2023年', '2024年', '2025年'];
                    efficiencyData = [93.5, 94.2, 95.1, 95.8, 96.2];
                    break;
                default:
                    labels = Array.from({length: 24}, (_, i) => `${i}:00`);
                    efficiencyData = Array.from({length: 24}, () => Math.random() * 5 + 93);
            }
            
            // 更新图表
            const ctx = document.getElementById('pcsEfficiencyChart');
            if (ctx && chartInstances.pcsEfficiencyChart) {
                chartInstances.pcsEfficiencyChart.destroy();
            }
            
            if (ctx) {
                chartInstances.pcsEfficiencyChart = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '转换效率',
                            data: efficiencyData,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        }]
                    },
                    options: getChartOptions('效率 (%)', 85, 100)
                });
            }
        }
        
        // 初始化EMS历史数据图表
        function initEMSHistoryCharts() {
            // EMS策略执行历史
            const strategyCtx = document.getElementById('emsStrategyChart');
            if (strategyCtx) {
                new Chart(strategyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '调度次数',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 5) + 1),
                            backgroundColor: 'rgba(37, 99, 235, 0.8)',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        }, {
                            label: '执行成功率',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 90),
                            type: 'line',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '调度次数',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '成功率 (%)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    min: 80,
                                    max: 100
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 调度响应时间分析
            const responseCtx = document.getElementById('emsResponseChart');
            if (responseCtx) {
                new Chart(responseCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 30}, (_, i) => `${i + 1}日`),
                        datasets: [{
                            label: '平均响应时间',
                            data: Array.from({length: 30}, () => Math.random() * 30 + 10),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: '最大响应时间',
                            data: Array.from({length: 30}, () => Math.random() * 20 + 40),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: getChartOptions('响应时间 (ms)', 0, 80)
                });
            }
        }
        
        // 初始化PCS历史数据图表
        function initPCSHistoryCharts() {
            // PCS功率转换历史
            const powerCtx = document.getElementById('pcsPowerChart');
            if (powerCtx) {
                new Chart(powerCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'AC功率输出',
                            data: Array.from({length: 24}, () => Math.random() * 100 + 50),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'DC功率输入',
                            data: Array.from({length: 24}, () => Math.random() * 110 + 55),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: getChartOptions('功率 (kW)')
                });
            }
            
            // 电压电流趋势
            const voltageCtx = document.getElementById('pcsVoltageChart');
            if (voltageCtx) {
                new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'DC电压',
                            data: Array.from({length: 24}, () => Math.random() * 20 + 750),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: 'DC电流',
                            data: Array.from({length: 24}, () => Math.random() * 50 + 150),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '电压 (V)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '电流 (A)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 转换效率分析 - 使用专用函数初始化
            updatePcsEfficiencyChart();
        }
        
        // 初始化电表历史数据图表
        function initMeterHistoryCharts() {
            // 功率趋势分析
            const powerCtx = document.getElementById('meterPowerChart');
            if (powerCtx) {
                meterChartInstances.meterPowerChart = new Chart(powerCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}时`),
                        datasets: [{
                            label: '有功功率',
                            data: Array.from({length: 24}, () => Math.random() * 100 + 150),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: '无功功率',
                            data: Array.from({length: 24}, () => Math.random() * 15 + 25),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: '视在功率',
                            data: Array.from({length: 24}, () => Math.random() * 105 + 155),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: getChartOptions('功率 (kW/kVar/kVA)', 0, 300)
                });
            }
            
            // 电量消耗统计
            const energyCtx = document.getElementById('meterEnergyChart');
            if (energyCtx) {
                meterChartInstances.meterEnergyChart = new Chart(energyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}时`),
                        datasets: [{
                            label: '有功电量',
                            data: Array.from({length: 24}, () => Math.random() * 25 + 45),
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#3b82f6',
                            borderWidth: 1
                        }, {
                            label: '无功电量',
                            data: Array.from({length: 24}, () => Math.random() * 8 + 4),
                            backgroundColor: 'rgba(245, 158, 11, 0.7)',
                            borderColor: '#f59e0b',
                            borderWidth: 1
                        }]
                    },
                    options: getChartOptions('电量 (kWh/kVarh)', 0, 80)
                });
            }
            
            // 电压质量监测
            const voltageCtx = document.getElementById('meterVoltageChart');
            if (voltageCtx) {
                meterChartInstances.meterVoltageChart = new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}时`),
                        datasets: [{
                            label: 'A相电压',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 380),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: 'B相电压',
                            data: Array.from({length: 24}, () => Math.random() * 9 + 381),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: 'C相电压',
                            data: Array.from({length: 24}, () => Math.random() * 11 + 379),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: getChartOptions('电压 (V)', 370, 400)
                });
            }
            
            // 谐波分析
            const harmonicCtx = document.getElementById('meterHarmonicChart');
            if (harmonicCtx) {
                meterChartInstances.meterHarmonicChart = new Chart(harmonicCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['基波', '2次', '3次', '4次', '5次', '6次', '7次', '8次', '9次', '10次', '11次', '12次', '13次', '14次', '15次', '16次', '17次', '18次', '19次', '20次', '21次'],
                        datasets: [{
                            label: '谐波含量 (%)',
                            data: [2.8, 2.3, 1.9, 1.4, 1.1, 0.8, 0.6, 0.5, 0.4, 0.3, 0.3, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.7)',
                                'rgba(239, 68, 68, 0.7)',
                                'rgba(245, 158, 11, 0.7)',
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(139, 92, 246, 0.7)',
                                'rgba(236, 72, 153, 0.7)',
                                'rgba(14, 165, 233, 0.7)',
                                'rgba(248, 113, 113, 0.7)',
                                'rgba(34, 197, 94, 0.7)',
                                'rgba(251, 191, 36, 0.7)',
                                'rgba(168, 85, 247, 0.7)',
                                'rgba(244, 63, 94, 0.7)',
                                'rgba(6, 182, 212, 0.7)',
                                'rgba(129, 140, 248, 0.7)',
                                'rgba(45, 212, 191, 0.7)',
                                'rgba(251, 146, 60, 0.7)',
                                'rgba(196, 181, 253, 0.7)',
                                'rgba(110, 231, 183, 0.7)',
                                'rgba(254, 215, 170, 0.7)',
                                'rgba(217, 70, 239, 0.7)',
                                'rgba(125, 211, 252, 0.7)'
                            ],
                            borderColor: [
                                '#3b82f6',
                                '#ef4444',
                                '#f59e0b',
                                '#10b981',
                                '#8b5cf6',
                                '#ec4899',
                                '#0ea5e9',
                                '#f87171',
                                '#22c55e',
                                '#fbbf24',
                                '#a855f7',
                                '#f43f5e',
                                '#06b6d4',
                                '#818cf8',
                                '#2dd4bf',
                                '#fb923c',
                                '#c4b5fd',
                                '#6ee7b7',
                                '#fed7aa',
                                '#d946ef',
                                '#7dd3fc'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: getChartOptions('谐波含量 (%)', 0, 3)
                });
            }
        }

        // 存储电表图表实例
        let meterChartInstances = {};

        // 更新电表功率趋势图表
        function updateMeterPowerChart(selectedDate) {
            const ctx = document.getElementById('meterPowerChart');
            if (ctx && meterChartInstances.meterPowerChart) {
                // 根据选择的日期生成对应的小时数据
                const dateObj = new Date(selectedDate);
                const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                
                // 使用日期作为随机数种子，确保同一天的数据保持一致
                const seed = dayOfYear;
                const generateData = (base, variation) => {
                    return Array.from({length: 24}, (_, i) => {
                        const pseudoRandom = (seed + i * 37) % 100 / 100;
                        return base + pseudoRandom * variation;
                    });
                };

                meterChartInstances.meterPowerChart.data.datasets[0].data = generateData(184.4, 40);
                meterChartInstances.meterPowerChart.data.datasets[1].data = generateData(31.9, 15);
                meterChartInstances.meterPowerChart.data.datasets[2].data = generateData(255.4, 50);
                meterChartInstances.meterPowerChart.update();
            }
        }

        // 更新电表电量消耗图表
        function updateMeterEnergyChart(selectedDate) {
            const ctx = document.getElementById('meterEnergyChart');
            if (ctx && meterChartInstances.meterEnergyChart) {
                const dateObj = new Date(selectedDate);
                const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                
                const seed = dayOfYear;
                const generateData = (base, variation) => {
                    return Array.from({length: 24}, (_, i) => {
                        const pseudoRandom = (seed + i * 43) % 100 / 100;
                        return base + pseudoRandom * variation;
                    });
                };

                meterChartInstances.meterEnergyChart.data.datasets[0].data = generateData(52.1, 25);
                meterChartInstances.meterEnergyChart.data.datasets[1].data = generateData(7.8, 8);
                meterChartInstances.meterEnergyChart.update();
            }
        }

        // 更新电表电压质量图表
        function updateMeterVoltageChart(selectedDate) {
            const ctx = document.getElementById('meterVoltageChart');
            if (ctx && meterChartInstances.meterVoltageChart) {
                const dateObj = new Date(selectedDate);
                const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                
                const seed = dayOfYear;
                const generateData = (base, variation) => {
                    return Array.from({length: 24}, (_, i) => {
                        const pseudoRandom = (seed + i * 47) % 100 / 100;
                        return base + pseudoRandom * variation;
                    });
                };

                meterChartInstances.meterVoltageChart.data.datasets[0].data = generateData(382.5, 6);
                meterChartInstances.meterVoltageChart.data.datasets[1].data = generateData(383.1, 6);
                meterChartInstances.meterVoltageChart.data.datasets[2].data = generateData(381.8, 6);
                meterChartInstances.meterVoltageChart.update();
            }
        }

        // 更新电表谐波分析图表
        function updateMeterHarmonicChart(selectedDate) {
            const ctx = document.getElementById('meterHarmonicChart');
            if (ctx && meterChartInstances.meterHarmonicChart) {
                const dateObj = new Date(selectedDate);
                const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                
                const seed = dayOfYear;
                const generateData = (baseValues) => {
                    return baseValues.map((base, i) => {
                        const pseudoRandom = (seed + i * 53) % 100 / 100;
                        return Math.max(0.1, base + (pseudoRandom - 0.5) * base * 0.3);
                    });
                };

                const harmonicData = generateData([2.8, 2.3, 1.9, 1.4, 1.1, 0.8, 0.6, 0.5, 0.4, 0.3, 0.3, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2]);
                meterChartInstances.meterHarmonicChart.data.datasets[0].data = harmonicData;
                meterChartInstances.meterHarmonicChart.update();
            }
        }
        
        // 初始化BMS历史数据图表
        function initBMSHistoryCharts() {
            // 电池电压历史
            const voltageCtx = document.getElementById('bmsVoltageChart');
            if (voltageCtx) {
                new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}时`),
                        datasets: [{
                            label: '最高电压',
                            data: Array.from({length: 24}, () => Math.random() * 5 + 820),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: '平均电压',
                            data: Array.from({length: 24}, () => Math.random() * 3 + 815),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: '最低电压',
                            data: Array.from({length: 24}, () => Math.random() * 3 + 810),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: getChartOptions('电压 (V)', 800, 830)
                });
            }
            
            // 电池SOC趋势
            const balanceCtx = document.getElementById('bmsBalanceChart');
            if (balanceCtx) {
                new Chart(balanceCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}时`),
                        datasets: [{
                            label: 'SOC趋势',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 80),
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: getChartOptions('SOC (%)', 75, 95)
                });
            }
            
            // 温度分布分析
            const tempCtx = document.getElementById('bmsTempChart');
            if (tempCtx) {
                new Chart(tempCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '最高温度',
                            data: Array.from({length: 24}, () => Math.random() * 5 + 30),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: '平均温度',
                            data: Array.from({length: 24}, () => Math.random() * 3 + 28),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: '最低温度',
                            data: Array.from({length: 24}, () => Math.random() * 3 + 25),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: getChartOptions('温度 (°C)', 20, 40)
                });
            }
        }
        
        // 初始化Battery历史数据图表
        function initBatteryHistoryCharts() {
            // 电池性能趋势
            const performanceCtx = document.getElementById('batteryPerformanceChart');
            if (performanceCtx) {
                new Chart(performanceCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 12}, (_, i) => `${i + 1}月`),
                        datasets: [{
                            label: 'SOH (%)',
                            data: Array.from({length: 12}, (_, i) => 98 - i * 0.2 + Math.random() * 0.5),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: '内阻 (mΩ)',
                            data: Array.from({length: 12}, (_, i) => 45 + i * 0.5 + Math.random() * 2),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'SOH (%)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                min: 90,
                                max: 100
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '内阻 (mΩ)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 循环寿命统计
            const cycleCtx = document.getElementById('batteryCycleChart');
            if (cycleCtx) {
                new Chart(cycleCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['浅充浅放', '标准循环', '深度循环', '快充循环'],
                        datasets: [{
                            label: '循环次数',
                            data: [1200, 800, 300, 150],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(37, 99, 235, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderColor: [
                                '#10b981',
                                '#2563eb',
                                '#f59e0b',
                                '#ef4444'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: getChartOptions('循环次数')
                });
            }
            
            // 容量衰减分析
            const capacityCtx = document.getElementById('batteryCapacityChart');
            if (capacityCtx) {
                new Chart(capacityCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        datasets: [{
                            label: '实际容量',
                            data: [500, 498, 496, 494, 492, 490, 488, 486, 484, 482, 480, 478],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        }, {
                            label: '容量保持率',
                            data: [100, 99.6, 99.2, 98.8, 98.4, 98.0, 97.6, 97.2, 96.8, 96.4, 96.0, 95.6],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            if (context.datasetIndex === 0) {
                                                label += context.parsed.y + ' kWh';
                                            } else {
                                                label += context.parsed.y + ' %';
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '容量 (kWh)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                min: 470,
                                max: 510
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '容量保持率 (%)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                min: 94,
                                max: 101
                            }
                        }
                    }
                });
            }
        }
        
        // 初始化Thermal历史数据图表
        function initThermalHistoryCharts() {
            // 温度分布历史 - 电池包温度分布历史
            const tempCtx = document.getElementById('thermalTempChart');
            if (tempCtx) {
                new Chart(tempCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '电池包最高温度',
                            data: Array.from({length: 24}, (_, i) => {
                                // 模拟电池温度随时间和充放电状态变化
                                const baseTemp = 25;
                                const timeVariation = Math.sin(i * Math.PI / 12) * 3;
                                const randomVariation = (Math.random() - 0.5) * 2;
                                return (baseTemp + timeVariation + randomVariation + (i >= 10 && i <= 16 ? 4 : 0)).toFixed(1);
                            }),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '电池包平均温度',
                            data: Array.from({length: 24}, (_, i) => {
                                const baseTemp = 23;
                                const timeVariation = Math.sin(i * Math.PI / 12) * 2;
                                const randomVariation = (Math.random() - 0.5) * 1.5;
                                return (baseTemp + timeVariation + randomVariation + (i >= 10 && i <= 16 ? 2 : 0)).toFixed(1);
                            }),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '电池包最低温度',
                            data: Array.from({length: 24}, (_, i) => {
                                const baseTemp = 21;
                                const timeVariation = Math.sin(i * Math.PI / 12) * 1.5;
                                const randomVariation = (Math.random() - 0.5) * 1;
                                return (baseTemp + timeVariation + randomVariation + (i >= 10 && i <= 16 ? 1 : 0)).toFixed(1);
                            }),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            title: { 
                                display: false
                            }
                        },
                        scales: { 
                            y: { 
                                title: { 
                                    display: true, 
                                    text: '温度 (°C)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                min: 15,
                                max: 35,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: { 
                                title: { 
                                    display: true, 
                                    text: '时间',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 冷却系统运行 - 环境温度与湿度变化
            const coolingCtx = document.getElementById('thermalCoolingChart');
            if (coolingCtx) {
                new Chart(coolingCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '进风温度',
                            data: Array.from({length: 24}, (_, i) => {
                                const baseTemp = 22;
                                const timeVariation = Math.sin((i - 6) * Math.PI / 12) * 4;
                                return (baseTemp + timeVariation + Math.random() * 2).toFixed(1);
                            }),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }, {
                            label: '出风温度',
                            data: Array.from({length: 24}, (_, i) => {
                                const baseTemp = 28;
                                const timeVariation = Math.sin((i - 6) * Math.PI / 12) * 3;
                                return (baseTemp + timeVariation + Math.random() * 2).toFixed(1);
                            }),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }, {
                            label: '相对湿度',
                            data: Array.from({length: 24}, () => (45 + Math.random() * 20).toFixed(1)),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { 
                                    display: true, 
                                    text: '温度 (°C)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { 
                                    display: true, 
                                    text: '湿度 (%RH)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                min: 0,
                                max: 100,
                                grid: { 
                                    drawOnChartArea: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 温度热力图 - 制冷系统性能分析
            const heatMapCtx = document.getElementById('thermalHeatMapChart');
            if (heatMapCtx) {
                new Chart(heatMapCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '主风机转速',
                            data: Array.from({length: 24}, (_, i) => {
                                // 根据温度需求调节风机转速
                                const baseSpeed = 1500;
                                const tempDemand = (i >= 10 && i <= 16) ? 300 : 0;
                                return baseSpeed + tempDemand + Math.random() * 200;
                            }),
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            yAxisID: 'y'
                        }, {
                            label: '制冷功耗',
                            data: Array.from({length: 24}, (_, i) => {
                                const basePower = 3;
                                const tempDemand = (i >= 10 && i <= 16) ? 2 : 0;
                                return (basePower + tempDemand + Math.random() * 1).toFixed(1);
                            }),
                            backgroundColor: 'rgba(245, 158, 11, 0.7)',
                            yAxisID: 'y1',
                            type: 'line',
                            borderColor: '#f59e0b',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { 
                                    display: true, 
                                    text: '转速 (RPM)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { 
                                    display: true, 
                                    text: '功耗 (kW)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: { 
                                    drawOnChartArea: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 初始化Fire历史数据图表
        function initFireHistoryCharts() {
            // 系统状态历史
            const systemCtx = document.getElementById('fireSystemChart');
            if (systemCtx) {
                new Chart(systemCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['正常', '预警', '告警'],
                        datasets: [{
                            data: [95, 4, 1],
                            backgroundColor: ['#10b981', '#f59e0b', '#dc2626'],
                            borderWidth: 2,
                            borderColor: ['#10b981', '#f59e0b', '#dc2626']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 气体浓度监测
            const gasCtx = document.getElementById('fireGasChart');
            if (gasCtx) {
                new Chart(gasCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'CO浓度',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 5),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: '烟雾浓度',
                            data: Array.from({length: 24}, () => Math.random() * 8 + 3),
                            borderColor: '#6b7280',
                            backgroundColor: 'rgba(107, 114, 128, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                title: { 
                                    display: true, 
                                    text: '浓度 (ppm)',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 告警记录分析
            const alarmCtx = document.getElementById('fireAlarmChart');
            if (alarmCtx) {
                new Chart(alarmCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '烟雾告警',
                            data: [2, 1, 0, 1, 0, 1],
                            backgroundColor: 'rgba(107, 114, 128, 0.8)',
                            borderColor: '#6b7280',
                            borderWidth: 1
                        }, {
                            label: '温度告警',
                            data: [1, 0, 2, 0, 1, 0],
                            backgroundColor: 'rgba(245, 158, 11, 0.8)',
                            borderColor: '#f59e0b',
                            borderWidth: 1
                        }, {
                            label: '气体告警',
                            data: [0, 1, 1, 0, 0, 1],
                            backgroundColor: 'rgba(220, 38, 38, 0.8)',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y + ' 次';
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '告警次数',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        }

        // 页面初始化
        window.onload = function() {
            try {
                console.log('Data page initializing...');
                
                // 检查登录状态 - 暂时注释掉用于调试
                // const user = localStorage.getItem('touchscreen_user') || sessionStorage.getItem('touchscreen_user');
                // if (!user) {
                //     window.location.href = 'login.html';
                //     return;
                // }

                // 应用语言设置
                applyLanguage(currentLang);
                
                // 设置语言选项的激活状态
                document.querySelectorAll('.lang-option').forEach(option => {
                    const isCurrentLang = option.getAttribute('onclick').includes(`'${currentLang}'`);
                    if (isCurrentLang) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });

                // 更新时间
                updateTime();
                setInterval(updateTime, 1000);
                
                // 初始化和定期更新组件状态
                updateComponentStatuses();
                setInterval(updateComponentStatuses, 30000); // 每30秒更新一次
                
                // 确保有默认激活的标签页
                const firstComponent = document.querySelector('.component-item');
                const firstSection = document.querySelector('.content-section');
                if (firstComponent && !document.querySelector('.component-item.active')) {
                    firstComponent.classList.add('active');
                }
                if (firstSection && !document.querySelector('.content-section.active')) {
                    firstSection.classList.add('active');
                }

                // 初始化所有组件的实时数据
                const components = ['overall', 'ems', 'pcs', 'bms', 'meter', 'thermal', 'fire'];
                
                // 立即渲染整机概览
                console.log('立即渲染整机概览...');
                try {
                    renderComponentData('overall');
                } catch (err) {
                    console.error('渲染整机概览失败:', err);
                }
                
                // 首先确保整机概览是显示状态并渲染数据
                setTimeout(() => {
                    console.log('Initializing component data...');
                    components.forEach(component => {
                        try {
                            console.log(`正在初始化组件: ${component}`);
                            renderComponentData(component);
                        } catch (err) {
                            console.error(`Error rendering ${component}:`, err);
                        }
                    });
                    
                    // 确保第一个组件的数据已渲染
                    const overallSection = document.getElementById('overallSection');
                    if (overallSection && overallSection.classList.contains('active')) {
                        console.log('Overall section is active and data should be visible');
                        // 再次强制渲染overall
                        renderComponentData('overall');
                    }
                }, 100);
                
                // 定时更新数据值（每2秒更新一次）
                setInterval(() => {
                    try {
                        // 只更新当前显示的组件
                        const activeSection = document.querySelector('.content-section.active');
                        if (activeSection) {
                            const componentId = activeSection.id.replace('Section', '');
                            updateDataValues(componentId);
                        }
                    } catch (err) {
                        console.error('Error updating data values:', err);
                    }
                }, 2000);
                
                // 检查URL参数，自动选中对应的tab
                const urlParams = new URLSearchParams(window.location.search);
                const tabParam = urlParams.get('tab');
                if (tabParam) {
                    // 延迟执行以确保页面完全加载
                    setTimeout(() => {
                        try {
                            switchDataTab(tabParam);
                        } catch (err) {
                            console.error('Error switching tab:', err);
                        }
                    }, 100);
                }
                
                // 延迟自动初始化历史数据
                setTimeout(() => {
                    try {
                        autoInitHistoryData();
                    } catch (err) {
                        console.error('Error initializing history data:', err);
                    }
                }, 500);
                
                console.log('Data page initialization complete');
            } catch (error) {
                console.error('Critical error during initialization:', error);
            }

            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', function(e) {
                const langSwitcher = document.querySelector('.lang-switcher');
                if (langSwitcher && !langSwitcher.contains(e.target)) {
                    document.getElementById('langDropdown').classList.remove('show');
                }
            });
            
            // 添加事件委托，确保动态内容的事件也能正常工作
            document.addEventListener('click', function(e) {
                // 处理组件切换
                if (e.target.classList.contains('component-item')) {
                    const onclick = e.target.getAttribute('onclick');
                    if (onclick && onclick.includes('switchDataTab')) {
                        const match = onclick.match(/switchDataTab\('(.+?)'\)/);
                        if (match) {
                            console.log('Switching to component:', match[1]);
                            switchDataTab(match[1]);
                        }
                    }
                }
                
                // 处理子标签切换（实时数据/历史数据）
                if (e.target.classList.contains('sub-tab')) {
                    const onclick = e.target.getAttribute('onclick');
                    if (onclick && onclick.includes('switchSubTab')) {
                        const match = onclick.match(/switchSubTab\('(.+?)',\s*'(.+?)'\)/);
                        if (match) {
                            console.log('Switching sub tab:', match[1], match[2]);
                            switchSubTab(match[1], match[2]);
                        }
                    }
                }
                
                // 处理自定义按钮
                if (e.target.classList.contains('data-settings-btn') || e.target.parentElement?.classList.contains('data-settings-btn')) {
                    const btn = e.target.classList.contains('data-settings-btn') ? e.target : e.target.parentElement;
                    const onclick = btn.getAttribute('onclick');
                    if (onclick && onclick.includes('openSettings')) {
                        const match = onclick.match(/openSettings\('(.+?)'\)/);
                        if (match) {
                            console.log('Opening settings for:', match[1]);
                            openSettings(match[1]);
                        }
                    }
                }
            });
        };
        
        // 将函数暴露到全局作用域，确保内联事件处理器可以访问
        window.switchDataTab = switchDataTab;
        window.switchSubTab = switchSubTab;
        window.openSettings = openSettings;
        window.closeSettings = closeSettings;
        window.changeHistoryRange = changeHistoryRange;
        window.switchSettingsType = switchSettingsType;
        window.toggleLanguageDropdown = toggleLanguageDropdown;
        window.changeLanguage = changeLanguage;
        // 关闭确认对话框
        function closeConfirmDialog() {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        window.closeConfirmDialog = closeConfirmDialog;
        
        // 强制初始化函数
        window.forceInitialize = function() {
            console.log('Force initializing data page...');
            
            // 确保有激活的组件
            const firstComponent = document.querySelector('.component-item');
            const firstSection = document.querySelector('.content-section');
            if (firstComponent) {
                firstComponent.classList.add('active');
            }
            if (firstSection) {
                firstSection.classList.add('active');
                firstSection.style.display = 'flex';
            }
            
            // 确保有激活的子内容
            const firstSubContent = document.querySelector('.sub-content');
            if (firstSubContent) {
                firstSubContent.classList.add('active');
                firstSubContent.style.display = 'block';
            }
            
            // 渲染所有组件数据
            const components = ['overall', 'ems', 'pcs', 'bms', 'meter', 'thermal', 'fire'];
            components.forEach(component => {
                try {
                    renderComponentData(component);
                } catch (err) {
                    console.error(`Error rendering ${component}:`, err);
                }
            });
            
            console.log('Force initialization complete');
        };
        
        // OTA升级功能
        function showOTAUpgrade() {
            document.getElementById('otaModal').classList.add('show');
        }
        
        function closeOTAModal() {
            document.getElementById('otaModal').classList.remove('show');
            // 重置状态
            document.getElementById('otaProgressSection').style.display = 'none';
            document.getElementById('otaActions').style.display = 'flex';
            document.getElementById('otaProgressFill').style.width = '0%';
            document.getElementById('otaProgressPercent').textContent = '0%';
        }
        
        function startOTAUpgrade() {
            // 隐藏按钮，显示进度条
            document.getElementById('otaActions').style.display = 'none';
            document.getElementById('otaProgressSection').style.display = 'block';
            
            // 模拟升级进度
            let progress = 0;
            const statusTexts = [
                '准备升级...',
                '下载固件...',
                '校验固件...',
                '安装更新...',
                '重启设备...',
                '升级完成！'
            ];
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                document.getElementById('otaProgressFill').style.width = progress + '%';
                document.getElementById('otaProgressPercent').textContent = Math.floor(progress) + '%';
                
                // 更新状态文本
                const statusIndex = Math.floor((progress / 100) * (statusTexts.length - 1));
                document.getElementById('otaStatusText').textContent = statusTexts[statusIndex];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        alert('固件升级成功！系统将在3秒后重启...');
                        setTimeout(() => {
                            closeOTAModal();
                        }, 3000);
                    }, 500);
                }
            }, 500);
        }
    </script>
    
    <!-- OTA升级弹窗 -->
    <div class="ota-modal" id="otaModal">
        <div class="ota-modal-content">
            <div class="ota-modal-header">
                <h3>OTA 固件升级</h3>
                <button class="ota-close-btn" onclick="closeOTAModal()">×</button>
            </div>
            <div class="ota-modal-body">
                <div class="ota-info">
                    <div class="ota-info-row">
                        <span class="ota-label">当前版本：</span>
                        <span class="ota-value">V2.0.1</span>
                    </div>
                    <div class="ota-info-row">
                        <span class="ota-label">最新版本：</span>
                        <span class="ota-value">V2.1.0</span>
                    </div>
                </div>
                
                <div class="ota-progress-section" id="otaProgressSection" style="display: none;">
                    <div class="ota-progress-text">
                        <span>升级进度</span>
                        <span id="otaProgressPercent">0%</span>
                    </div>
                    <div class="ota-progress-bar">
                        <div class="ota-progress-fill" id="otaProgressFill"></div>
                    </div>
                    <div class="ota-status-text" id="otaStatusText">准备升级...</div>
                </div>
                
                <div class="ota-actions" id="otaActions">
                    <button class="ota-btn ota-btn-primary" onclick="startOTAUpgrade()">开始升级</button>
                    <button class="ota-btn ota-btn-secondary" onclick="closeOTAModal()">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* OTA升级弹窗样式 */
        .ota-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .ota-modal.show {
            display: flex;
        }
        
        .ota-modal-content {
            background: linear-gradient(135deg, #1a2332 0%, #0f1823 100%);
            border: 2px solid rgba(0, 150, 255, 0.3);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }
        
        .ota-modal-header {
            background: rgba(0, 150, 255, 0.1);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 150, 255, 0.2);
        }
        
        .ota-modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: #00d4ff;
        }
        
        .ota-close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .ota-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .ota-modal-body {
            padding: 30px 25px;
        }
        
        .ota-info {
            background: rgba(0, 150, 255, 0.05);
            border: 1px solid rgba(0, 150, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .ota-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .ota-info-row:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ota-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .ota-value {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }
        
        .ota-progress-section {
            margin-bottom: 25px;
        }
        
        .ota-progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .ota-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .ota-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0096ff);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        .ota-status-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }
        
        .ota-actions {
            display: flex;
            gap: 15px;
        }
        
        .ota-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ota-btn-primary {
            background: linear-gradient(135deg, #0096ff 0%, #00d4ff 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 150, 255, 0.3);
        }
        
        .ota-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 150, 255, 0.4);
        }
        
        .ota-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ota-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .ota-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>

    <script>
        // 滚动页面功能
        function scrollPage(direction) {
            const scrollAmount = 300; // 每次滚动300像素
            
            // 首先查找当前激活的主内容区域
            const activeSection = document.querySelector('.content-section.active');
            
            if (activeSection) {
                // 在激活的主区域内查找激活的子内容
                const activeContent = activeSection.querySelector('.sub-content.active');
                
                if (activeContent) {
                    // 如果有激活的子内容区域，滚动它
                    if (direction === 'up') {
                        activeContent.scrollBy({
                            top: -scrollAmount,
                            behavior: 'smooth'
                        });
                    } else if (direction === 'down') {
                        activeContent.scrollBy({
                            top: scrollAmount,
                            behavior: 'smooth'
                        });
                    }
                } else {
                    // 如果没有子内容，尝试滚动主区域
                    if (direction === 'up') {
                        activeSection.scrollBy({
                            top: -scrollAmount,
                            behavior: 'smooth'
                        });
                    } else if (direction === 'down') {
                        activeSection.scrollBy({
                            top: scrollAmount,
                            behavior: 'smooth'
                        });
                    }
                }
            } else {
                // 如果没有激活的区域，滚动整个窗口
                if (direction === 'up') {
                    window.scrollBy({
                        top: -scrollAmount,
                        behavior: 'smooth'
                    });
                } else if (direction === 'down') {
                    window.scrollBy({
                        top: scrollAmount,
                        behavior: 'smooth'
                    });
                }
            }
        }
    </script>

    <!-- 自定义日期选择弹窗 -->
    <div id="customCalendarPopup" class="custom-calendar-popup">
        <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="changeMonth(-1)">‹</button>
            <div class="calendar-month-year">
                <select id="calendarMonth" onchange="updateCalendar()">
                    <option value="0">一月</option>
                    <option value="1">二月</option>
                    <option value="2">三月</option>
                    <option value="3">四月</option>
                    <option value="4">五月</option>
                    <option value="5">六月</option>
                    <option value="6">七月</option>
                    <option value="7">八月</option>
                    <option value="8">九月</option>
                    <option value="9">十月</option>
                    <option value="10">十一月</option>
                    <option value="11">十二月</option>
                </select>
                <select id="calendarYear" onchange="updateCalendar()">
                    <!-- 年份选项将由JS动态生成 -->
                </select>
            </div>
            <button class="calendar-nav-btn" onclick="changeMonth(1)">›</button>
        </div>
        <div class="calendar-weekdays">
            <div class="calendar-weekday">日</div>
            <div class="calendar-weekday">一</div>
            <div class="calendar-weekday">二</div>
            <div class="calendar-weekday">三</div>
            <div class="calendar-weekday">四</div>
            <div class="calendar-weekday">五</div>
            <div class="calendar-weekday">六</div>
        </div>
        <div class="calendar-days" id="calendarDays">
            <!-- 日期将由JS动态生成 -->
        </div>
        <div class="calendar-footer">
            <button class="calendar-btn secondary" onclick="setToday()" ontouchend="setToday()">今天</button>
            <button class="calendar-btn secondary" onclick="closeCustomCalendar()" ontouchend="closeCustomCalendar()">取消</button>
        </div>
    </div>
    
    <script>
        // 自定义日历相关变量
        let currentCalendarInput = null;
        let selectedDate = new Date();
        let displayMonth = new Date();
        
        // 图表实例跟踪
        let chartInstances = {};
        
        // 显示自定义日历
        function showCustomCalendar(inputId) {
            console.log('showCustomCalendar called with inputId:', inputId);
            currentCalendarInput = document.getElementById(inputId);
            console.log('currentCalendarInput:', currentCalendarInput);
            const popup = document.getElementById('customCalendarPopup');
            console.log('popup:', popup);
            const inputRect = currentCalendarInput.getBoundingClientRect();
            
            // 获取当前输入框的值，如果有的话
            const currentValue = currentCalendarInput.value;
            if (currentValue) {
                selectedDate = new Date(currentValue);
                displayMonth = new Date(currentValue);
            } else {
                selectedDate = new Date();
                displayMonth = new Date();
            }
            
            // 初始化年份选项
            const yearSelect = document.getElementById('calendarYear');
            yearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '年';
                if (year === displayMonth.getFullYear()) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // 设置月份
            document.getElementById('calendarMonth').value = displayMonth.getMonth();
            
            // 显示遮罩层
            let overlay = document.getElementById('calendarOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'calendarOverlay';
                overlay.className = 'calendar-overlay';
                document.body.appendChild(overlay);
                overlay.onclick = closeCustomCalendar;
            }
            // 确保清除之前可能设置的 display 样式
            overlay.style.display = '';
            overlay.classList.add('show');
            
            // 居中显示弹窗
            popup.classList.add('show');
            console.log('Popup should now be visible');
            
            updateCalendar();
        }
        
        // 关闭自定义日历
        function closeCustomCalendar() {
            console.log('closeCustomCalendar called');
            const popup = document.getElementById('customCalendarPopup');
            const overlay = document.getElementById('calendarOverlay');
            
            console.log('popup:', popup);
            console.log('overlay:', overlay);
            
            if (popup) {
                popup.classList.remove('show');
                // 不设置 style.display = 'none'，让CSS控制显示
                console.log('Popup hidden');
            }
            if (overlay) {
                overlay.classList.remove('show');
                console.log('Overlay hidden');
            }
            currentCalendarInput = null;
            console.log('Calendar closed successfully');
        }
        
        // 更新日历显示
        function updateCalendar() {
            const month = parseInt(document.getElementById('calendarMonth').value);
            const year = parseInt(document.getElementById('calendarYear').value);
            displayMonth = new Date(year, month, 1);
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const daysContainer = document.getElementById('calendarDays');
            daysContainer.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // 添加上月的日期
            const firstDayOfWeek = firstDay.getDay();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevLastDay.getDate() - i;
                const dayDiv = createDayElement(day, true, new Date(year, month - 1, day));
                daysContainer.appendChild(dayDiv);
            }
            
            // 添加本月的日期
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(year, month, day);
                const dayDiv = createDayElement(day, false, currentDate);
                
                // 标记今天
                if (currentDate.getTime() === today.getTime()) {
                    dayDiv.classList.add('today');
                }
                
                // 标记选中的日期
                if (selectedDate && 
                    currentDate.getDate() === selectedDate.getDate() &&
                    currentDate.getMonth() === selectedDate.getMonth() &&
                    currentDate.getFullYear() === selectedDate.getFullYear()) {
                    dayDiv.classList.add('selected');
                }
                
                daysContainer.appendChild(dayDiv);
            }
            
            // 添加下月的日期
            const remainingDays = 42 - daysContainer.children.length;
            for (let day = 1; day <= remainingDays; day++) {
                const dayDiv = createDayElement(day, true, new Date(year, month + 1, day));
                daysContainer.appendChild(dayDiv);
            }
        }
        
        // 创建日期元素
        function createDayElement(day, isOtherMonth, date) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = day;
            dayDiv.setAttribute('data-date', date.toISOString());
            
            if (isOtherMonth) {
                dayDiv.classList.add('other-month');
            }
            
            // 添加点击事件处理
            dayDiv.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Day clicked:', day, date);
                console.log('currentCalendarInput:', currentCalendarInput);
                selectedDate = new Date(date);
                console.log('selectedDate set to:', selectedDate);
                
                try {
                    confirmDate();
                    console.log('confirmDate called successfully');
                } catch (error) {
                    console.error('Error in confirmDate:', error);
                }
            });
            
            // 触摸屏支持
            dayDiv.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                selectedDate = new Date(date);
                setTimeout(() => {
                    confirmDate();
                }, 100); // 延迟一点防止触摸事件冲突
            });
            
            return dayDiv;
        }
        
        // 切换月份
        function changeMonth(direction) {
            const month = parseInt(document.getElementById('calendarMonth').value);
            const year = parseInt(document.getElementById('calendarYear').value);
            
            let newMonth = month + direction;
            let newYear = year;
            
            if (newMonth < 0) {
                newMonth = 11;
                newYear--;
            } else if (newMonth > 11) {
                newMonth = 0;
                newYear++;
            }
            
            document.getElementById('calendarMonth').value = newMonth;
            document.getElementById('calendarYear').value = newYear;
            
            updateCalendar();
        }
        
        // 设置为今天
        function setToday() {
            selectedDate = new Date();
            displayMonth = new Date();
            document.getElementById('calendarMonth').value = displayMonth.getMonth();
            document.getElementById('calendarYear').value = displayMonth.getFullYear();
            confirmDate(); // 直接确定并关闭弹窗
        }
        
        // 确认选择
        function confirmDate() {
            console.log('confirmDate called');
            
            if (currentCalendarInput && selectedDate) {
                const year = selectedDate.getFullYear();
                const month = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
                const day = selectedDate.getDate().toString().padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;
                console.log('Setting date to:', dateString);
                currentCalendarInput.value = dateString;
                
                // 保存输入框ID，因为closeCustomCalendar会清空currentCalendarInput
                const inputId = currentCalendarInput.id;
                
                // 先关闭弹窗
                closeCustomCalendar();
                
                // 延迟更新图表，确保弹窗已关闭
                setTimeout(() => {
                    try {
                        if (inputId === 'historyEndDatePicker') {
                            console.log('Triggering updateHistoryChart');
                            updateHistoryChart();
                        } else if (inputId === 'revenueDatePicker') {
                            console.log('Triggering updateRevenueAnalysisChart');
                            updateRevenueAnalysisChart();
                        } else if (inputId.startsWith('pcs') && inputId.endsWith('DatePicker')) {
                            console.log('Triggering PCS chart update for:', inputId);
                            if (inputId === 'pcsEfficiencyDatePicker') {
                                updatePcsEfficiencyChart();
                            } else {
                                initPCSHistoryCharts();
                            }
                        } else if (inputId.startsWith('bms') && inputId.endsWith('DatePicker')) {
                            console.log('Triggering BMS chart update for:', inputId);
                            initBMSHistoryCharts();
                        } else if (inputId.startsWith('thermal') && inputId.endsWith('DatePicker')) {
                            console.log('Triggering Thermal chart update for:', inputId);
                            initThermalHistoryCharts();
                        } else if (inputId.startsWith('fire') && inputId.endsWith('DatePicker')) {
                            console.log('Triggering Fire chart update for:', inputId);
                            initFireHistoryCharts();
                        } else if (inputId.startsWith('meter') && inputId.endsWith('DatePicker')) {
                            console.log('Triggering Meter chart update for:', inputId, 'with date:', dateString);
                            if (inputId === 'meterPowerDatePicker') {
                                updateMeterPowerChart(dateString);
                            } else if (inputId === 'meterEnergyDatePicker') {
                                updateMeterEnergyChart(dateString);
                            } else if (inputId === 'meterVoltageDatePicker') {
                                updateMeterVoltageChart(dateString);
                            } else if (inputId === 'meterHarmonicDatePicker') {
                                updateMeterHarmonicChart(dateString);
                            }
                        }
                    } catch (error) {
                        console.error('Error updating chart:', error);
                    }
                }, 100);
            } else {
                console.log('Missing currentCalendarInput or selectedDate');
                closeCustomCalendar();
            }
        }
        
        // 点击外部关闭日历
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('customCalendarPopup');
            if (!popup || !popup.classList.contains('show')) {
                return; // 弹窗没有显示，直接返回
            }
            
            const isClickInside = popup.contains(e.target) || 
                                  e.target.classList.contains('calendar-icon') ||
                                  e.target.id === 'historyEndDatePicker' ||
                                  e.target.id === 'revenueDatePicker' ||
                                  e.target.id.startsWith('pcs') && e.target.id.endsWith('DatePicker') ||
                                  e.target.id.startsWith('bms') && e.target.id.endsWith('DatePicker') ||
                                  e.target.id.startsWith('thermal') && e.target.id.endsWith('DatePicker') ||
                                  e.target.id.startsWith('fire') && e.target.id.endsWith('DatePicker') ||
                                  e.target.closest('.custom-date-input');
            
            if (!isClickInside) {
                closeCustomCalendar();
            }
        });
        
        // ESC键关闭日历
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const popup = document.getElementById('customCalendarPopup');
                if (popup && popup.classList.contains('show')) {
                    closeCustomCalendar();
                }
            }
        });
        
        // 触摸屏支持
        document.addEventListener('touchend', function(e) {
            const popup = document.getElementById('customCalendarPopup');
            if (popup && popup.classList.contains('show')) {
                const isClickInside = popup.contains(e.target) || 
                                      e.target.classList.contains('calendar-icon') ||
                                      (currentCalendarInput && currentCalendarInput.contains(e.target));
                
                if (!isClickInside) {
                    closeCustomCalendar();
                }
            }
        });
    </script>

    <!-- 退出确认弹窗 -->
    <div id="logoutModal" class="logout-modal">
        <div class="logout-content">
            <div class="logout-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <div class="logout-title" id="logoutTitle">退出登录</div>
            <div class="logout-message" id="logoutMessage">您确定要退出当前账户吗？退出后需要重新登录。</div>
            <div class="logout-buttons">
                <button class="logout-btn-action cancel" id="logoutCancelBtn" onclick="closeLogoutModal()">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="logout-btn-action confirm" id="logoutConfirmBtn" onclick="confirmLogout()">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </button>
            </div>
        </div>
    </div>
    <script src="common-header-scripts.js"></script>
    <script>
        // 退出功能 - 直接定义在页面中确保可用
        if (typeof logout === 'undefined') {
            window.logout = function() {
                console.log('logout function called from inline script');
                const modal = document.getElementById('logoutModal');
                if (modal) {
                    modal.classList.add('show');
                    // 更新文本
                    const titleEl = document.getElementById('logoutTitle');
                    const messageEl = document.getElementById('logoutMessage');
                    if (titleEl) titleEl.textContent = '退出登录';
                    if (messageEl) messageEl.textContent = '您确定要退出当前账户吗？退出后需要重新登录。';
                } else {
                    console.error('logoutModal not found');
                }
            };
        }
        
        if (typeof closeLogoutModal === 'undefined') {
            window.closeLogoutModal = function() {
                const modal = document.getElementById('logoutModal');
                if (modal) {
                    modal.classList.remove('show');
                }
            };
        }
        
        if (typeof confirmLogout === 'undefined') {
            window.confirmLogout = function() {
                // 清除登录信息
                localStorage.removeItem('touchscreen_user');
                sessionStorage.removeItem('touchscreen_user');
                localStorage.removeItem('login_time');
                // 跳转到登录页
                window.location.href = 'login.html';
            };
        }
        
        // 确保页面加载完成后函数可用
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking functions:');
            console.log('logout:', typeof window.logout);
            console.log('closeLogoutModal:', typeof window.closeLogoutModal);
            console.log('confirmLogout:', typeof window.confirmLogout);
        });
    </script>
</body>
</html>