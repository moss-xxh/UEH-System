<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>调试设备详情功能</title>
    <link rel="stylesheet" href="css/enterprise-minimal.css">
    <style>
        body { padding: 20px; }
        #debug-output {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-btn { margin: 10px; }
    </style>
</head>
<body>
    <h2>设备详情功能调试</h2>
    
    <div>
        <button class="btn btn-primary test-btn" onclick="testFunction()">测试 showDeviceDetail 函数</button>
        <button class="btn btn-primary test-btn" onclick="testDirectCall()">直接调用函数</button>
        <button class="btn btn-primary test-btn" onclick="checkSystem()">检查 system 对象</button>
    </div>
    
    <div id="debug-output">点击按钮开始调试...</div>
    
    <script src="js/enterprise-enhanced.js"></script>
    <script>
        const output = document.getElementById('debug-output');
        
        function log(msg, isError = false) {
            const time = new Date().toLocaleTimeString();
            const prefix = isError ? '❌' : '✅';
            output.innerHTML += `\n${time} ${prefix} ${msg}`;
            if (isError) {
                console.error(msg);
            } else {
                console.log(msg);
            }
        }
        
        function checkSystem() {
            output.innerHTML = '=== 检查 system 对象 ===';
            
            try {
                // 检查 system 对象
                if (typeof system === 'undefined') {
                    log('system 对象未定义', true);
                    return;
                }
                log('system 对象存在');
                
                // 检查方法
                if (typeof system.showDeviceDetail === 'function') {
                    log('showDeviceDetail 方法存在');
                } else {
                    log('showDeviceDetail 方法不存在', true);
                    return;
                }
                
                // 检查 getDeviceDetailInfo 方法
                if (typeof system.getDeviceDetailInfo === 'function') {
                    log('getDeviceDetailInfo 方法存在');
                } else {
                    log('getDeviceDetailInfo 方法不存在', true);
                }
                
                // 列出所有方法
                const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(system))
                    .filter(name => typeof system[name] === 'function' && name !== 'constructor');
                log(`\nsystem 对象包含 ${methods.length} 个方法`);
                log('部分方法列表: ' + methods.slice(0, 10).join(', '));
                
            } catch (error) {
                log(`错误: ${error.message}`, true);
            }
        }
        
        function testFunction() {
            output.innerHTML = '=== 测试 showDeviceDetail 函数 ===';
            
            try {
                log('开始测试...');
                
                // 检查函数是否存在
                if (typeof system === 'undefined' || typeof system.showDeviceDetail !== 'function') {
                    log('函数不可用', true);
                    return;
                }
                
                log('准备调用 showDeviceDetail("DEV001")');
                
                // 添加错误捕获
                const originalMethod = system.showDeviceDetail;
                system.showDeviceDetail = function(deviceId) {
                    try {
                        log(`调用 showDeviceDetail 参数: ${deviceId}`);
                        return originalMethod.call(this, deviceId);
                    } catch (error) {
                        log(`函数内部错误: ${error.message}`, true);
                        log(`错误堆栈: ${error.stack}`, true);
                        throw error;
                    }
                };
                
                // 调用函数
                system.showDeviceDetail('DEV001');
                
                // 检查弹窗
                setTimeout(() => {
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        log('弹窗已创建');
                        log('弹窗内容长度: ' + modal.innerHTML.length + ' 字符');
                    } else {
                        log('弹窗未找到', true);
                    }
                }, 100);
                
            } catch (error) {
                log(`测试失败: ${error.message}`, true);
                log(`错误堆栈:\n${error.stack}`, true);
            }
        }
        
        function testDirectCall() {
            output.innerHTML = '=== 直接调用测试 ===';
            
            try {
                log('获取设备信息...');
                const deviceInfo = system.getDeviceDetailInfo('DEV001');
                log(`设备信息: ${JSON.stringify(deviceInfo, null, 2).substring(0, 200)}...`);
                
                log('创建弹窗...');
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-container">
                        <div class="modal-header">
                            <h3>测试弹窗</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                        </div>
                        <div class="modal-body">
                            <p>设备ID: ${deviceInfo.id}</p>
                            <p>型号: ${deviceInfo.model}</p>
                            <p>电站: ${deviceInfo.station}</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                log('弹窗已添加到页面');
                
            } catch (error) {
                log(`直接调用失败: ${error.message}`, true);
            }
        }
        
        // 页面加载后自动检查
        window.addEventListener('load', () => {
            checkSystem();
        });
    </script>
</body>
</html>