<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Admin - Tenants Management</title>
    <link rel="stylesheet" href="../shared/css/components.css">
    <link rel="stylesheet" href="../shared/css/common.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar Navigation -->
        <aside id="sidebar"></aside>
        
        <!-- Main Content -->
        <main class="admin-main">
            <!-- Header -->
            <header class="admin-header">
                <h1>Tenants Management</h1>
                <div class="header-actions">
                    <button class="btn-icon" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </button>
                    <div class="user-menu">
                        <img src="../shared/assets/avatar.png" alt="Admin" class="avatar">
                        <span>Admin</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="admin-content">
                <!-- Actions Bar -->
                <div class="actions-bar">
                    <div class="actions-left">
                        <button class="btn btn-primary" onclick="openAddTenantModal()">
                            <i class="fas fa-plus"></i> Add Tenant
                        </button>
                        <button class="btn btn-secondary" onclick="importTenants()">
                            <i class="fas fa-upload"></i> Import
                        </button>
                    </div>
                    <div class="actions-right">
                        <div id="tenantSearch"></div>
                        <button class="btn btn-secondary" onclick="exportTenants()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <!-- Filter Panel -->
                <div class="filter-panel">
                    <div class="filter-item">
                        <label>Status:</label>
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Plan:</label>
                        <select class="filter-select" id="planFilter">
                            <option value="all">All Plans</option>
                            <option value="starter">Starter</option>
                            <option value="professional">Professional</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Date Range:</label>
                        <div id="dateRangeFilter"></div>
                    </div>
                </div>

                <!-- Tenants Table -->
                <div class="data-grid">
                    <div id="tenantsTable"></div>
                </div>

                <!-- Pagination -->
                <div id="tenantsPagination"></div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../shared/components/components.js"></script>
    <script src="../shared/js/utils.js"></script>
    <script src="js/admin-common.js"></script>
    <script>
        let tenantsData = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            initializeSidebar('tenants');
            initializeSearch();
            initializeDateFilter();
            await loadTenants();
            initializeFilters();
        });

        // Initialize search
        function initializeSearch() {
            const search = new Components.Search({
                placeholder: 'Search tenants...',
                onSearch: (query) => {
                    filterTenants();
                }
            });
            search.render('tenantSearch');
        }

        // Initialize date filter
        function initializeDateFilter() {
            const dateFilter = new Components.DateTimePicker({
                type: 'daterange',
                onChange: (dates) => {
                    filterTenants();
                }
            });
            dateFilter.render('dateRangeFilter');
        }

        // Load tenants
        async function loadTenants() {
            Components.Loading.show({ text: 'Loading tenants...' });
            
            try {
                tenantsData = await adminAPI.getTenants();
                // Add more tenant data for demonstration
                for (let i = 6; i <= 50; i++) {
                    tenantsData.push({
                        id: i,
                        name: `Company ${i}`,
                        stations: Math.floor(Math.random() * 1000),
                        users: Math.floor(Math.random() * 50000),
                        status: ['active', 'suspended', 'inactive'][Math.floor(Math.random() * 3)],
                        plan: ['starter', 'professional', 'enterprise'][Math.floor(Math.random() * 3)],
                        created: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    });
                }
                renderTenants();
            } catch (error) {
                Components.Notification.error('Failed to load tenants', 'Error');
            } finally {
                Components.Loading.hide();
            }
        }

        // Render tenants table
        function renderTenants() {
            const start = (currentPage - 1) * itemsPerPage;
            const paginatedData = tenantsData.slice(start, start + itemsPerPage);

            const table = new Components.Table({
                columns: [
                    { 
                        field: 'name', 
                        label: 'Company Name',
                        render: (value, row) => `
                            <div>
                                <strong>${value}</strong>
                                <div class="text-muted" style="font-size: 12px;">ID: ${row.id}</div>
                            </div>
                        `
                    },
                    { 
                        field: 'plan', 
                        label: 'Plan',
                        render: (value) => `<span class="badge badge-info">${Utils.String.capitalize(value)}</span>`
                    },
                    { 
                        field: 'stations', 
                        label: 'Stations',
                        render: (value) => Utils.Number.format(value)
                    },
                    { 
                        field: 'users', 
                        label: 'Users',
                        render: (value) => Utils.Number.abbreviate(value)
                    },
                    { 
                        field: 'status', 
                        label: 'Status',
                        render: (value) => `
                            <div class="status-indicator">
                                <span class="status-dot ${value}"></span>
                                ${Utils.String.capitalize(value)}
                            </div>
                        `
                    },
                    { 
                        field: 'created', 
                        label: 'Created',
                        render: (value) => Utils.Date.format(value, 'MMM DD, YYYY')
                    },
                    {
                        field: 'actions',
                        label: 'Actions',
                        render: (value, row) => `
                            <div class="d-flex gap-1">
                                <button class="btn-icon" onclick="viewTenant(${row.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon" onclick="editTenant(${row.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" onclick="suspendTenant(${row.id})" title="Suspend">
                                    <i class="fas fa-pause"></i>
                                </button>
                            </div>
                        `
                    }
                ],
                data: paginatedData,
                selectable: true,
                onSelect: (selected) => {
                    console.log('Selected tenants:', selected);
                }
            });

            table.render('tenantsTable');

            // Render pagination
            const pagination = new Components.Pagination({
                totalItems: tenantsData.length,
                itemsPerPage: itemsPerPage,
                currentPage: currentPage,
                onPageChange: (page) => {
                    currentPage = page;
                    renderTenants();
                },
                showInfo: true,
                showJumper: true
            });

            pagination.render('tenantsPagination');
        }

        // Filter tenants
        function filterTenants() {
            const statusFilter = document.getElementById('statusFilter').value;
            const planFilter = document.getElementById('planFilter').value;
            
            let filtered = [...tenantsData];
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(t => t.status === statusFilter);
            }
            
            if (planFilter !== 'all') {
                filtered = filtered.filter(t => t.plan === planFilter);
            }
            
            tenantsData = filtered;
            currentPage = 1;
            renderTenants();
        }

        // Initialize filters
        function initializeFilters() {
            document.getElementById('statusFilter').addEventListener('change', filterTenants);
            document.getElementById('planFilter').addEventListener('change', filterTenants);
        }

        // Tenant actions
        function openAddTenantModal() {
            const modal = new Components.Modal({
                title: 'Add New Tenant',
                content: `
                    <form id="addTenantForm">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Plan</label>
                            <select class="form-control" name="plan">
                                <option value="starter">Starter</option>
                                <option value="professional">Professional</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Admin Name</label>
                            <input type="text" class="form-control" name="adminName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Admin Email</label>
                            <input type="email" class="form-control" name="adminEmail" required>
                        </div>
                    </form>
                `,
                size: 'medium',
                onConfirm: () => {
                    const form = document.getElementById('addTenantForm');
                    if (form.checkValidity()) {
                        Components.Notification.success('Tenant added successfully');
                        loadTenants();
                    }
                }
            });
            modal.open();
        }

        function viewTenant(id) {
            const tenant = tenantsData.find(t => t.id === id);
            const modal = new Components.Modal({
                title: `Tenant Details: ${tenant.name}`,
                content: `
                    <div class="tenant-details">
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>Status:</strong> ${tenant.status}
                            </div>
                            <div class="col-6">
                                <strong>Plan:</strong> ${tenant.plan}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>Stations:</strong> ${tenant.stations}
                            </div>
                            <div class="col-6">
                                <strong>Users:</strong> ${tenant.users}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>Created:</strong> ${tenant.created}
                            </div>
                        </div>
                    </div>
                `,
                size: 'medium',
                buttons: [
                    { text: 'Close', type: 'primary', action: 'close' }
                ]
            });
            modal.open();
        }

        function editTenant(id) {
            Components.Notification.info('Edit tenant functionality');
        }

        function suspendTenant(id) {
            showConfirmModal(
                'Suspend Tenant',
                'Are you sure you want to suspend this tenant?',
                () => {
                    Components.Notification.warning('Tenant suspended');
                    loadTenants();
                }
            );
        }

        function importTenants() {
            Components.Notification.info('Import functionality coming soon');
        }

        function exportTenants() {
            exportToCSV(tenantsData, 'tenants_export.csv');
            Components.Notification.success('Tenants exported successfully');
        }
    </script>
</body>
</html>