<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Admin - Audit Logs</title>
    <link rel="stylesheet" href="../shared/css/components.css">
    <link rel="stylesheet" href="../shared/css/common.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar Navigation -->
        <aside id="sidebar"></aside>
        
        <!-- Main Content -->
        <main class="admin-main">
            <!-- Header -->
            <header class="admin-header">
                <h1>Audit Logs</h1>
                <div class="header-actions">
                    <button class="btn-icon" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </button>
                    <div class="user-menu">
                        <img src="../shared/assets/avatar.png" alt="Admin" class="avatar">
                        <span>Admin</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="admin-content">
                <!-- Actions Bar -->
                <div class="actions-bar">
                    <div class="actions-left">
                        <div id="auditSearch"></div>
                        <button class="btn btn-secondary" onclick="refreshLogs()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="actions-right">
                        <button class="btn btn-secondary" onclick="exportLogs()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-secondary" onclick="openFilterModal()">
                            <i class="fas fa-filter"></i> Advanced Filter
                        </button>
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="filter-panel">
                    <div class="filter-item">
                        <label>Action Type:</label>
                        <select class="filter-select" id="actionFilter">
                            <option value="all">All Actions</option>
                            <option value="CREATE">Create</option>
                            <option value="UPDATE">Update</option>
                            <option value="DELETE">Delete</option>
                            <option value="LOGIN">Login</option>
                            <option value="LOGOUT">Logout</option>
                            <option value="SYSTEM">System</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Status:</label>
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All Status</option>
                            <option value="success">Success</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Date Range:</label>
                        <div id="dateRangeFilter"></div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #34c759, #30d158);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="successCount">0</h3>
                            <p>Successful Actions</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff9500, #ffb340);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="warningCount">0</h3>
                            <p>Warnings</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff3b30, #ff6961);">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="errorCount">0</h3>
                            <p>Errors</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #5ac8fa, #70d7ff);">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="totalCount">0</h3>
                            <p>Total Logs (3 Years)</p>
                        </div>
                    </div>
                </div>

                <!-- Audit Logs Table -->
                <div class="data-grid">
                    <div id="auditTable"></div>
                </div>

                <!-- Pagination -->
                <div id="auditPagination"></div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../shared/components/components.js"></script>
    <script src="../shared/js/utils.js"></script>
    <script src="js/admin-common.js"></script>
    <script>
        let auditLogs = [];
        let filteredLogs = [];
        let currentPage = 1;
        const itemsPerPage = 20;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            initializeSidebar('audit');
            initializeSearch();
            initializeDateFilter();
            await loadAuditLogs();
            initializeFilters();
            updateStats();
        });

        // Initialize search
        function initializeSearch() {
            const search = new Components.Search({
                placeholder: 'Search logs by user, action, or details...',
                onSearch: (query) => {
                    filterLogs();
                },
                debounceTime: 500
            });
            search.render('auditSearch');
        }

        // Initialize date filter
        function initializeDateFilter() {
            const dateFilter = new Components.DateTimePicker({
                type: 'daterange',
                onChange: (dates) => {
                    filterLogs();
                }
            });
            dateFilter.render('dateRangeFilter');
        }

        // Load audit logs
        async function loadAuditLogs() {
            Components.Loading.show({ text: 'Loading audit logs...' });
            
            try {
                // Simulate loading more audit logs
                auditLogs = [];
                const actions = ['CREATE_TENANT', 'UPDATE_TENANT', 'DELETE_TENANT', 'CREATE_USER', 
                               'UPDATE_USER', 'DELETE_USER', 'LOGIN', 'LOGOUT', 'UPDATE_SETTINGS',
                               'BACKUP', 'RESTORE', 'EXPORT_DATA', 'IMPORT_DATA', 'SYSTEM_UPDATE'];
                const statuses = ['success', 'warning', 'error'];
                const users = ['admin@platform.com', 'system', 'monitor@system.com', 'support@platform.com'];
                
                // Generate 3 years of audit logs
                for (let i = 0; i < 10000; i++) {
                    const date = new Date(Date.now() - Math.random() * 3 * 365 * 24 * 60 * 60 * 1000);
                    auditLogs.push({
                        id: i + 1,
                        timestamp: date.toISOString(),
                        user: users[Math.floor(Math.random() * users.length)],
                        action: actions[Math.floor(Math.random() * actions.length)],
                        details: `Action details for log entry ${i + 1}`,
                        ip: `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`,
                        status: statuses[Math.floor(Math.random() * statuses.length)],
                        duration: Math.floor(Math.random() * 5000) + 'ms'
                    });
                }
                
                // Sort by timestamp descending
                auditLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                filteredLogs = [...auditLogs];
                renderAuditLogs();
            } catch (error) {
                Components.Notification.error('Failed to load audit logs', 'Error');
            } finally {
                Components.Loading.hide();
            }
        }

        // Render audit logs table
        function renderAuditLogs() {
            const start = (currentPage - 1) * itemsPerPage;
            const paginatedData = filteredLogs.slice(start, start + itemsPerPage);

            const table = new Components.Table({
                columns: [
                    { 
                        field: 'timestamp', 
                        label: 'Timestamp',
                        render: (value) => `
                            <div>
                                <div>${Utils.Date.format(value, 'MMM DD, YYYY')}</div>
                                <div class="text-muted" style="font-size: 12px;">${Utils.Date.format(value, 'HH:mm:ss')}</div>
                            </div>
                        `
                    },
                    { 
                        field: 'user', 
                        label: 'User',
                        render: (value) => `<strong>${value}</strong>`
                    },
                    { 
                        field: 'action', 
                        label: 'Action',
                        render: (value) => `<code>${value}</code>`
                    },
                    { 
                        field: 'details', 
                        label: 'Details',
                        render: (value) => Utils.String.truncate(value, 50)
                    },
                    { 
                        field: 'ip', 
                        label: 'IP Address',
                        render: (value) => `<span class="text-muted">${value}</span>`
                    },
                    { 
                        field: 'duration', 
                        label: 'Duration'
                    },
                    { 
                        field: 'status', 
                        label: 'Status',
                        render: (value) => {
                            const badgeClass = value === 'success' ? 'badge-success' : 
                                              value === 'warning' ? 'badge-warning' : 'badge-danger';
                            return `<span class="badge ${badgeClass}">${value}</span>`;
                        }
                    },
                    {
                        field: 'actions',
                        label: 'Actions',
                        render: (value, row) => `
                            <button class="btn-icon" onclick="viewLogDetails(${row.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        `
                    }
                ],
                data: paginatedData,
                striped: true,
                hoverable: true
            });

            table.render('auditTable');

            // Render pagination
            const pagination = new Components.Pagination({
                totalItems: filteredLogs.length,
                itemsPerPage: itemsPerPage,
                currentPage: currentPage,
                onPageChange: (page) => {
                    currentPage = page;
                    renderAuditLogs();
                },
                showInfo: true,
                showJumper: true
            });

            pagination.render('auditPagination');
        }

        // Filter logs
        function filterLogs() {
            const actionFilter = document.getElementById('actionFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchInput = document.querySelector('.search-input').value.toLowerCase();
            
            filteredLogs = auditLogs.filter(log => {
                let match = true;
                
                if (actionFilter !== 'all' && !log.action.includes(actionFilter)) {
                    match = false;
                }
                
                if (statusFilter !== 'all' && log.status !== statusFilter) {
                    match = false;
                }
                
                if (searchInput && !Object.values(log).some(val => 
                    String(val).toLowerCase().includes(searchInput))) {
                    match = false;
                }
                
                return match;
            });
            
            currentPage = 1;
            renderAuditLogs();
            updateStats();
        }

        // Initialize filters
        function initializeFilters() {
            document.getElementById('actionFilter').addEventListener('change', filterLogs);
            document.getElementById('statusFilter').addEventListener('change', filterLogs);
        }

        // Update statistics
        function updateStats() {
            const stats = {
                success: filteredLogs.filter(l => l.status === 'success').length,
                warning: filteredLogs.filter(l => l.status === 'warning').length,
                error: filteredLogs.filter(l => l.status === 'error').length,
                total: auditLogs.length
            };
            
            document.getElementById('successCount').textContent = Utils.Number.format(stats.success);
            document.getElementById('warningCount').textContent = Utils.Number.format(stats.warning);
            document.getElementById('errorCount').textContent = Utils.Number.format(stats.error);
            document.getElementById('totalCount').textContent = Utils.Number.format(stats.total);
        }

        // View log details
        function viewLogDetails(id) {
            const log = auditLogs.find(l => l.id === id);
            const modal = new Components.Modal({
                title: 'Audit Log Details',
                content: `
                    <div class="log-details">
                        <div class="form-group">
                            <label class="form-label">Timestamp</label>
                            <div>${Utils.Date.format(log.timestamp, 'YYYY-MM-DD HH:mm:ss')}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">User</label>
                            <div>${log.user}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Action</label>
                            <div><code>${log.action}</code></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Details</label>
                            <div>${log.details}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">IP Address</label>
                            <div>${log.ip}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration</label>
                            <div>${log.duration}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <div><span class="badge badge-${log.status}">${log.status}</span></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Additional Data</label>
                            <pre style="background: #f5f5f7; padding: 10px; border-radius: 6px;">
{
  "browser": "Chrome 120.0",
  "os": "macOS 14.0",
  "device": "Desktop",
  "location": "San Francisco, CA"
}</pre>
                        </div>
                    </div>
                `,
                size: 'medium',
                buttons: [
                    { text: 'Close', type: 'primary', action: 'close' }
                ]
            });
            modal.open();
        }

        // Advanced filter modal
        function openFilterModal() {
            const modal = new Components.Modal({
                title: 'Advanced Filter',
                content: `
                    <form id="advancedFilterForm">
                        <div class="form-group">
                            <label class="form-label">User</label>
                            <input type="text" class="form-control" name="user" placeholder="Enter user email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">IP Address</label>
                            <input type="text" class="form-control" name="ip" placeholder="Enter IP address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Min Duration (ms)</label>
                            <input type="number" class="form-control" name="minDuration" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Duration (ms)</label>
                            <input type="number" class="form-control" name="maxDuration" placeholder="10000">
                        </div>
                    </form>
                `,
                size: 'medium',
                onConfirm: () => {
                    // Apply advanced filters
                    filterLogs();
                    Components.Notification.success('Advanced filters applied');
                }
            });
            modal.open();
        }

        // Refresh logs
        function refreshLogs() {
            loadAuditLogs();
            Components.Notification.success('Audit logs refreshed');
        }

        // Export logs
        function exportLogs() {
            const exportData = filteredLogs.map(log => ({
                Timestamp: Utils.Date.format(log.timestamp),
                User: log.user,
                Action: log.action,
                Details: log.details,
                IP: log.ip,
                Duration: log.duration,
                Status: log.status
            }));
            
            exportToCSV(exportData, `audit_logs_${Utils.Date.format(new Date(), 'YYYY-MM-DD')}.csv`);
            Components.Notification.success('Audit logs exported successfully');
        }
    </script>
</body>
</html>